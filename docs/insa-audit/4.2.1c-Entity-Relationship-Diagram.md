# i-Ticket Platform - Entity Relationship Diagram (ERD)

**Document**: 4.2.1c - Entity Relationship Diagram
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Database Overview

| Property | Value |
|----------|-------|
| **Database Engine** | PostgreSQL 16.11 |
| **ORM** | Prisma 5.10.x |
| **Total Models** | 39 |
| **ID Strategy** | CUID (collision-resistant unique identifiers) |
| **Timestamps** | `createdAt` / `updatedAt` on all models |

---

## 2. Entity Definitions

> Fields marked with **[SENSITIVE]** require encryption or access control per INSA requirements.
> Fields marked with **[PK]** are primary keys, **[FK]** are foreign keys, **[UQ]** are unique constraints.

### 2.1 Core Business Entities

#### User
*All system users: customers, company admins, staff, guest users*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| name | String? | Nullable (guest users) | PII |
| phone | String | **[UQ]** Unique | **[SENSITIVE]** PII, auth identifier |
| email | String? | | **[SENSITIVE]** PII |
| password | String? | Nullable (guest users) | **[SENSITIVE]** bcrypt hash (12 rounds) |
| nationalId | String? | | **[SENSITIVE]** Government ID |
| role | String | Default: "CUSTOMER" | Access control |
| companyId | String? | **[FK]** -> Company.id | Data segregation |
| staffRole | String? | ADMIN/DRIVER/CONDUCTOR/MANUAL_TICKETER/MECHANIC/FINANCE | Access control |
| staffStatus | String? | Default: "AVAILABLE" | |
| licenseNumber | String? | | PII |
| employeeId | String? | | |
| nextOfKinName | String? | | **[SENSITIVE]** PII |
| nextOfKinPhone | String? | | **[SENSITIVE]** PII |
| profilePicture | String? | URL/path | |
| isGuestUser | Boolean | Default: false | |
| mustChangePassword | Boolean | Default: false | Auth control |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

**Indexes**: `[role]`, `[companyId]`, `[isGuestUser, createdAt]`, `[companyId, staffRole]`, `[phone, isGuestUser]`, `[mustChangePassword]`

---

#### Company
*Bus companies with complete data isolation*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| name | String | | |
| logo | String? | URL/path | |
| phones | String | Default: "[]" (JSON) | PII |
| email | String | | **[SENSITIVE]** PII |
| isActive | Boolean | Default: true | |
| disableAutoHaltGlobally | Boolean | Default: false | |
| fax | String? | | |
| website | String? | | |
| address | String? | | |
| poBox | String? | | |
| tinNumber | String? | | **[SENSITIVE]** Tax ID |
| bankName | String? | | **[SENSITIVE]** Financial |
| bankAccount | String? | | **[SENSITIVE]** Financial |
| bankBranch | String? | | **[SENSITIVE]** Financial |
| adminName | String? | | PII |
| adminPhone | String? | | **[SENSITIVE]** PII |
| adminEmail | String? | | **[SENSITIVE]** PII |
| supportName | String? | | PII |
| supportPhone | String? | | PII |
| preparedBy | String? | | |
| reviewedBy | String? | | |
| approvedBy | String? | | |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

---

#### Trip
*Bus trips with full lifecycle management*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| companyId | String | **[FK]** -> Company.id | Data segregation |
| driverId | String? | **[FK]** -> User.id | |
| conductorId | String? | **[FK]** -> User.id | |
| manualTicketerId | String? | **[FK]** -> User.id | |
| vehicleId | String? | **[FK]** -> Vehicle.id | |
| origin | String | | |
| destination | String | | |
| route | String? | | |
| intermediateStops | String? | JSON | |
| defaultPickup | String? | | |
| defaultDropoff | String? | | |
| departureTime | DateTime | | |
| estimatedDuration | Int | Minutes | |
| actualDepartureTime | DateTime? | | |
| actualArrivalTime | DateTime? | | |
| distance | Int? | Kilometers | |
| price | Float | | Financial |
| busType | String | | |
| totalSlots | Int | | |
| availableSlots | Int | | |
| hasWater | Boolean | Default: false | |
| hasFood | Boolean | Default: false | |
| isActive | Boolean | Default: true | |
| status | String | Default: "SCHEDULED" | |
| delayReason | String? | | |
| delayedAt | DateTime? | | |
| lowSlotAlertSent | Boolean | Default: false | |
| bookingHalted | Boolean | Default: false | |
| adminResumedFromAutoHalt | Boolean | Default: false | |
| autoResumeEnabled | Boolean | Default: false | |
| reportGenerated | Boolean | Default: false | |
| version | Int | Default: 0 (optimistic lock) | |
| noShowCount | Int | Default: 0 | |
| releasedSeats | Int | Default: 0 | |
| replacementsSold | Int | Default: 0 | |
| trackingActive | Boolean | Default: false | |
| trackingToken | String? | **[UQ]** Unique | **[SENSITIVE]** Auth token |
| lastLatitude | Float? | | Location data |
| lastLongitude | Float? | | Location data |
| lastSpeed | Float? | | |
| lastPositionAt | DateTime? | | |
| estimatedArrival | DateTime? | | |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

**Indexes**: `[origin, destination, departureTime]`, `[departureTime]`, `[companyId]`, `[driverId]`, `[conductorId]`, `[manualTicketerId]`, `[vehicleId]`, `[status]`, `[companyId, status]`, `[companyId, status, departureTime]`, `[trackingActive, status]`, `[version]`

---

#### Booking
*Customer booking records*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| tripId | String | **[FK]** -> Trip.id | |
| userId | String | **[FK]** -> User.id | |
| totalAmount | Float | | **[SENSITIVE]** Financial |
| commission | Float | 5% of totalAmount | **[SENSITIVE]** Financial |
| commissionVAT | Float | Default: 0 (15% of commission) | **[SENSITIVE]** Financial |
| status | String | Default: "PENDING" | |
| isQuickTicket | Boolean | Default: false | |
| isReplacement | Boolean | Default: false | |
| replacedPassengerId | String? | Audit trail link | |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

**Indexes**: `[userId, status]`, `[tripId]`, `[createdAt]`, `[status, createdAt]`, `[tripId, status]`

---

#### Passenger
*Individual passengers per booking*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| bookingId | String | **[FK]** -> Booking.id (CASCADE) | |
| name | String | | **[SENSITIVE]** PII |
| nationalId | String | | **[SENSITIVE]** Government ID |
| phone | String | | **[SENSITIVE]** PII |
| seatNumber | Int? | | |
| specialNeeds | String? | | **[SENSITIVE]** Health data |
| pickupLocation | String? | | |
| dropoffLocation | String? | | |
| boardingStatus | String | Default: "PENDING" | |

**Indexes**: `[bookingId]`, `[bookingId, boardingStatus]`

---

#### Ticket
*Generated tickets with QR codes and verification codes*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| bookingId | String | **[FK]** -> Booking.id (CASCADE) | |
| tripId | String | **[FK]** -> Trip.id | |
| passengerName | String | | PII |
| seatNumber | Int? | | |
| qrCode | String | Data URL (base64 PNG) | **[SENSITIVE]** Auth artifact |
| shortCode | String | **[UQ]** Unique (6-char) | **[SENSITIVE]** Auth token |
| isUsed | Boolean | Default: false | |
| usedAt | DateTime? | | |
| createdAt | DateTime | Auto | |

**Indexes**: `[tripId]`, `[shortCode]`, `[shortCode, isUsed]`

---

#### Payment
*Payment transaction records*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| bookingId | String | **[UQ] [FK]** -> Booking.id (CASCADE) | |
| amount | Float | | **[SENSITIVE]** Financial |
| method | String | TELEBIRR / DEMO | |
| transactionId | String? | | **[SENSITIVE]** Financial reference |
| status | String | Default: "PENDING" | |
| initiatedVia | String | Default: "WEB" (WEB/SMS) | |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

**Indexes**: `[status]`, `[initiatedVia, status]`, `[createdAt]`

---

#### City
*Shared city reference data (only shared resource across companies)*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| name | String | **[UQ]** Unique | |
| region | String? | | |
| isActive | Boolean | Default: true | |
| tripCount | Int | Default: 0 | |
| latitude | Float? | | |
| longitude | Float? | | |
| timezone | String? | | |
| createdAt | DateTime | Auto | |

**Indexes**: `[name]`, `[latitude, longitude]`

---

### 2.2 Security & Audit Entities

#### AdminLog
*Comprehensive audit trail for all sensitive operations*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| userId | String | | Audit |
| action | String | | **[SENSITIVE]** Audit trail |
| details | String? | | **[SENSITIVE]** May contain PII |
| tripId | String? | | |
| companyId | String? | | |
| createdAt | DateTime | Auto | |

**Indexes**: `[userId, createdAt]`, `[action]`, `[createdAt]`, `[companyId, createdAt]`

---

#### ProcessedCallback
*Payment callback idempotency and replay prevention*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| transactionId | String | **[UQ]** Unique | **[SENSITIVE]** Financial |
| bookingId | String | | |
| callbackHash | String | **[UQ]** Unique (SHA-256) | **[SENSITIVE]** Security |
| nonce | String? | | Security |
| status | String | | |
| processedAt | DateTime | Auto | |
| amount | Float | | **[SENSITIVE]** Financial |
| signature | String | | **[SENSITIVE]** HMAC signature |
| rawPayload | Text | | **[SENSITIVE]** Full callback data |

**Indexes**: `[transactionId]`, `[bookingId]`, `[callbackHash]`, `[processedAt]`

---

#### PasswordReset
*Password reset token management*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| userId | String | **[FK]** -> User.id (CASCADE) | |
| tokenHash | String | **[UQ]** Unique | **[SENSITIVE]** bcrypt-hashed auth token |
| expiresAt | DateTime | 1-hour TTL | |
| isUsed | Boolean | Default: false | |
| usedAt | DateTime? | | |
| createdAt | DateTime | Auto | |

**Indexes**: `[userId, isUsed]`, `[tokenHash, isUsed]`, `[expiresAt]`

---

### 2.3 Fleet Management Entities

#### Vehicle

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| companyId | String | **[FK]** -> Company.id (CASCADE) | Data segregation |
| plateNumber | String | **[UQ]** per company | |
| sideNumber | String? | **[UQ]** per company | |
| make | String | | |
| model | String | | |
| year | Int | | |
| busType | String | MINI/STANDARD/LUXURY | |
| color | String? | | |
| totalSeats | Int | | |
| status | String | Default: "ACTIVE" | |
| registrationExpiry | DateTime? | | |
| insuranceExpiry | DateTime? | | |
| lastServiceDate | DateTime? | | |
| nextServiceDate | DateTime? | | |
| currentOdometer | Int? | | |
| engineHours | Int? | | |
| fuelCapacity | Int? | | |
| fuelType | String? | | |
| utilizationRate | Float? | | |
| costPerKm | Float? | | Financial |
| revenuePerKm | Float? | | Financial |
| fuelCostMTD | Float | Default: 0 | Financial |
| fuelCostYTD | Float | Default: 0 | Financial |
| maintenanceCostMTD | Float | Default: 0 | Financial |
| maintenanceCostYTD | Float | Default: 0 | Financial |
| maintenanceRiskScore | Int? | 0-100 (AI) | |
| predictedFailureDate | DateTime? | AI prediction | |
| predictedFailureType | String? | | |
| purchasePrice | Float? | | **[SENSITIVE]** Financial |
| purchaseDate | DateTime? | | |
| lastLatitude | Float? | | Location data |
| lastLongitude | Float? | | Location data |
| lastPositionAt | DateTime? | | |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

**Unique Constraints**: `[companyId, plateNumber]`, `[companyId, sideNumber]`
**Indexes**: `[companyId]`, `[status]`, `[plateNumber]`, `[sideNumber]`, `[maintenanceRiskScore]`, `[inspectionDueDate]`, `[predictedFailureDate]`, `[currentOdometer]`

---

#### WorkOrder

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| workOrderNumber | String | **[UQ]** WO-XXXXXX | |
| vehicleId | String | **[FK]** -> Vehicle.id | |
| companyId | String | | Data segregation |
| title | String | | |
| description | Text? | | |
| taskType | String | PREVENTIVE/CORRECTIVE/INSPECTION/EMERGENCY | |
| priority | Int | Default: 2 | |
| assignedStaffIds | Text? | JSON array of user IDs | |
| serviceProvider | String? | External shop | |
| status | String | Default: "OPEN" | |
| scheduledDate | DateTime? | | |
| startedAt | DateTime? | | |
| completedAt | DateTime? | | |
| odometerAtService | Int? | | |
| laborCost | Float | Default: 0 | **[SENSITIVE]** Financial |
| partsCost | Float | Default: 0 | **[SENSITIVE]** Financial |
| totalCost | Float | Default: 0 | **[SENSITIVE]** Financial |
| completionNotes | Text? | | |
| mechanicSignature | String? | | PII |
| fixedOnTheJob | Boolean | Default: false | |
| fixedByStaffName | String? | | PII |
| externalGarageName | String? | | |
| externalGarageCost | Float? | | Financial |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

**Indexes**: `[vehicleId, status]`, `[workOrderNumber]`, `[scheduledDate]`, `[companyId]`, `[status, priority]`, `[fixedOnTheJob]`

---

#### VehicleInspection, MaintenanceSchedule, FuelEntry, OdometerLog, TripLog, WorkOrderPart, VehicleRiskHistory, VehicleDowntime

*(Detailed field definitions available in Prisma schema - these support fleet management with company segregation via vehicleId/companyId foreign keys. Financial fields in FuelEntry (costBirr, costPerLiter) and WorkOrderPart (unitPrice, totalPrice) are SENSITIVE.)*

---

### 2.4 GPS Tracking Entity

#### TripPosition
*GPS breadcrumbs from driver phones*

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| tripId | String | **[FK]** -> Trip.id (CASCADE) | |
| vehicleId | String? | | |
| latitude | Float | | **[SENSITIVE]** Location tracking |
| longitude | Float | | **[SENSITIVE]** Location tracking |
| altitude | Float? | | |
| accuracy | Float? | GPS accuracy (meters) | |
| heading | Float? | 0-360 degrees | |
| speed | Float? | km/h | |
| recordedAt | DateTime | Device timestamp | |
| receivedAt | DateTime | Server timestamp | |

**Indexes**: `[tripId, receivedAt]`, `[vehicleId, receivedAt]`
**Retention**: Auto-purged after 7 days for COMPLETED/CANCELLED trips

---

### 2.5 Session Entities

#### TelegramSession

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| chatId | BigInt | **[UQ]** Unique | **[SENSITIVE]** Telegram user ID |
| userId | String? | **[FK]** -> User.id | |
| sessionId | String | **[UQ]** Unique | |
| state | String | Default: "IDLE" | |
| language | String | Default: "EN" | |
| origin | String? | | |
| destination | String? | | |
| date | DateTime? | | |
| selectedTripId | String? | | |
| passengerCount | Int | Default: 0 | |
| passengerData | String? | JSON | **[SENSITIVE]** PII in JSON |
| selectedSeats | String? | JSON | |
| bookingId | String? | | |
| paymentTransactionId | String? | | **[SENSITIVE]** Financial |
| expiresAt | DateTime | 30-min TTL | |
| createdAt | DateTime | Auto | |
| updatedAt | DateTime | Auto | |

#### SmsSession

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| phone | String | | **[SENSITIVE]** PII |
| sessionId | String | **[UQ]** Unique | |
| state | String | | |
| language | String | Default: "EN" | |
| passengerData | String? | JSON | **[SENSITIVE]** PII in JSON |
| expiresAt | DateTime | 15-min TTL | |

---

### 2.6 Sales & Financial Entities

#### SalesPerson

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| name | String | | **[SENSITIVE]** PII |
| phone | String | **[UQ]** Unique | **[SENSITIVE]** PII |
| email | String? | | **[SENSITIVE]** PII |
| password | String | | **[SENSITIVE]** bcrypt hash |
| referralCode | String | **[UQ]** Unique | |
| status | String | Default: "ACTIVE" | |
| recruiterId | String? | **[FK]** -> SalesPerson.id (self-ref) | |
| tier | Int | Default: 1 | |
| bankAccountName | String? | | **[SENSITIVE]** Financial PII |
| bankAccountNumber | String? | | **[SENSITIVE]** Financial |
| bankName | String? | | **[SENSITIVE]** Financial |
| alternativePhone | String? | | **[SENSITIVE]** PII |
| profilePicture | String? | | |
| lastLoginAt | DateTime? | | |

#### SalesCommission

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| salesPersonId | String | **[FK]** -> SalesPerson.id (CASCADE) | |
| bookingId | String | **[UQ] [FK]** -> Booking.id (CASCADE) | |
| ticketAmount | Float | | **[SENSITIVE]** Financial |
| platformCommission | Float | | **[SENSITIVE]** Financial |
| salesCommission | Float | | **[SENSITIVE]** Financial |
| recruiterCommissionAmount | Float | Default: 0 | **[SENSITIVE]** Financial |
| recruiterId | String? | **[FK]** -> SalesPerson.id | |
| status | String | Default: "PENDING" | |
| payoutId | String? | **[FK]** -> SalesPayout.id | |
| paidAt | DateTime? | | |

---

### 2.7 Communication Entities

#### SupportTicket

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| ticketNumber | String | **[UQ]** SUP-XXXXXX | |
| name | String | | **[SENSITIVE]** PII |
| email | String | | **[SENSITIVE]** PII |
| phone | String? | | **[SENSITIVE]** PII |
| subject | String | | |
| message | Text | | May contain PII |
| category | String | Default: "GENERAL" | |
| priority | Int | Default: 2 | |
| status | String | Default: "OPEN" | |
| resolution | Text? | | |
| userAgent | String? | | **[SENSITIVE]** Device fingerprint |
| ipAddress | String? | | **[SENSITIVE]** Network identifier |

#### PlatformStaff

| Field | Type | Constraints | Sensitivity |
|-------|------|-------------|-------------|
| id | String | **[PK]** CUID | |
| userId | String | **[UQ] [FK]** -> User.id (CASCADE) | |
| role | String | | Access control |
| department | String | | |
| employeeId | String | **[UQ]** iTKT-XXX | **[SENSITIVE]** HR data |
| email | String | **[UQ]** | **[SENSITIVE]** PII |
| phone | String | | **[SENSITIVE]** PII |
| position | String | | HR data |
| hireDate | DateTime | | HR data |
| status | String | Default: "ACTIVE" | |
| reportsTo | String? | Manager userId | |
| permissions | Text | Default: "{}" (JSON) | **[SENSITIVE]** Access control |

---

## 3. Relationship Diagram

### 3.1 Core Business Relationships

```
+----------+       1:N        +----------+       1:N        +-----------+
| Company  |<--------------->| User     |<--------------->| Booking   |
| [PK] id  |  companyId(FK)  | [PK] id  |  userId(FK)     | [PK] id   |
+----------+                  +----------+                  +-----------+
     |                             |                             |
     | 1:N                         | 1:N (driver)               | 1:N
     |                             | 1:N (conductor)            |
     v                             | 1:N (ticketer)             v
+----------+                       v                       +-----------+
| Trip     |<-------- staffIds(FK) +                       | Passenger |
| [PK] id  |                                               | [PK] id   |
| companyId|<----- vehicleId(FK) ----+                     +-----------+
+----------+                         |                          |
     |                          +----------+                    |
     | 1:N                      | Vehicle  |              (bookingId FK)
     |                          | [PK] id  |
     v                          | companyId|
+-----------+                   +----------+
| Ticket    |
| [PK] id   |
| shortCode |<--[UQ]
+-----------+
     |
(bookingId FK)
(tripId FK)
```

### 3.2 Complete Relationship Table

| Parent Entity | Child Entity | Relationship | Foreign Key | On Delete |
|--------------|-------------|-------------|-------------|-----------|
| **Company** | User | 1:N | User.companyId | - |
| **Company** | Trip | 1:N | Trip.companyId | - |
| **Company** | Vehicle | 1:N | Vehicle.companyId | CASCADE |
| **Company** | TripTemplate | 1:N | TripTemplate.companyId | CASCADE |
| **Company** | CompanyMessage | 1:N | CompanyMessage.companyId | CASCADE |
| **User** | Booking | 1:N | Booking.userId | - |
| **User** | Trip (driver) | 1:N | Trip.driverId | SET NULL |
| **User** | Trip (conductor) | 1:N | Trip.conductorId | SET NULL |
| **User** | Trip (ticketer) | 1:N | Trip.manualTicketerId | SET NULL |
| **User** | PasswordReset | 1:N | PasswordReset.userId | CASCADE |
| **User** | CompanyMessage | 1:N | CompanyMessage.senderId | CASCADE |
| **User** | PlatformStaff | 1:1 | PlatformStaff.userId | CASCADE |
| **User** | TelegramSession | 1:N | TelegramSession.userId | SET NULL |
| **User** | SalesReferral | 1:1 | SalesReferral.userId | CASCADE |
| **Trip** | Booking | 1:N | Booking.tripId | - |
| **Trip** | Ticket | 1:N | Ticket.tripId | - |
| **Trip** | TripLog | 1:1 | TripLog.tripId | CASCADE |
| **Trip** | TripPosition | 1:N | TripPosition.tripId | CASCADE |
| **Trip** | ManifestDownload | 1:N | ManifestDownload.tripId | CASCADE |
| **Vehicle** | Trip | 1:N | Trip.vehicleId | SET NULL |
| **Vehicle** | MaintenanceSchedule | 1:N | MaintenanceSchedule.vehicleId | CASCADE |
| **Vehicle** | WorkOrder | 1:N | WorkOrder.vehicleId | - |
| **Vehicle** | FuelEntry | 1:N | FuelEntry.vehicleId | - |
| **Vehicle** | VehicleInspection | 1:N | VehicleInspection.vehicleId | - |
| **Vehicle** | OdometerLog | 1:N | OdometerLog.vehicleId | CASCADE |
| **Vehicle** | TripLog | 1:N | TripLog.vehicleId | - |
| **Vehicle** | VehicleRiskHistory | 1:N | VehicleRiskHistory.vehicleId | CASCADE |
| **Vehicle** | VehicleDowntime | 1:N | VehicleDowntime.vehicleId | CASCADE |
| **Booking** | Passenger | 1:N | Passenger.bookingId | CASCADE |
| **Booking** | Ticket | 1:N | Ticket.bookingId | CASCADE |
| **Booking** | Payment | 1:1 | Payment.bookingId | CASCADE |
| **Booking** | SalesCommission | 1:1 | SalesCommission.bookingId | CASCADE |
| **WorkOrder** | WorkOrderPart | 1:N | WorkOrderPart.workOrderId | CASCADE |
| **WorkOrder** | WorkOrderMessage | 1:N | WorkOrderMessage.workOrderId | CASCADE |
| **TripMessage** | TripMessageReadReceipt | 1:N | ReadReceipt.messageId | CASCADE |
| **WorkOrderMessage** | WorkOrderMessageReadReceipt | 1:N | ReadReceipt.messageId | CASCADE |
| **Notification** | Notification (children) | 1:N (self-ref) | Notification.parentId | CASCADE |
| **SalesPerson** | SalesPerson (recruits) | 1:N (self-ref) | SalesPerson.recruiterId | SET NULL |
| **SalesPerson** | SalesReferral | 1:N | SalesReferral.salesPersonId | CASCADE |
| **SalesPerson** | SalesCommission | 1:N | SalesCommission.salesPersonId | CASCADE |
| **SalesPerson** | SalesCommission (recruiter) | 1:N | SalesCommission.recruiterId | SET NULL |
| **SalesPerson** | SalesQrScan | 1:N | SalesQrScan.salesPersonId | CASCADE |
| **SalesPerson** | SalesPayout | 1:N | SalesPayout.salesPersonId | CASCADE |
| **SalesPayout** | SalesCommission | 1:N | SalesCommission.payoutId | - |

### 3.3 Full ERD Diagram

```
                                    +==================+
                                    |      City        |
                                    |==================|
                                    | [PK] id          |
                                    | [UQ] name        |
                                    | region           |
                                    | latitude         |
                                    | longitude        |
                                    +==================+
                                    (shared across all
                                     companies - only
                                     shared resource)


+=================+         +==================+         +=================+
|   PlatformStaff |         |      Company     |         |  TripTemplate   |
|=================|         |==================|         |=================|
| [PK] id         |         | [PK] id          |         | [PK] id         |
| [FK][UQ] userId-+------+  | name             |    +----+-[FK] companyId  |
| [UQ] employeeId |      |  | [S] tinNumber    |    |    | name            |
| [UQ] email      |      |  | [S] bankAccount  |    |    | origin          |
| [S] permissions |      |  | [S] bankName     |    |    | destination     |
+=================+      |  | [S] email        |    |    | price           |
                         |  +========+=========+    |    +=================+
                         |           |              |
                         |     +-----+------+       |
                         |     | 1:N        | 1:N   |
                         |     v            v       |
                    +====+============+    +========+=========+
                    |     User        |    |      Vehicle     |
                    |=================|    |==================|
                    | [PK] id         |    | [PK] id          |
                    | [UQ][S] phone   |    | [FK] companyId   |
                    | [S] password    |    | [UQ] plateNumber |
                    | [S] nationalId  |    | [S] purchasePrice|
                    | [S] email       |    | riskScore        |
                    | role            |    | lastLatitude     |
                    | [FK] companyId  |    | lastLongitude    |
                    +=====+===========+    +=======+==========+
                          |                        |
           +--------------+----------+             |
           |              |          |             |
           | 1:N          | 1:N      | 1:1        | 1:N
           | (driver/     | (booking)| (referral) |
           |  conductor/  |          |            |
           |  ticketer)   |          v            |
           |              |   +==============+    |
           |              |   |SalesReferral |    |
           |              |   |==============|    |
           |              |   | [FK] userId  |    |
           |              |   | [FK] salesId |    |
           v              |   +==============+    |
    +=================+   |          ^            |
    |      Trip       |   |          |            |
    |=================|   |   +=============+     |
    | [PK] id         |   |   | SalesPerson |     |
    | [FK] companyId   |   |   |=============|     |
    | [FK] driverId    |   |   | [PK] id     |     |
    | [FK] conductorId |   |   | [UQ][S]phone|     |
    | [FK] ticketerId  |   |   | [S] password|     |
    | [FK] vehicleId---+---+-->| [S] bankAcct|     |
    | [S] trackingToken|   |   | [UQ] refCode|     |
    | price            |   |   | [FK]recruiter|    |
    | status           |   |   +=============+     |
    | availableSlots   |   |                       |
    | noShowCount      |   |                       |
    +======+==========++   |                       |
           |          |    |                       |
     +-----+    +-----+   |              +--------+
     |          |          |              |
     | 1:N      | 1:1      | 1:N          | 1:N
     v          v          v              v
+=========+ +========+ +=========+ +================+
|TripPos  | |TripLog | |Booking  | |WorkOrder       |
|=========| |========| |=========| |================|
|[PK] id  | |[PK] id | |[PK] id  | |[PK] id         |
|[FK]tripId |[FK]trip| |[FK]tripId |[UQ] woNumber   |
|[S] lat  | |[FK]veh | |[FK]userId| |[FK] vehicleId  |
|[S] lon  | |odometer| |[S]amount | |[S] laborCost   |
|speed    | +========+ |status   | |[S] partsCost   |
|heading  |            |isReplace| |[S] totalCost   |
+=========+            +====+====+ +====+===========+
                            |            |
                      +-----+-----+      | 1:N
                      |     |     |      v
                      | 1:N | 1:1 | +============+
                      v     v     v |WorkOrderPart|
                +------+ +---+ +-------+ |============|
                |Pssngr| |Pay| |Ticket | |[FK]woId    |
                |======| |===| |=======| |partName    |
                |[PK]id| |[PK]| |[PK]id | |[S]unitPrice|
                |[FK]bk| |[FK]| |[FK]bk | +============+
                |[S]name| |bkId| |[FK]trip|
                |[S]natl| |[S]$| |[S]QR  |
                |[S]phon| |mthd| |[UQ][S]|
                |bdgStat| +---+ |shtCode|
                +------+        +-------+

    Legend:
    [PK] = Primary Key       [S] = SENSITIVE field
    [FK] = Foreign Key        [UQ] = Unique constraint
    1:N = One-to-Many         1:1 = One-to-One
```

---

## 4. Sensitive Fields Summary

### 4.1 Fields Requiring Encryption at Rest

| Entity | Field | Data Type | Current Protection | Recommendation |
|--------|-------|-----------|-------------------|----------------|
| User | password | String | bcrypt hash (12 rounds) | Adequate - hashed, not encrypted |
| User | nationalId | String | Plaintext | Consider AES-256 encryption |
| User | phone | String | Plaintext | Consider AES-256 encryption |
| User | email | String | Plaintext | Consider AES-256 encryption |
| Passenger | nationalId | String | Plaintext | Consider AES-256 encryption |
| Passenger | phone | String | Plaintext | Consider AES-256 encryption |
| SalesPerson | password | String | bcrypt hash | Adequate |
| SalesPerson | bankAccountNumber | String | Plaintext | **Requires** AES-256 encryption |
| Company | bankAccount | String | Plaintext | **Requires** AES-256 encryption |
| Company | tinNumber | String | Plaintext | Consider AES-256 encryption |
| PasswordReset | tokenHash | String | bcrypt hash | Adequate |
| ProcessedCallback | rawPayload | Text | Plaintext | Consider encryption |
| Ticket | shortCode | String | Plaintext (6-char) | Adequate (short-lived, single-use) |
| Trip | trackingToken | String | Plaintext | Consider encryption |

### 4.2 Fields Requiring Access Control

| Entity | Field | Access Rule |
|--------|-------|-------------|
| User | password | Never exposed in API responses |
| User | nationalId | Only visible to company admin (same company) and super admin |
| Passenger | nationalId | Only visible to trip staff and company admin |
| Passenger | phone | Only visible to trip staff and company admin |
| Company | bankAccount | Only visible to company admin and super admin |
| Company | tinNumber | Only visible to company admin and super admin |
| SalesPerson | bankAccountNumber | Only visible to sales person (self) and super admin |
| AdminLog | details | Only visible to super admin and company admin (company-scoped) |
| ProcessedCallback | rawPayload | Only visible to super admin |
| PlatformStaff | permissions | Only visible to super admin |
| TripPosition | latitude/longitude | Public for DEPARTED trips (passenger tracking) |
| SupportTicket | ipAddress | Only visible to super admin |

### 4.3 Data Retention Policies

| Entity | Retention | Mechanism |
|--------|-----------|-----------|
| TripPosition | 7 days after trip COMPLETED/CANCELLED | Cron job auto-purge |
| SmsSession | 15 minutes | Cron job cleanup |
| TelegramSession | 30 minutes | Cron job cleanup |
| PasswordReset | 1 hour (token expiry) | isUsed flag + expiresAt |
| Payment (PENDING) | 10 minutes | Cron job cancellation |
| Booking (PENDING) | 10 minutes | Cron job cancellation |

---

## 5. Unique Constraints Summary

| Entity | Field(s) | Purpose |
|--------|----------|---------|
| User | phone | Primary auth identifier |
| City | name | Prevent duplicate cities |
| Ticket | shortCode | Ticket verification token |
| Payment | bookingId | One payment per booking |
| Trip | trackingToken | OsmAnd GPS auth |
| ProcessedCallback | transactionId | Payment replay prevention |
| ProcessedCallback | callbackHash | Duplicate callback prevention |
| PasswordReset | tokenHash | Token uniqueness |
| SalesPerson | phone | Auth identifier |
| SalesPerson | referralCode | Referral attribution |
| SalesReferral | userId | One referral per user |
| SalesCommission | bookingId | One commission per booking |
| TelegramSession | chatId | One session per Telegram user |
| TelegramSession | sessionId | Session uniqueness |
| SmsSession | sessionId | Session uniqueness |
| PlatformStaff | userId | One staff record per user |
| PlatformStaff | employeeId | Employee ID uniqueness |
| PlatformStaff | email | Email uniqueness |
| WorkOrder | workOrderNumber | WO reference uniqueness |
| SupportTicket | ticketNumber | Ticket reference uniqueness |
| Vehicle | [companyId, plateNumber] | Plate unique per company |
| Vehicle | [companyId, sideNumber] | Side number unique per company |
| TripLog | tripId | One log per trip |
| TripMessageReadReceipt | [messageId, userId] | One read per user per message |
| WorkOrderMessageReadReceipt | [messageId, userId] | One read per user per message |

---

## 6. Index Summary

Total indexes across all models: **85+**

Key performance indexes:
- **Trip queries**: `[companyId, status, departureTime]` (compound)
- **Booking lookups**: `[tripId, status]`, `[userId, status]`
- **Ticket verification**: `[shortCode, isUsed]`
- **Fleet tracking**: `[trackingActive, status]`
- **Audit trail**: `[userId, createdAt]`, `[companyId, createdAt]`
- **Risk scoring**: `[maintenanceRiskScore]`, `[predictedFailureDate]`

---

*End of Document 4.2.1c - Entity Relationship Diagram*
