# i-Ticket Platform - Authorization and Access Control

**Document**: 5.4.8 - Authorization and Access Control
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Authorization Model

i-Ticket uses **Role-Based Access Control (RBAC)** with **company-level data segregation** as a secondary access control layer. Authorization is enforced at the API route handler level (not middleware), ensuring every protected endpoint explicitly checks user role and company ownership.

### 1.1 Access Control Layers

```
Layer 1: Authentication (Is the user logged in?)
    │
Layer 2: Role Check (Does the user have the required role?)
    │
Layer 3: Company Segregation (Does the user belong to this company?)
    │
Layer 4: Resource Ownership (Does this resource belong to the user?)
    │
Layer 5: Status Guards (Is this operation allowed in the current state?)
```

---

## 2. User Roles

### 2.1 Primary Roles

| Role | Code | Description | Creation Method |
|------|------|-------------|-----------------|
| **Customer** | `CUSTOMER` | End users who search and book bus tickets | Self-registration or guest creation |
| **Company Admin** | `COMPANY_ADMIN` | Bus company staff members (with sub-roles) | Created by Super Admin or existing Company Admin |
| **Super Admin** | `SUPER_ADMIN` | Platform administrators with global access | Database seeding only |
| **Sales Person** | `SALES_PERSON` | Sales agents who earn referral commissions | Self-registration with referral code |

### 2.2 Company Staff Sub-Roles

When `role = COMPANY_ADMIN`, the `staffRole` field further restricts access:

| Sub-Role | Code | Permissions |
|----------|------|-------------|
| **Admin** | `ADMIN` | Full company management: trips, staff, vehicles, settings, analytics, reports |
| **Supervisor** | `SUPERVISOR` | Read-only dashboard + limited management (cannot change auto-halt settings) |
| **Driver** | `DRIVER` | View assigned trips, update trip status, GPS tracking, field repairs |
| **Conductor** | `CONDUCTOR` | View assigned trips, verify tickets, manage boarding, GPS tracking |
| **Cashier** | `MANUAL_TICKETER` | View assigned trips, sell manual tickets (CASH), boarding checklist |
| **Mechanic** | `MECHANIC` | View/update assigned work orders, track parts, messaging |
| **Finance** | `FINANCE` | Review work order costs, approve expenditures, financial summaries |

### 2.3 Platform Staff Roles (Super Admin sub-roles)

| Role | Permissions |
|------|-------------|
| Customer Support | View bookings, manage support tickets |
| Operations Manager | View trips, companies, manage operations |
| Finance Officer | View revenue, tax reports, settlements |
| Content Manager | Manage platform content |
| Compliance Officer | View audit logs, compliance reports |

---

## 3. Permission Matrix

### 3.1 API Endpoint Access by Role

| API Group | Customer | Company Admin | Driver | Conductor | Cashier | Mechanic | Finance | Super Admin | Sales |
|-----------|----------|---------------|--------|-----------|---------|----------|---------|-------------|-------|
| **Auth** (login/register) | Yes | Yes | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| **Public trips** (search) | Yes | Yes | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| **Own bookings** | CRUD | — | — | — | — | — | — | All | — |
| **Create booking** | Yes | **No** | — | — | — | — | — | **No** | — |
| **Process payment** | Yes | — | — | — | — | — | — | — | — |
| **Company trips** | — | CRUD | Read/Status | Read | Read | — | — | Read all | — |
| **Manual ticket sale** | — | Yes | — | — | Yes | — | — | — | — |
| **Ticket verification** | — | Yes | — | Yes | — | — | — | Yes | — |
| **No-show marking** | — | Yes | — | — | — | — | — | Yes | — |
| **Replacement tickets** | — | Yes | — | — | Yes | — | — | Yes | — |
| **Company staff** | — | CRUD | — | — | — | — | — | — | — |
| **Company vehicles** | — | CRUD | — | — | — | — | — | — | — |
| **Work orders** | — | CRUD | Read/Update | — | — | Read/Update | Read/Update | — | — |
| **Fleet analytics** | — | Read | — | — | — | — | — | — | — |
| **Company reports** | — | Read/Export | — | — | — | — | — | — | — |
| **Company settings** | — | Admin only | — | — | — | — | — | — | — |
| **GPS tracking (send)** | — | Yes | Yes | Yes | — | — | — | Yes | — |
| **GPS tracking (view)** | Public | Company fleet | Own trip | Own trip | — | — | — | All | — |
| **Admin dashboard** | — | — | — | — | — | — | — | Yes | — |
| **Manage companies** | — | — | — | — | — | — | — | CRUD | — |
| **Platform analytics** | — | — | — | — | — | — | — | Yes | — |
| **Audit logs** | — | Own company | — | — | — | — | — | All | — |
| **Sales dashboard** | — | — | — | — | — | — | — | — | Yes |
| **Support tickets** | Own | — | — | — | — | — | — | All | — |
| **Notifications** | Own | Own | Own | Own | Own | Own | Own | Own | Own |

### 3.2 Special Access Rules

| Rule | Description |
|------|-------------|
| **Company Admin cannot book** | `COMPANY_ADMIN` role is explicitly blocked from creating bookings to prevent self-booking fraud |
| **Super Admin cannot book** | `SUPER_ADMIN` role is explicitly blocked from creating bookings |
| **Full Admin guard** | `requireFullAdmin()` blocks `SUPERVISOR` sub-role from sensitive operations (auto-halt settings) |
| **Guest booking allowed** | Unauthenticated users can book via guest flow (phone payment = verification) |
| **Cashier unlimited sales** | Cashiers can sell manual tickets even when `availableSlots = 0` (manual ticketing never blocked) |
| **Replacement sales restricted** | Only staff/cashier/admin — not available for online customer booking |

---

## 4. Company Data Segregation

### 4.1 Segregation Principle

**Every company-scoped database query MUST include `companyId` from the authenticated session.** This is the platform's most critical security rule (RULE-001).

```
// ENFORCED PATTERN in every company API route:
const data = await prisma.trip.findMany({
  where: {
    companyId: session.user.companyId,  // ← MANDATORY filter
    // ... other filters
  }
})
```

### 4.2 Segregation Scope

| Resource | Segregated By | Shared? |
|----------|--------------|---------|
| Trips | `Trip.companyId` | No — each company sees only its own trips |
| Bookings | Via `Trip.companyId` | No — bookings scoped through trip ownership |
| Vehicles | `Vehicle.companyId` | No — each company manages its own fleet |
| Staff | `User.companyId` | No — staff visible only within their company |
| Work Orders | `WorkOrder.companyId` | No — work orders scoped to company vehicles |
| Analytics | Filtered by `companyId` | No — analytics computed per-company |
| Audit Logs | `AdminLog.companyId` | No — logs scoped to company (except Super Admin views all) |
| Cities | No `companyId` | **Yes — shared resource** (all companies use same city database) |
| Bookings (customer view) | `Booking.userId` | Customer sees own bookings regardless of company |

### 4.3 Super Admin Override

Super Admin (`SUPER_ADMIN`) bypasses company segregation and can:
- View all trips, bookings, manifests across all companies
- Manage any company's settings
- View platform-wide audit logs and analytics
- Access any company's data for platform management

### 4.4 Cross-Company Isolation Verification

To verify segregation, INSA auditors can:
1. Log in as Selam Bus admin (0922345678)
2. Attempt to access trips from another company via API
3. Verify: only Selam Bus trips are returned
4. Verify: modifying another company's trip ID returns 404 (not found, not 403)

**Important**: The system returns 404 (not 403) for resources belonging to other companies to prevent information leakage about resource existence.

---

## 5. Resource-Level Authorization

### 5.1 Booking Ownership

| Operation | Authorization Rule |
|-----------|-------------------|
| View booking | Owner (created the booking) OR company admin (trip's company) OR super admin |
| Cancel booking | Owner (PENDING only) OR company admin OR super admin |
| Process payment | Owner only (via session or guest phone match) |

### 5.2 Trip Access

| Operation | Authorization Rule |
|-----------|-------------------|
| View trip (public) | Anyone (public API) |
| Create trip | Company admin (own company only) |
| Edit trip | Company admin (own company) + trip in editable state |
| Delete trip | Company admin (own company) + no paid bookings |
| Change status | Company admin (own company) + valid status transition |
| View boarding | Company admin (own company) + BOARDING/DEPARTED only |

### 5.3 Ticket Verification

| Operation | Authorization Rule |
|-----------|-------------------|
| Verify ticket | Company admin or super admin + ticket's company matches verifier's company |
| Mark ticket used | Same as verify + ticket not already used |

---

## 6. Status-Based Access Control

Beyond role-based checks, many operations are restricted by the current state of the resource:

### 6.1 Trip Status Guards

| Trip Status | Allowed Operations | Blocked Operations |
|-------------|--------------------|--------------------|
| `SCHEDULED` | Edit, delete, change status, toggle booking | No-show, replacement |
| `DELAYED` | Edit, change status, toggle booking | No-show, replacement |
| `BOARDING` | Change status, toggle booking, view boarding | Edit, delete, no-show, replacement |
| `DEPARTED` | No-show marking, replacement sales, GPS tracking | Edit, delete, online booking |
| `COMPLETED` | View only | All mutations |
| `CANCELLED` | View only | All mutations |
| `SOLD_OUT` (availableSlots=0) | View only, manual ticketing | Online booking |

### 6.2 Booking Status Guards

| Booking Status | Allowed Operations | Blocked Operations |
|----------------|--------------------|--------------------|
| `PENDING` | Cancel, process payment | Ticket generation |
| `PAID` | View, verify tickets | Cancel (without refund), re-pay |
| `CANCELLED` | View only | All mutations |
| `COMPLETED` | View only | All mutations |

### 6.3 Payment Window Guard

- Booking payment must be completed within **10 minutes** of booking creation
- After 10 minutes: payment API returns 400, cron job cancels booking and releases slots
- Enforced server-side: `booking.createdAt + 10min > now`

---

## 7. Authorization Enforcement Points

### 7.1 Server-Side Enforcement (Primary)

All authorization is enforced server-side in API route handlers:

```
// Example: Company trip access
export async function GET(request, { params }) {
  // Layer 1: Authentication
  const session = await requireCompanyAdmin()  // Returns 401/403 if fails

  // Layer 3: Company Segregation (in query)
  const trip = await prisma.trip.findFirst({
    where: {
      id: params.tripId,
      companyId: session.user.companyId  // ← Company isolation
    }
  })

  // Layer 4: Resource existence (returns 404 for other companies)
  if (!trip) return NextResponse.json({ error: "Trip not found" }, { status: 404 })

  // Layer 5: Status guard
  if (!["BOARDING", "DEPARTED"].includes(trip.status)) {
    return NextResponse.json({ error: "Only available for boarding/departed trips" }, { status: 400 })
  }

  return NextResponse.json({ trip })
}
```

### 7.2 Client-Side UI Controls (Secondary)

The frontend hides UI elements based on role, but this is for UX only — not a security boundary:

- Navigation menus show only role-appropriate items
- Buttons are hidden/disabled based on trip status
- Forms are disabled for read-only states

**All access control is enforced server-side.** Client-side hiding provides UX convenience but is not relied upon for security.

---

## 8. Audit Trail

### 8.1 AdminLog Entries

All authorization-relevant operations are logged:

| Action | Logged Fields |
|--------|--------------|
| `BOOKING_CREATED` | userId, bookingId, tripId, companyId, amount |
| `PAYMENT_PROCESSED` | userId, paymentId, bookingId, method, amount |
| `TICKET_VERIFIED` | userId, ticketId, tripId, companyId |
| `TICKET_USED` | userId, ticketId, passengerId, tripId |
| `TRIP_STATUS_CHANGED` | userId, tripId, companyId, fromStatus, toStatus |
| `PASSENGER_NO_SHOW` | userId, tripId, passengerIds, noShowCount |
| `REPLACEMENT_TICKET_SALE` | userId, tripId, bookingId, seatNumbers, amount |
| `STAFF_CREATED` | userId, newUserId, staffRole, companyId |
| `COMPANY_DEACTIVATED` | userId, companyId, reason |
| `VEHICLE_STATUS_CHANGED` | userId, vehicleId, fromStatus, toStatus |
| `LOGIN_FAILED` | phone, IP address, reason |

### 8.2 Log Access

| Role | Accessible Logs |
|------|-----------------|
| Company Admin | Own company's AdminLog entries |
| Super Admin | All AdminLog entries across all companies |
| Other roles | No direct audit log access |

### 8.3 Log Export

- Company admins: CSV download of own company logs
- Super admins: CSV download of platform-wide logs
- Logs include: timestamp, userId, action, details (JSON), companyId, IP address

---

## 9. Concurrency Controls

### 9.1 Race Condition Prevention

| Operation | Control | Mechanism |
|-----------|---------|-----------|
| Booking creation | Row lock on Trip | `SELECT FOR UPDATE NOWAIT` — fails immediately on conflict |
| Payment processing | Row lock on Booking | `SELECT FOR UPDATE NOWAIT` — prevents double payment |
| No-show marking | Transaction | `transactionWithTimeout(10s)` — atomic counter updates |
| Replacement ticket | Transaction + lock | Row lock + released seat cap check in transaction |
| Trip status change | Transaction | Status transition validated inside transaction |

### 9.2 Transaction Timeouts

All write transactions use `transactionWithTimeout(fn, 10000)`:
- 10-second maximum execution time
- Automatic rollback on timeout
- Prevents deadlocks from holding locks indefinitely
- `NOWAIT` on `SELECT FOR UPDATE` fails immediately rather than waiting for lock

---

## 10. Testing Access Control

### 10.1 Test Accounts Provided

| Role | Phone | Password | Company |
|------|-------|----------|---------|
| Super Admin | 0911223344 | demo123 | — (global) |
| Selam Bus Admin | 0922345678 | demo123 | Selam Bus |
| Customer | 0912345678 | demo123 | — |
| Guest | Any 09XXXXXXXX | (none) | — |

### 10.2 Suggested Test Cases

| Test | Expected Result |
|------|-----------------|
| Customer accesses `/api/company/trips` | 401 or 403 |
| Selam Bus admin accesses another company's trip by ID | 404 (not 403) |
| Customer creates booking with tampered amount | Server recalculates; amount ignored |
| Cashier accesses auto-halt settings | 403 (requires full admin) |
| Guest booking without phone payment | Allowed (phone payment = verification) |
| Attempt to edit DEPARTED trip | 400 (read-only state) |
| Attempt to book on CANCELLED trip | 400 (invalid trip status) |
| Attempt no-show on SCHEDULED trip | 400 (only DEPARTED) |
| Admin sells replacement when no released seats | 400 (released seat cap exceeded) |
| Expired payment (>10 min) | 400 (payment window expired) |

---

*End of Document 5.4.8 - Authorization and Access Control*
