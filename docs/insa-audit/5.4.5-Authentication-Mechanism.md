# i-Ticket Platform - Authentication Mechanism

**Document**: 5.4.5 - Authentication Mechanism
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Authentication Architecture

### 1.1 Primary Authentication

| Property | Value |
|----------|-------|
| **Framework** | NextAuth.js v4 (open-source authentication library for Next.js) |
| **Strategy** | JWT (JSON Web Token) — stateless, cookie-based |
| **Provider** | Credentials provider (phone + password) |
| **Password Hashing** | bcrypt with 12 salt rounds |
| **Session Duration** | 30 days |
| **Cookie Transport** | HTTP-only secure cookie |

### 1.2 Authentication Flow

```
User Login Request
    │
    ├─── 1. Rate limit check (5/15min per phone, 10/15min per IP)
    │         └── 429 if exceeded
    │
    ├─── 2. Phone number normalization
    │         └── +251912... → 0912..., 251912... → 0912...
    │
    ├─── 3. User lookup by phone
    │         └── Generic error if not found (no enumeration)
    │
    ├─── 4. Password verification
    │         └── bcrypt.compare() — timing-safe
    │         └── Generic error if wrong (same as user not found)
    │
    ├─── 5. Account status check
    │         └── Check if user's company is active (for company staff)
    │
    ├─── 6. JWT token generation
    │         └── Payload: { id, role, phone, companyId, staffRole, ... }
    │         └── Signed with NEXTAUTH_SECRET (>= 32 chars)
    │
    ├─── 7. Cookie set
    │         └── httpOnly: true, secure: true, sameSite: 'lax'
    │         └── Max-Age: 30 days
    │
    └─── 8. mustChangePassword check
              └── If true, client redirects to password change page
```

---

## 2. Session Management

### 2.1 JWT Session Configuration

| Property | Value | Security Rationale |
|----------|-------|-------------------|
| `httpOnly` | `true` | Prevents JavaScript access to cookie (XSS protection) |
| `secure` | `true` (production) | Cookie only sent over HTTPS |
| `sameSite` | `lax` | Prevents cross-origin POST requests from including cookie (CSRF protection) |
| `maxAge` | 2,592,000 seconds (30 days) | Session duration |
| `path` | `/` | Cookie available to all routes |
| `domain` | `i-ticket.et` | Scoped to production domain |

### 2.2 JWT Token Contents

The JWT payload contains minimal Personally Identifiable Information (PII):

```json
{
  "id": "clxxx...",
  "name": "User Name",
  "phone": "0912345678",
  "role": "COMPANY_ADMIN",
  "companyId": "clyyy...",
  "companyName": "Selam Bus",
  "companyLogo": "/uploads/logo.png",
  "staffRole": "ADMIN",
  "profilePicture": null,
  "nationalId": null,
  "mustChangePassword": false,
  "iat": 1708300000,
  "exp": 1710892000
}
```

### 2.3 Session Validation Per-Request

Each API request:
1. Extracts JWT from cookie
2. Verifies JWT signature against `NEXTAUTH_SECRET`
3. Checks token expiry
4. Returns session object with user claims

No database lookup per request (stateless JWT). User changes (role updates, deactivation) take effect on next login or token refresh.

### 2.4 Session Termination

| Method | Implementation |
|--------|---------------|
| User logout | Client-side cookie clearing via NextAuth `signOut()` |
| Token expiry | Natural expiry after 30 days |
| Password change | Does NOT invalidate existing tokens (known limitation) |
| Account deactivation | Company deactivation blocks login; existing tokens valid until expiry |

**Known Limitation**: JWT has no server-side revocation mechanism. A compromised token remains valid until its 30-day expiry. This is documented in the Known Limitations section of Document 4.2.5.

---

## 3. Password Security

### 3.1 Password Storage

| Property | Value |
|----------|-------|
| Algorithm | bcrypt |
| Salt rounds | 12 |
| Storage | Hash only (plaintext never stored, never logged) |
| Comparison | `bcryptjs.compare()` — constant-time comparison |

### 3.2 Password Requirements

| Requirement | Rule |
|-------------|------|
| Minimum length | 8 characters |
| Maximum length | 72 characters (bcrypt limit) |
| Uppercase | At least 1 uppercase letter (A-Z) |
| Lowercase | At least 1 lowercase letter (a-z) |
| Digit | At least 1 digit (0-9) |
| Special characters | Not required |

Enforced by Zod validation: `.min(8).max(72).regex(/[A-Z]/).regex(/[a-z]/).regex(/[0-9]/)`

### 3.3 Password Reset Flow

```
1. User submits phone number
   └── Rate limit: 3/hr per IP
   └── Same response regardless of phone existence

2. System generates token
   └── crypto.randomBytes(32).toString('hex') — 256-bit random
   └── Token hashed with bcrypt before database storage
   └── Expiry: 1 hour

3. SMS sent to user
   └── Contains raw token in reset URL
   └── URL: https://i-ticket.et/reset-password?token=<raw_token>

4. User submits new password + token
   └── Token compared against stored bcrypt hash
   └── New password validated (strength rules)
   └── New password hashed with bcrypt (12 rounds)
   └── Reset token cleared from database

5. Token is one-time use
   └── Cleared after successful reset
   └── Expires after 1 hour if unused
```

### 3.4 Temporary Passwords

When a company admin creates staff accounts, a temporary password is generated:
- Staff member must change password on first login (`mustChangePassword: true`)
- System forces redirect to password change page
- Flag cleared after successful password change

---

## 4. Role-Based Access Control (RBAC)

### 4.1 User Roles

| Role | Description | Count |
|------|-------------|-------|
| `CUSTOMER` | End users who book tickets | Majority of users |
| `COMPANY_ADMIN` | Bus company staff (with sub-roles) | Per-company |
| `SUPER_ADMIN` | Platform administrators | Limited (1-3) |
| `SALES_PERSON` | Sales agents with referral codes | Variable |

### 4.2 Staff Sub-Roles (under COMPANY_ADMIN)

| Sub-Role | Permissions |
|----------|-------------|
| `ADMIN` | Full company management |
| `SUPERVISOR` | Read-only + limited management (no auto-halt settings) |
| `DRIVER` | Trip status updates, GPS tracking |
| `CONDUCTOR` | Ticket verification, boarding management |
| `MANUAL_TICKETER` (Cashier) | Manual ticket sales, boarding checklist |
| `MECHANIC` | Work order management, parts tracking |
| `FINANCE` | Cost approval, financial reporting |

### 4.3 Auth Helper Functions

```
requireAuth()          → Any authenticated user
requireRole([...])     → Specific roles only
requireCompanyAdmin()  → COMPANY_ADMIN with companyId
requireSuperAdmin()    → SUPER_ADMIN only
requireSalesPerson()   → SALES_PERSON only
requireFullAdmin()     → COMPANY_ADMIN with staffRole null or "ADMIN" (blocks supervisors)
```

### 4.4 Permission Matrix

| Resource | Customer | Company Admin | Staff/Cashier | Mechanic | Finance | Super Admin |
|----------|----------|---------------|---------------|----------|---------|-------------|
| Book tickets | Yes | No | No | No | No | No |
| View own bookings | Yes | — | — | — | — | Yes (all) |
| Manage trips | No | Own company | Own assigned | No | No | All |
| Manage vehicles | No | Own company | No | No | No | All |
| Verify tickets | No | Own company | Own company | No | No | All |
| Sell manual tickets | No | Own company | Own company | No | No | No |
| Mark no-shows | No | Own company | No | No | No | Yes |
| Manage work orders | No | Own company | Own assigned | Own assigned | Own company | No |
| View analytics | No | Own company | No | No | No | All |
| Manage companies | No | No | No | No | No | Yes |
| Manage platform staff | No | No | No | No | No | Yes |
| GPS tracking | No | Own company fleet | Own trip | No | No | All |

---

## 5. Alternative Authentication Mechanisms

### 5.1 Cron Job Authentication

| Property | Value |
|----------|-------|
| Method | Bearer token in `Authorization` header |
| Token | `CRON_SECRET` environment variable |
| Validation | Exact string match |
| Used by | `/api/cron/cleanup`, `/api/cron/trip-reminders`, `/api/cron/predictive-maintenance`, `/api/cron/telegram-cleanup` |

### 5.2 OsmAnd GPS Token Authentication

| Property | Value |
|----------|-------|
| Method | Query parameter (`?token=<value>`) |
| Token | `crypto.randomBytes(32).toString('hex')` — 256-bit random |
| Storage | `Trip.trackingToken` field (unique per trip) |
| Validation | Database lookup against Trip model |
| Used by | `/api/tracking/osmand` |

### 5.3 SMS Session Authentication

| Property | Value |
|----------|-------|
| Method | `smsSessionId` in request body |
| Token | System-generated session ID |
| Expiry | 5 minutes |
| Used by | `/api/bookings` (SMS booking flow) |

### 5.4 TeleBirr Webhook Authentication

| Property | Value |
|----------|-------|
| Method | HMAC-SHA256 signature in request body |
| Key | `TELEBIRR_APP_KEY` environment variable |
| Verification | 5-gate: hash → replay → HMAC → timestamp → IP whitelist |
| Comparison | `crypto.timingSafeEqual()` (prevents timing attacks) |
| Used by | `/api/payments/telebirr/callback` |

### 5.5 Telegram Bot Authentication

| Property | Value |
|----------|-------|
| Method | Secret token header set during webhook registration |
| Validation | Telegram-provided secret in `X-Telegram-Bot-Api-Secret-Token` header |
| Used by | `/api/telegram/webhook` |

### 5.6 Guest Booking (No Authentication)

| Property | Value |
|----------|-------|
| Method | Phone number as identity |
| Flow | First passenger's phone → create/lookup guest User → associate booking |
| Verification | Phone payment (TeleBirr) serves as verification |
| Limitations | Guest users have `password: null`, cannot log in to the portal |

---

## 6. Brute Force Protection

### 6.1 Rate Limiting Configuration

| Endpoint | Limit | Window | Key | Behavior |
|----------|-------|--------|-----|----------|
| Login | 5 requests | 15 min | Per phone number | Returns 429 with `retryAfter` |
| Login | 10 requests | 15 min | Per IP address | Returns 429 with `retryAfter` |
| Registration | 3 requests | 1 hour | Per IP address | Returns 429 |
| Password reset | 3 requests | 1 hour | Per IP address | Returns 429 |

### 6.2 Rate Limiter Implementation

- **Type**: In-memory sliding window counter
- **Location**: `src/lib/rate-limit.ts`
- **Key extraction**: `x-forwarded-for` header (from Cloudflare) or `x-real-ip` (from Nginx)
- **Response**: HTTP 429 with `Retry-After` header and JSON body `{ error, retryAfter }`
- **Limitation**: Resets on server restart (daily at 3 AM via PM2 cron restart)
- **Baseline**: Nginx provides additional rate limiting (30 req/sec per IP)

### 6.3 User Enumeration Prevention

Both "user not found" and "wrong password" return the same error message:
```json
{ "error": "Invalid phone number or password" }
```

Response timing is consistent due to bcrypt's constant-time comparison.

---

## 7. Secret Management

### 7.1 Environment Variables

| Variable | Purpose | Sensitivity |
|----------|---------|-------------|
| `NEXTAUTH_SECRET` | JWT signing key | Critical — validated at startup (>= 32 chars, no placeholder detection) |
| `TELEBIRR_APP_KEY` | TeleBirr HMAC key | Critical |
| `TELEBIRR_APP_ID` | TeleBirr application ID | High |
| `CRON_SECRET` | Cron job authentication | High |
| `TELEGRAM_BOT_TOKEN` | Telegram Bot API token | High |
| `SMS_API_KEY` | SMS gateway authentication | High |
| `DATABASE_URL` | PostgreSQL connection string | Critical |

### 7.2 Secret Validation at Startup

The application validates critical secrets on startup:
- `NEXTAUTH_SECRET`: Must be >= 32 characters. Rejects known placeholder values (e.g., "change-me", "secret123").
- `DATABASE_URL`: Must be valid PostgreSQL connection string.

### 7.3 Secret Storage

- Secrets stored as environment variables on the EC2 instance
- Not committed to version control (`.env` in `.gitignore`)
- Loaded by PM2 via `ecosystem.config.js`

---

## 8. Security Headers

Authentication-related HTTP headers set by middleware:

| Header | Value | Purpose |
|--------|-------|---------|
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains; preload` | Force HTTPS (via Cloudflare HSTS) |
| `X-Content-Type-Options` | `nosniff` | Prevent MIME sniffing |
| `X-Frame-Options` | `DENY` | Prevent clickjacking |
| `X-XSS-Protection` | `1; mode=block` | Legacy XSS filter |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | Limit referrer leakage |
| `Permissions-Policy` | `geolocation=(self), camera=(), microphone=()` | Feature restrictions |
| `Cache-Control` | `no-store` | Prevent caching of authenticated pages |
| `Pragma` | `no-cache` | Legacy cache prevention |

---

## 9. Known Limitations and Recommendations

| Limitation | Risk Level | Current Mitigation | Recommendation |
|------------|-----------|-------------------|----------------|
| No JWT revocation | Medium | Token expires in 30 days | Implement token blacklist or switch to database sessions for sensitive operations |
| In-memory rate limiter | Low | Nginx baseline + daily restart | Consider Redis-backed rate limiter for persistence |
| No MFA/2FA | Medium | Phone verification for guests | Add TOTP or SMS OTP for admin accounts |
| Password change doesn't invalidate tokens | Low | 30-day natural expiry | Implement session version counter in JWT |
| No account lockout after failures | Low | Rate limiting provides equivalent protection | Consider lockout after N failures with admin unlock |
| `sameSite: lax` (not `strict`) | Low | CSP `form-action 'self'` compensates | `strict` would break OAuth flows if ever added |

---

*End of Document 5.4.5 - Authentication Mechanism*
