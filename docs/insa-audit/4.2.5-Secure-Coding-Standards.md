# i-Ticket Platform - Secure Coding Standard Documentation

**Document**: 4.2.5 - Secure Coding Standard Documentation
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Secure Coding Guidelines

i-Ticket development follows OWASP Secure Coding Practices aligned with the OWASP Top 10 (2021). The following guidelines are enforced across the codebase.

### 1.1 Guiding Principles

| Principle | Implementation |
|-----------|---------------|
| **Defense in Depth** | 9 security layers: Cloudflare -> Nginx -> Middleware -> Headers -> Auth -> Validation -> Payment Security -> DB Security -> Audit |
| **Least Privilege** | RBAC with company segregation; staff sub-roles limit access to needed functions only |
| **Fail Securely** | All errors return generic messages; transactions roll back on failure; seats released on payment timeout |
| **Don't Trust Client** | Server-side validation on all inputs; server-side amount recalculation; server-side role checks |
| **Separation of Concerns** | Business logic in `src/lib/`, validation at API boundary, auth in middleware |

---

## 2. Internal Rules and Checklists

### 2.1 Mandatory Rules (from RULES.md)

| Rule ID | Rule | Enforcement |
|---------|------|-------------|
| **RULE-001** | Company Segregation: Every company API MUST filter by `companyId` | Code review; session.user.companyId used in every query |
| **RULE-002** | View-Only Trips: DEPARTED/COMPLETED/CANCELLED/SOLD-OUT trips are read-only | Status guard checks in all trip mutation APIs |
| **RULE-003** | Guest Booking: Phone payment = verification, no OTP required | Business rule enforced in booking API |
| **RULE-004** | Auto-Halt: Manual ticketing never blocked; online halts at â‰¤10 slots | Conditional logic with bypass flags |
| **RULE-005** | No-Show: Only on DEPARTED trips; `availableSlots` never modified | Trip status guard + transaction-safe counters |

### 2.2 Pre-Development Checklist

Before writing any API endpoint or data mutation:

- [ ] Read RULES.md appendices (File-to-Rule mapping)
- [ ] Check Bug Registry for known issues in the area
- [ ] Identify which user roles can access this endpoint
- [ ] Plan company segregation (companyId filter)
- [ ] Define Zod validation schema for all inputs
- [ ] Plan error responses (no internal details)
- [ ] Consider concurrency (need row locking? transaction?)
- [ ] Consider rate limiting requirements
- [ ] Plan AdminLog entries for audit trail
- [ ] Verify timezone handling (use Ethiopia timezone utilities)

### 2.3 Code Review Checklist

- [ ] All API inputs validated with Zod schemas
- [ ] No raw SQL queries (Prisma ORM only)
- [ ] Company segregation enforced (companyId in WHERE clause)
- [ ] Role/permission checks present for authenticated endpoints
- [ ] No sensitive data in error responses
- [ ] Financial amounts recalculated server-side (never from client)
- [ ] AdminLog entries for sensitive operations
- [ ] Rate limiting applied to mutation endpoints
- [ ] Timezone-safe date comparisons (Ethiopia utilities)
- [ ] No `parseInt` without scientific notation check
- [ ] No `searchParams.get()` without `.nullish()` handling
- [ ] Transaction timeouts for multi-step DB writes

---

## 3. SQL Injection Prevention

### 3.1 Policy

**All database access MUST go through Prisma ORM.** Raw SQL queries are prohibited.

### 3.2 Implementation

```typescript
// CORRECT: Prisma parameterized query (ALL queries use this pattern)
const trip = await prisma.trip.findUnique({
  where: { id: userInput }  // Prisma auto-parameterizes
})

// PROHIBITED: Raw SQL (never used in codebase)
// prisma.$queryRaw`SELECT * FROM "Trip" WHERE id = ${userInput}`
// prisma.$executeRawUnsafe(...)
```

### 3.3 Verification

A grep for `$queryRaw`, `$executeRaw`, `$queryRawUnsafe`, or `$executeRawUnsafe` across the entire codebase returns zero results. All database operations use Prisma's type-safe query builder.

---

## 4. XSS Prevention

### 4.1 Output Encoding

| Layer | Method | Coverage |
|-------|--------|----------|
| React 18 | Auto-escapes all JSX expressions (`{variable}`) | All rendered content |
| React | `dangerouslySetInnerHTML` not used in codebase | N/A |
| CSP | `script-src 'self' 'unsafe-inline'` | Limits script sources |
| CSP | `default-src 'self'` | Blocks external content by default |
| CSP | `object-src 'none'` | Blocks Flash/Java plugins |

### 4.2 Input Sanitization

| Input Type | Handling |
|------------|----------|
| Text fields (name, message) | Zod string validation; React auto-escaping on render |
| Phone numbers | Regex `/^09\d{8}$/` (only digits) |
| Integer IDs | `parseInt` with scientific notation rejection |
| Search params | Zod `.nullish()` (handles null from `searchParams.get()`) |
| JSON fields | Zod object/array validation before `JSON.stringify` storage |
| URLs | Not user-controlled (all URLs are system-generated) |

### 4.3 CSP as Defense Layer

```
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  img-src 'self' data: https://api.qrserver.com https://*.tile.openstreetmap.org https://unpkg.com;
  font-src 'self' data: https://fonts.gstatic.com;
  connect-src 'self' https://api.telebirr.com https://api.webirr.com
    https://*.tile.openstreetmap.org https://nominatim.openstreetmap.org
    https://cloudflareinsights.com https://router.project-osrm.org;
  media-src 'self' data: blob:;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
  object-src 'none';
  upgrade-insecure-requests;
```

**Note on `unsafe-inline`**: Required for `script-src` because Next.js 14 does not propagate nonces to inline `<script>` tags. Full nonce-based CSP requires Next.js 15+. This is a known framework limitation documented in the Bug Registry.

---

## 5. CSRF Prevention

### 5.1 Strategy

SameSite cookie-based protection (standard for JWT/SPA architectures):

| Control | Value | Effect |
|---------|-------|--------|
| `sameSite` | `lax` | Cookie sent on same-site navigations; NOT sent on cross-origin POST/PUT/DELETE |
| `httpOnly` | `true` | Cookie not accessible via JavaScript (prevents XSS-based theft) |
| CSP `form-action` | `'self'` | Forms can only submit to same origin |
| API design | POST/PUT/PATCH/DELETE for mutations | GET requests never mutate state |

### 5.2 Why No CSRF Tokens

NextAuth.js with JWT strategy and `sameSite: lax` cookies provides equivalent protection to CSRF tokens:
- Cross-origin requests (from attacker sites) do not include the session cookie
- `form-action 'self'` CSP prevents form-based CSRF
- All mutations require POST/PUT/PATCH/DELETE methods

---

## 6. Secure Input Handling

### 6.1 Zod Validation Pattern

Every API endpoint follows this pattern:

```typescript
// 1. Define schema
const schema = z.object({
  tripId: z.string().cuid(),
  passengers: z.array(z.object({
    name: z.string().min(1),
    nationalId: z.string().min(1),
    phone: z.string().regex(/^09\d{8}$/),
    seatNumber: z.number().int().positive().optional(),
  })).min(1).max(5),
})

// 2. Parse and validate (throws on invalid input)
const data = schema.parse(await request.json())

// 3. Use validated data (type-safe from here)
const booking = await createBooking(data)
```

### 6.2 Common Validation Patterns

| Pattern | Usage | Why |
|---------|-------|-----|
| `.nullish()` not `.optional()` | URL search params | `searchParams.get()` returns `null`, not `undefined` |
| Custom `parseInt` validator | Integer params | Native `parseInt` accepts scientific notation (`1e2` = 100) |
| `.cuid()` | ID parameters | Validates CUID format, rejects arbitrary strings |
| `.regex(/^09\d{8}$/)` | Phone numbers | Exact Ethiopian mobile format |
| `.min(1).max(5)` | Passenger arrays | Business rule: 1-5 passengers per booking |
| `.enum([...])` | Status fields | Only accept known values |

### 6.3 Integer Validation (Scientific Notation Guard)

```typescript
// PROBLEM: parseInt("1e2") returns 1 (truncates at 'e')
// This could bypass max-value checks

// SOLUTION: Custom validator used throughout codebase
function safeParseInt(value: string): number | null {
  if (/[eE]/.test(value)) return null  // Reject scientific notation
  const num = parseInt(value, 10)
  if (isNaN(num)) return null
  return num
}
```

---

## 7. File Upload and Download Controls

### 7.1 Upload Security

| Control | Implementation |
|---------|---------------|
| Max file size | Nginx: `client_max_body_size 5M` |
| Storage location | `/public/uploads/` (local filesystem) |
| Filename generation | System-generated IDs (no user-controlled filenames) |
| Path traversal | Filenames sanitized; no directory navigation allowed |
| Serving | Next.js static file serving from `/public/` |

### 7.2 Download Security (Manifests, Reports)

| Control | Implementation |
|---------|---------------|
| Manifest files | Stored in `/public/manifests/company-{companyId}/` |
| Company segregation | File paths include companyId; access checked before serving |
| Excel generation | ExcelJS library generates `.xlsx` in memory; streamed to client |
| Content-Type | Proper MIME types set (`application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`) |
| No user-controlled paths | File paths constructed server-side from validated IDs |

---

## 8. Authentication and Session Management Standards

### 8.1 Password Standards

| Property | Standard |
|----------|----------|
| Hashing | bcrypt with 12 salt rounds |
| Storage | Hash only (plaintext never stored) |
| Comparison | `bcryptjs.compare()` (timing-safe) |
| Reset tokens | Crypto-random (32 bytes), bcrypt-hashed before storage |
| Guest users | `password: null` (phone payment = verification) |
| Temp passwords | `mustChangePassword: true` flag forces change on login |

### 8.2 Session Standards

| Property | Standard |
|----------|----------|
| Strategy | JWT (stateless) |
| Cookie flags | `httpOnly: true`, `secure: true` (production), `sameSite: 'lax'` |
| Max age | 30 days |
| Secret | >= 32 characters, validated at startup, placeholder rejection |
| Token contents | Minimal PII (id, role, companyId, staffRole) |
| Invalidation | Client-side cookie clearing (JWT has no server-side revocation) |

### 8.3 Rate Limiting Standards

| Endpoint Type | Limit | Window |
|--------------|-------|--------|
| Login | 5 per phone / 10 per IP | 30 min / 15 min |
| Registration | 3 per IP | 1 hour |
| Password reset | 3 per IP | 1 hour |
| Booking creation | 10 per IP | 1 minute |
| Payment | 5 per IP | 1 minute |
| Payment (per booking) | 3 per booking | 1 hour |
| Support ticket | 5 per IP | 1 hour |
| Webhooks | 100 per source | 1 minute |
| Default API | 60 per IP | 1 minute |

---

## 9. Regular Patching and Library Validation

### 9.1 Dependency Management

| Practice | Implementation |
|----------|---------------|
| Package manager | npm with `package-lock.json` for deterministic installs |
| Production install | `npm ci` (clean install from lockfile) |
| Vulnerability scanning | GitHub Dependabot (automated alerts) |
| Known overrides | `glob: ^10.5.0` (security patch applied) |
| Resolution status | 6 of 7 Dependabot alerts resolved as of v2.13.0 |

### 9.2 Runtime Versions

| Component | Version | LTS Status |
|-----------|---------|------------|
| Node.js | 20.20.0 | Active LTS (supported until April 2026) |
| Next.js | 14.2.x | Latest 14.x stable |
| PostgreSQL | 16.11 | Supported (EOL: November 2028) |
| Ubuntu | 22.04 LTS | Supported (EOL: April 2027) |

### 9.3 Update Procedure

```
1. Review Dependabot alerts on GitHub
2. Update dependencies locally: npm update / npm audit fix
3. Run local build: npm run build
4. Test critical flows (booking, payment, tracking)
5. Commit and push
6. Deploy to production (see CLAUDE.md deployment workflow)
7. Verify: pm2 logs i-ticket --lines 20
```

---

## 10. Secure Communication Patterns

### 10.1 API Request Signing (Outbound)

```
TeleBirr Payment Initiation:
1. Construct payload (appId, merchantCode, amount, phone, nonce, timestamp)
2. Sort parameters alphabetically
3. Sign: HMAC-SHA256(sortedPayload, TELEBIRR_APP_KEY)
4. Include signature in request header
5. Send via HTTPS
```

### 10.2 Webhook Verification (Inbound)

```
TeleBirr Callback:
1. Receive POST body
2. Compute: HMAC-SHA256(payload, TELEBIRR_APP_KEY)
3. Compare: crypto.timingSafeEqual(computed, received)
4. Check replay: query ProcessedCallback table
5. Validate timestamp (5-min window)
6. Optional: IP whitelist check

SMS Inbound Webhook:
1. Receive POST body
2. Compute: HMAC-SHA256(payload, SMS_WEBHOOK_SECRET)
3. Compare with received signature header
4. Process if valid
```

### 10.3 Timing-Safe Comparison

All cryptographic comparisons use `crypto.timingSafeEqual()` to prevent timing side-channel attacks:

```typescript
const isValid = crypto.timingSafeEqual(
  Buffer.from(computedSignature, 'hex'),
  Buffer.from(receivedSignature, 'hex')
)
```

---

## 11. Known Limitations and Mitigations

| Limitation | Risk | Mitigation |
|------------|------|------------|
| `unsafe-inline` in CSP script-src | Allows inline scripts (XSS vector) | Next.js 14 limitation; React auto-escaping + Zod validation compensate; planned fix with Next.js 15 nonce support |
| JWT has no server-side revocation | Compromised token valid until expiry (30 days) | Short-lived tokens not feasible due to UX; password change does not invalidate existing tokens |
| In-memory rate limiter | Resets on server restart/PM2 restart | Daily restart at 3 AM provides natural reset; Nginx rate limiting provides baseline protection |
| No field-level encryption | Sensitive fields (nationalId, bankAccount) stored plaintext | TLS in transit; DB on localhost (no network exposure); recommended for future implementation |
| No SIEM integration | No centralized log analysis | AdminLog + PM2 logs provide audit trail; Cloudflare analytics for traffic anomalies |
| Single EC2 instance | No redundancy | PM2 auto-restart; Cloudflare caching for static assets; acceptable for current traffic volume |
| No database encryption at rest | Data on disk unencrypted | AWS EBS provides volume-level encryption option (not currently enabled); recommended for future |

---

## 12. Bug Registry (Security-Relevant)

Known bugs with security implications that have been documented and fixed:

| Bug | Root Cause | Fix | Version |
|-----|-----------|-----|---------|
| Grey map tiles in PWA | Service worker intercepted cross-origin tile requests | Skip non-same-origin URLs in sw.js | v2.12.2 |
| UTC vs Ethiopia timezone | AWS EC2 runs UTC; date comparisons 3 hours early | `hasDepartedEthiopia()` timezone utility | v2.10.15 |
| Nonce CSP breaks Next.js 14 | Next.js 14 doesn't propagate nonces to inline scripts | Use `'self' 'unsafe-inline'` instead; nonces need Next.js 15+ | v2.10.17 |
| Cloudflare Email Obfuscation | Modifies HTML, breaks React hydration | Disabled in Cloudflare dashboard | v2.12.1 |
| Stale closure in polling | `setInterval` captures state at setup time | Use `useRef` for current state in intervals | v2.10.7 |
| Cron duration unit mismatch | DB stores minutes; code treated as hours | `trip.estimatedDuration * 60 * 1000` | v2.10.14 |
| Zod null vs undefined | `searchParams.get()` returns null | Use `.nullish()` not `.optional()` | v2.10.5 |
| `parseInt` scientific notation | `parseInt("1e2")` returns 1 | Custom validator rejects `[eE]` | v2.10.x |

---

*End of Document 4.2.5 - Secure Coding Standard Documentation*
