# i-Ticket Platform - System Architecture Diagram

**Document**: 4.2.1b - System Architecture Diagram
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Deployment Architecture

i-Ticket uses a **cloud-hosted** deployment on AWS with Cloudflare as the CDN/WAF layer.

### 1.1 Infrastructure Overview

```
+====================================================================+
|                         INTERNET                                   |
|  Customers, Guests, Drivers, Staff, Telegram, TeleBirr, OsmAnd   |
+============================+=======================================+
                             |
                        DNS: i-ticket.et
                        (Cloudflare nameservers)
                             |
+============================+=======================================+
|                    CLOUDFLARE CDN / WAF                            |
|                                                                    |
|  Plan: Free                                                        |
|  SSL Mode: Full (Strict)                                          |
|  TLS Minimum: 1.2                                                 |
|  HSTS: Enabled (max-age=31536000, includeSubDomains, preload)     |
|  DDoS Protection: Automatic                                       |
|  Web Analytics: Enabled (beacon.min.js)                           |
|  Email Obfuscation: DISABLED (breaks React hydration)             |
|  Caching: Standard (static assets)                                |
|                                                                    |
|  Nameservers:                                                      |
|    - Cloudflare-assigned NS records                                |
|  DNS Records:                                                      |
|    - A record: i-ticket.et -> 54.147.33.168 (proxied)             |
|    - CNAME: www -> i-ticket.et (proxied)                           |
+============================+=======================================+
                             |
                        HTTPS (Cloudflare -> Origin)
                        (Cloudflare Origin Certificate)
                             |
+============================+=======================================+
|              AWS EC2 INSTANCE (t2.micro)                          |
|                                                                    |
|  IP: 54.147.33.168                                                |
|  Region: us-east-1                                                |
|  OS: Ubuntu 22.04 LTS                                             |
|  CPU: 1 vCPU                                                      |
|  RAM: 1 GB                                                        |
|  Storage: 7.6 GB EBS (General Purpose SSD)                       |
|  Security Group: SSH (22), HTTP (80), HTTPS (443)                 |
|                                                                    |
|  +--------------------------------------------------------------+ |
|  |                    NGINX REVERSE PROXY                        | |
|  |                                                                | |
|  |  Listen: Port 80 (HTTP)                                       | |
|  |  Upstream: localhost:3000                                      | |
|  |  Rate Limiting:                                                | |
|  |    - General: 100 req/min per IP                               | |
|  |    - API: 60 req/min per IP                                    | |
|  |  Max Body Size: 5 MB                                          | |
|  |  Server Tokens: OFF (version hidden)                          | |
|  |  Headers Stripped: Server, X-Powered-By                       | |
|  |  Keepalive: 64 connections to upstream                        | |
|  |  Proxy Timeouts: 60s (connect, send, read)                   | |
|  |  Static Assets: /_next/static cached 60min                   | |
|  +---------------------------+----------------------------------+ |
|                              |                                     |
|                         localhost:3000                              |
|                              |                                     |
|  +---------------------------+----------------------------------+ |
|  |              PM2 PROCESS MANAGER                              | |
|  |                                                                | |
|  |  App Name: i-ticket                                           | |
|  |  Mode: Cluster (1 instance for t2.micro)                      | |
|  |  Auto-restart: Yes                                            | |
|  |  Max Memory: 800 MB (restart threshold)                       | |
|  |  Kill Timeout: 5000ms (graceful shutdown)                     | |
|  |  Cron Restart: Daily at 03:00 UTC (memory leak prevention)   | |
|  |  Max Restarts: 10                                             | |
|  |  Min Uptime: 10s                                              | |
|  |  Logs: /var/log/pm2/i-ticket-{error,out}.log                 | |
|  |  Log Format: YYYY-MM-DD HH:mm:ss Z                           | |
|  +---------------------------+----------------------------------+ |
|                              |                                     |
|  +---------------------------+----------------------------------+ |
|  |            NODE.JS 20.20.0 / NEXT.JS 14                      | |
|  |                                                                | |
|  |  Runtime: Node.js 20.20.0 (LTS)                              | |
|  |  Framework: Next.js 14 (App Router)                           | |
|  |  Port: 3000                                                   | |
|  |  Environment: NODE_ENV=production                              | |
|  |  Working Dir: /var/www/i-ticket                               | |
|  +---------------------------+----------------------------------+ |
|                              |                                     |
|                         Prisma ORM                                 |
|                     (parameterized queries)                        |
|                              |                                     |
|  +---------------------------+----------------------------------+ |
|  |            POSTGRESQL 16.11                                   | |
|  |                                                                | |
|  |  Host: localhost                                              | |
|  |  Port: 5432                                                   | |
|  |  Connection: Unix socket (local)                              | |
|  |  Auth: Password (via DATABASE_URL)                            | |
|  |  Tables: 39 models                                            | |
|  |  Row-level Locking: SELECT FOR UPDATE NOWAIT                  | |
|  |  Transaction Timeouts: 10 seconds                             | |
|  +--------------------------------------------------------------+ |
|                                                                    |
+====================================================================+
```

### 1.2 Infrastructure Specifications

| Component | Specification |
|-----------|--------------|
| **Cloud Provider** | Amazon Web Services (AWS) |
| **Instance Type** | EC2 t2.micro (1 vCPU, 1 GB RAM) |
| **Region** | us-east-1 (N. Virginia) |
| **Public IP** | 54.147.33.168 |
| **Operating System** | Ubuntu 22.04 LTS |
| **Storage** | 7.6 GB EBS (General Purpose SSD gp2) |
| **Node.js** | v20.20.0 (LTS) |
| **Database** | PostgreSQL 16.11 (local) |
| **Process Manager** | PM2 (cluster mode, 1 instance) |
| **Reverse Proxy** | Nginx |
| **CDN / WAF** | Cloudflare (Free plan) |
| **SSL/TLS** | Cloudflare Full (Strict) mode, TLS 1.2 minimum |
| **Domain** | i-ticket.et (registered via .et registry) |
| **SSH Access** | Key-based only (mela-shared-key.pem), port 22 |

---

## 2. Component Architecture

### 2.1 Application Layer Stack

```
+====================================================================+
|                     NEXT.JS 14 APPLICATION                         |
|                                                                    |
|  +--------------------------------------------------------------+ |
|  |                    MIDDLEWARE LAYER                            | |
|  |  src/middleware.ts                                            | |
|  |                                                                | |
|  |  - Content-Security-Policy injection                          | |
|  |  - Cache-Control: no-store                                    | |
|  |  - Report-To / Reporting-Endpoints headers                   | |
|  |  - Applied to all page routes (excludes /api, /_next/static) | |
|  +--------------------------------------------------------------+ |
|                              |                                     |
|  +--------------------------------------------------------------+ |
|  |                  SECURITY HEADERS (next.config.js)            | |
|  |                                                                | |
|  |  All Routes:                                                  | |
|  |    Strict-Transport-Security (2yr, preload)                   | |
|  |    X-Frame-Options: DENY                                      | |
|  |    X-Content-Type-Options: nosniff                            | |
|  |    X-XSS-Protection: 1; mode=block                           | |
|  |    Referrer-Policy: strict-origin-when-cross-origin           | |
|  |    Permissions-Policy: camera=(), microphone=(),              | |
|  |      geolocation=(self), payment=(), usb=()                  | |
|  |    Cache-Control: no-store                                    | |
|  |    X-Powered-By: REMOVED (poweredByHeader: false)            | |
|  |                                                                | |
|  |  Auth Routes (/login, /admin, /company, etc.):               | |
|  |    Cache-Control: no-store, no-cache, must-revalidate,       | |
|  |      proxy-revalidate                                         | |
|  |    Expires: 0                                                 | |
|  +--------------------------------------------------------------+ |
|                              |                                     |
|  +---------------------------+----------------------------------+ |
|  |      FRONTEND (React 18)  |     BACKEND (API Routes)        | |
|  |                           |                                   | |
|  |  App Router Pages:        |  Authentication:                  | |
|  |   /(auth) - Login/Reg     |   /api/auth/[...nextauth]        | |
|  |   /(customer) - Booking   |   /api/auth/register             | |
|  |   /(company) - Dashboard  |   /api/auth/force-change-pwd     | |
|  |   /(admin) - Platform     |                                   | |
|  |   /(driver) - Tracking    |  Public:                          | |
|  |   /(staff) - Operations   |   /api/trips (search)            | |
|  |   /(cashier) - Sales      |   /api/track/[code]              | |
|  |   /(mechanic) - Fleet     |   /api/cities/coordinates        | |
|  |   /(finance) - Reports    |   /api/support/tickets           | |
|  |   /(sales) - Referrals    |                                   | |
|  |                           |  Booking & Payment:               | |
|  |  UI Components:           |   /api/bookings                   | |
|  |   shadcn/ui (Radix)       |   /api/payments                   | |
|  |   Tailwind CSS            |   /api/payments/telebirr/callback| |
|  |   Recharts (analytics)    |   /api/tickets/verify            | |
|  |   Leaflet (maps)          |                                   | |
|  |   Lucide (icons)          |  GPS Tracking:                    | |
|  |                           |   /api/tracking/update            | |
|  |  Client Libraries:        |   /api/tracking/osmand            | |
|  |   react-leaflet v4        |   /api/tracking/[tripId]         | |
|  |   date-fns                |   /api/tracking/fleet            | |
|  |   html2canvas             |   /api/tracking/generate-token   | |
|  |   canvas-confetti         |                                   | |
|  |                           |  Company Management:              | |
|  |                           |   /api/company/trips/*           | |
|  |                           |   /api/company/staff/*           | |
|  |                           |   /api/company/vehicles/*        | |
|  |                           |   /api/company/analytics/*       | |
|  |                           |   /api/company/reports/*         | |
|  |                           |                                   | |
|  |                           |  Admin Platform:                  | |
|  |                           |   /api/admin/stats               | |
|  |                           |   /api/admin/companies           | |
|  |                           |   /api/admin/trips               | |
|  |                           |   /api/admin/bookings            | |
|  |                           |                                   | |
|  |                           |  Webhooks (Inbound):             | |
|  |                           |   /api/telegram/webhook          | |
|  |                           |   /api/sms/incoming              | |
|  |                           |                                   | |
|  |                           |  Cron Jobs:                       | |
|  |                           |   /api/cron/cleanup              | |
|  |                           |   /api/cron/trip-reminders       | |
|  |                           |   /api/cron/predictive-maint     | |
|  |                           |   /api/cron/telegram-cleanup     | |
|  |                           |                                   | |
|  |                           |  Security:                        | |
|  |                           |   /api/csp-report                | |
|  +---------------------------+----------------------------------+ |
|                              |                                     |
|  +--------------------------------------------------------------+ |
|  |                   SHARED LIBRARIES (src/lib/)                 | |
|  |                                                                | |
|  |  auth.ts          - NextAuth config, rate limiting            | |
|  |  db.ts            - Prisma client singleton                   | |
|  |  rate-limit.ts    - In-memory rate limiter                    | |
|  |  commission.ts    - Commission & VAT calculation              | |
|  |  utils.ts         - Ethiopia timezone, formatting             | |
|  |  fuzzy-match.ts   - Levenshtein fuzzy search                 | |
|  |                                                                | |
|  |  payments/                                                    | |
|  |    telebirr.ts    - TeleBirr API client, HMAC signing        | |
|  |    callback-hash.ts - SHA256 callback deduplication           | |
|  |                                                                | |
|  |  sms/                                                         | |
|  |    gateway.ts     - SMS send/receive, webhook verification    | |
|  |                                                                | |
|  |  telegram/                                                    | |
|  |    bot.ts         - Telegram bot (Telegraf framework)         | |
|  |    messages.ts    - Bilingual message templates               | |
|  |    keyboards.ts   - Inline keyboard builders                  | |
|  |    middleware/auth.ts - Session management                    | |
|  |    handlers/      - Command, payment, ticket, tracking        | |
|  |    scenes/        - Booking wizard state machine              | |
|  |                                                                | |
|  |  tracking/                                                    | |
|  |    update-position.ts - Shared GPS processing logic           | |
|  |    audio-keep-alive.ts - Background GPS persistence           | |
|  |                                                                | |
|  |  ai/                                                          | |
|  |    predictive-maintenance.ts - Vehicle risk scoring           | |
|  |                                                                | |
|  |  clickup/                                                     | |
|  |    client.ts      - ClickUp API integration                  | |
|  +--------------------------------------------------------------+ |
|                              |                                     |
|  +--------------------------------------------------------------+ |
|  |                   DATA ACCESS (Prisma ORM)                    | |
|  |                                                                | |
|  |  - Parameterized queries (SQL injection prevention)           | |
|  |  - Transaction support with configurable timeouts             | |
|  |  - Row-level locking (SELECT FOR UPDATE NOWAIT)               | |
|  |  - Connection pooling (Prisma default pool)                   | |
|  |  - Schema migrations via `prisma db push`                     | |
|  +--------------------------------------------------------------+ |
+====================================================================+
```

### 2.2 Service-to-Service Communication

| Source | Destination | Protocol | Auth Method | Direction | Data Format |
|--------|-------------|----------|-------------|-----------|-------------|
| Next.js App | PostgreSQL | TCP/Unix socket | DATABASE_URL credential | Bidirectional | SQL (via Prisma) |
| Next.js App | TeleBirr API | HTTPS | HMAC-SHA256 (APP_KEY) | Outbound | JSON |
| TeleBirr API | Next.js App | HTTPS | HMAC-SHA256 signature | Inbound (callback) | JSON |
| Next.js App | SMS Gateway | HTTPS | Bearer token (API_KEY) | Outbound | JSON |
| SMS Gateway | Next.js App | HTTPS | HMAC-SHA256 (WEBHOOK_SECRET) | Inbound (webhook) | JSON |
| Telegram API | Next.js App | HTTPS | Telegram-signed | Inbound (webhook) | JSON |
| Next.js App | Telegram API | HTTPS | Bot token | Outbound | JSON |
| Next.js App | ClickUp API | HTTPS | API token (Bearer) | Outbound | JSON |
| Next.js App | OSRM API | HTTPS | None (public) | Outbound | JSON |
| Next.js App | Nominatim API | HTTPS | None (public) | Outbound | JSON |
| Browser (client) | OSM Tile Server | HTTPS | None (public) | Outbound | PNG tiles |
| Cron Scheduler | Next.js App | HTTPS | Bearer token (CRON_SECRET) | Inbound | None (GET) |
| OsmAnd App | Next.js App | HTTPS | Trip tracking token (query param) | Inbound | URL params |
| Browser (client) | Next.js App | HTTPS | JWT cookie (NextAuth) | Bidirectional | JSON |

### 2.3 Module Dependency Map

```
                          +------------------+
                          |   next.config.js |
                          | (Security Headers|
                          |  poweredBy:false)|
                          +--------+---------+
                                   |
                          +--------+---------+
                          |  middleware.ts    |
                          | (CSP, Cache-Ctrl)|
                          +--------+---------+
                                   |
            +----------------------+----------------------+
            |                                             |
   +--------+--------+                          +--------+--------+
   | Page Routes      |                          | API Routes      |
   | (React 18 SSR)   |                          | (Route Handlers)|
   +--------+---------+                          +--------+--------+
            |                                             |
            +----------------------+----------------------+
                                   |
                          +--------+---------+
                          |    src/lib/      |
                          |                  |
                          |  auth.ts --------+----> next-auth
                          |  db.ts ----------+----> @prisma/client
                          |  rate-limit.ts   |
                          |  commission.ts   |
                          |  utils.ts        |
                          +--------+---------+
                                   |
                     +-------------+-------------+
                     |             |             |
              +------+------+ +---+----+ +------+------+
              | payments/   | | sms/   | | telegram/   |
              | telebirr.ts | | gateway| | bot.ts      |
              | (HMAC-SHA256| | .ts    | | (Telegraf)  |
              | crypto)     | |        | |             |
              +------+------+ +---+----+ +------+------+
                     |             |             |
                     +-------------+-------------+
                                   |
                          +--------+---------+
                          |   Prisma ORM     |
                          | (parameterized   |
                          |  queries, txns)  |
                          +--------+---------+
                                   |
                          +--------+---------+
                          | PostgreSQL 16.11 |
                          | (39 tables)      |
                          +------------------+
```

---

## 3. Security Layers

### 3.1 Defense-in-Depth Architecture

```
LAYER 1: EDGE SECURITY (Cloudflare)
+====================================================================+
|  Cloudflare CDN / WAF                                              |
|  +--------------------------------------------------------------+ |
|  | TLS 1.2+ Termination (Full Strict mode)                      | |
|  | HSTS: max-age=31536000; includeSubDomains; preload           | |
|  | DDoS Protection (automatic)                                   | |
|  | Bot Management (basic)                                        | |
|  | Web Analytics Beacon                                          | |
|  | Email Obfuscation: DISABLED (React hydration conflict)       | |
|  | Origin Certificate: Cloudflare-issued                        | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 2: NETWORK SECURITY (Nginx)
+====================================================================+
|  Nginx Reverse Proxy                                               |
|  +--------------------------------------------------------------+ |
|  | Rate Limiting: 100 req/min (general), 60 req/min (API)       | |
|  | Server Header: STRIPPED (server_tokens off)                   | |
|  | X-Powered-By: STRIPPED                                        | |
|  | Client Max Body Size: 5 MB                                   | |
|  | Proxy Headers: X-Real-IP, X-Forwarded-For, X-Forwarded-Proto | |
|  | Keepalive Connections: 64 to upstream                        | |
|  | Timeouts: 60s connect/send/read                              | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 3: APPLICATION SECURITY (Next.js Middleware)
+====================================================================+
|  Next.js Middleware (src/middleware.ts)                             |
|  +--------------------------------------------------------------+ |
|  | Content-Security-Policy:                                      | |
|  |   default-src 'self'                                          | |
|  |   script-src 'self' 'unsafe-inline'                           | |
|  |     https://static.cloudflareinsights.com                     | |
|  |   style-src 'self' 'unsafe-inline'                            | |
|  |     https://fonts.googleapis.com                               | |
|  |   img-src 'self' data: https://api.qrserver.com              | |
|  |     https://*.tile.openstreetmap.org https://unpkg.com        | |
|  |   font-src 'self' data: https://fonts.gstatic.com            | |
|  |   connect-src 'self' https://api.telebirr.com                | |
|  |     https://api.webirr.com https://*.tile.openstreetmap.org  | |
|  |     https://nominatim.openstreetmap.org                       | |
|  |     https://cloudflareinsights.com                            | |
|  |     https://router.project-osrm.org                           | |
|  |   media-src 'self' data: blob:                                | |
|  |   frame-ancestors 'none'                                      | |
|  |   base-uri 'self'                                             | |
|  |   form-action 'self'                                          | |
|  |   object-src 'none'                                           | |
|  |   upgrade-insecure-requests                                   | |
|  |   report-uri /api/csp-report                                  | |
|  |                                                                | |
|  | Cache-Control: no-store                                       | |
|  | Pragma: no-cache                                              | |
|  | CSP Violation Reporting: /api/csp-report (logged to PM2)     | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 4: APPLICATION SECURITY (next.config.js Headers)
+====================================================================+
|  Static Security Headers                                           |
|  +--------------------------------------------------------------+ |
|  | Strict-Transport-Security: max-age=63072000; includeSubDomains| |
|  |   preload (2 years)                                           | |
|  | X-Frame-Options: DENY                                         | |
|  | X-Content-Type-Options: nosniff                               | |
|  | X-XSS-Protection: 1; mode=block                              | |
|  | Referrer-Policy: strict-origin-when-cross-origin              | |
|  | Permissions-Policy: camera=(), microphone=(),                 | |
|  |   geolocation=(self), payment=(), usb=(), bluetooth=(),      | |
|  |   magnetometer=(), gyroscope=(), accelerometer=()             | |
|  | X-Powered-By: REMOVED                                        | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 5: AUTHENTICATION & AUTHORIZATION
+====================================================================+
|  NextAuth.js (Credentials Provider)                                |
|  +--------------------------------------------------------------+ |
|  | Strategy: JWT (stateless, 30-day maxAge)                      | |
|  | Cookie: httpOnly, secure, sameSite=lax, path=/                | |
|  | Password: bcryptjs (12 salt rounds)                           | |
|  | Secret: NEXTAUTH_SECRET (min 32 chars, validated at startup)  | |
|  | Production Guard: rejects placeholder secrets                 | |
|  |                                                                | |
|  | Rate Limiting (In-Memory):                                    | |
|  |   Login: 5 attempts/30min per phone (15min lockout)           | |
|  |   Login: 10 attempts/15min per IP                             | |
|  |   Register: 3/hour per IP                                     | |
|  |   Booking: 10/min per IP                                      | |
|  |   Payment: 3/hour per booking                                 | |
|  |   Password Reset: 3/hour per IP                               | |
|  |   Store: 100K max entries, emergency cleanup at 80%           | |
|  |                                                                | |
|  | Role-Based Access Control (RBAC):                             | |
|  |   Roles: CUSTOMER, COMPANY_ADMIN, SUPER_ADMIN                | |
|  |   Staff Roles: ADMIN, DRIVER, CONDUCTOR, MANUAL_TICKETER,    | |
|  |     MECHANIC, FINANCE                                         | |
|  |   Company Segregation: All company APIs filter by companyId  | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 6: INPUT VALIDATION
+====================================================================+
|  Zod Schema Validation                                             |
|  +--------------------------------------------------------------+ |
|  | All API inputs validated with Zod schemas                     | |
|  | Server-side amount recalculation (never trust client)         | |
|  | Phone format: /^09\d{8}$/ (Ethiopian format)                 | |
|  | parseInt validation (rejects scientific notation)             | |
|  | .nullish() for searchParams (returns null, not undefined)     | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 7: PAYMENT SECURITY
+====================================================================+
|  TeleBirr Integration Security                                     |
|  +--------------------------------------------------------------+ |
|  | Outbound: HMAC-SHA256 signed requests (APP_KEY)              | |
|  | Inbound Callback Verification:                                | |
|  |   1. SHA-256 callback hash computation                        | |
|  |   2. Replay detection (ProcessedCallback table)               | |
|  |   3. HMAC-SHA256 signature (crypto.timingSafeEqual)           | |
|  |   4. Timestamp validation (5-minute window)                   | |
|  |   5. Optional IP whitelist (TELEBIRR_WEBHOOK_IPS)            | |
|  | Nonces: crypto.randomBytes(16)                                | |
|  | Idempotency: unique transactionId + callbackHash indexes     | |
|  | Demo Mode: blocked in NODE_ENV=production                    | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 8: DATABASE SECURITY
+====================================================================+
|  PostgreSQL 16.11 + Prisma ORM                                     |
|  +--------------------------------------------------------------+ |
|  | Parameterized queries (Prisma ORM - SQL injection prevention)| |
|  | Row-level locking: SELECT FOR UPDATE NOWAIT                   | |
|  | Transaction timeouts: 10s (dual: Promise.race + Prisma native)| |
|  | Transaction max wait: 5s                                      | |
|  | Passwords: bcrypt hashed (never plaintext)                    | |
|  | Reset tokens: bcrypt hashed before storage                    | |
|  | Connection: localhost only (no external access)               | |
|  | Logging: errors only in production                            | |
|  +--------------------------------------------------------------+ |
+====================================================================+
                             |
LAYER 9: AUDIT & MONITORING
+====================================================================+
|  Audit Trail & Logging                                             |
|  +--------------------------------------------------------------+ |
|  | AdminLog: all sensitive operations logged with userId, action,| |
|  |   details, tripId, companyId, timestamp                       | |
|  | ProcessedCallback: payment callback audit trail               | |
|  | CSP Violation Reports: logged to PM2 via /api/csp-report     | |
|  | PM2 Logs: /var/log/pm2/i-ticket-{error,out}.log              | |
|  | Nginx Logs: access.log, error.log                            | |
|  | Cloudflare: Web Analytics, security events                   | |
|  +--------------------------------------------------------------+ |
+====================================================================+
```

### 3.2 Security Controls Matrix

| Control Category | Implementation | Standard |
|-----------------|----------------|----------|
| **TLS/SSL** | Cloudflare Full Strict, TLS 1.2 minimum, HSTS preload | OWASP A02, NIST SP 800-52 |
| **WAF/DDoS** | Cloudflare automatic DDoS protection | OWASP A06 |
| **Rate Limiting** | 3-tier: Cloudflare -> Nginx -> Application | OWASP A04 |
| **CSP** | Strict policy with report-uri, frame-ancestors 'none' | OWASP A03 |
| **Authentication** | bcrypt passwords, JWT sessions, rate-limited login | OWASP A07 |
| **Authorization** | RBAC with company segregation, staff sub-roles | OWASP A01 |
| **Input Validation** | Zod schemas on all API inputs | OWASP A03 |
| **SQL Injection** | Prisma ORM (parameterized queries) | OWASP A03 |
| **XSS** | React auto-escaping + CSP | OWASP A03 |
| **CSRF** | SameSite=lax cookies + form-action CSP | OWASP A01 |
| **Clickjacking** | X-Frame-Options: DENY + frame-ancestors 'none' | OWASP A05 |
| **MIME Sniffing** | X-Content-Type-Options: nosniff | OWASP A05 |
| **Information Disclosure** | X-Powered-By removed, server_tokens off | OWASP A05 |
| **Payment Replay** | HMAC-SHA256 + timing-safe compare + idempotency table | OWASP A08 |
| **Data Integrity** | Row-level locking, transaction timeouts, server-side recalculation | OWASP A08 |
| **Audit Trail** | AdminLog table, PM2 logs, CSP reports | OWASP A09 |
| **Session Management** | httpOnly, secure, sameSite=lax, 30-day maxAge | OWASP A07 |
| **Error Handling** | Production: errors-only logging, no stack traces to client | OWASP A09 |
| **Dependency Security** | glob override for known vuln, Dependabot alerts | OWASP A06 |

### 3.3 Network Diagram

```
+============================================================+
|                     INTERNET                                |
|                                                              |
|  +----------+  +----------+  +---------+  +-------------+  |
|  | Customer  |  | TeleBirr |  |Telegram |  | OsmAnd/     |  |
|  | Browser   |  | API      |  |Bot API  |  | SMS Gateway |  |
|  +-----+----+  +----+-----+  +----+----+  +------+------+  |
|        |             |             |              |          |
+========|=============|=============|==============|==========+
         |             |             |              |
    HTTPS/TLS 1.2+    |             |              |
         |             |             |              |
+========|=============|=============|==============|==========+
| CLOUDFLARE          SSL Termination (Full Strict)           |
| - DDoS protection   - HSTS preload                          |
| - Web Analytics      - TLS 1.2 minimum                      |
+========|=============|=============|==============|==========+
         |             |             |              |
    HTTPS to origin    |             |              |
         |             |             |              |
+========|=============|=============|==============|==========+
| AWS EC2 (54.147.33.168)                                     |
| Security Group: 22 (SSH), 80 (HTTP), 443 (HTTPS)           |
|                                                              |
| +----------------------------------------------------------+|
| | NGINX (Port 80)                                          ||
| | Rate Limit: 100r/m general, 60r/m API                   ||
| +----------------------------+-----------------------------+|
|                              |                               |
| +----------------------------+-----------------------------+|
| | NODE.JS / NEXT.JS 14 (Port 3000)                        ||
| |                                                          ||
| | +------------------+  +--------------------------------+ ||
| | | Middleware (CSP)  |  | API Route Handlers             | ||
| | +------------------+  |  - Zod validation               | ||
| | | Page Routes       |  |  - Rate limiting               | ||
| | | (React 18 SSR)    |  |  - Auth checks (NextAuth)      | ||
| | +------------------+  |  - Company segregation          | ||
| |                       +--------------------------------+ ||
| +----------------------------+-----------------------------+|
|                              |                               |
| +----------------------------+-----------------------------+|
| | POSTGRESQL 16.11 (localhost:5432)                        ||
| | - 39 tables, row-level locking, transaction timeouts     ||
| +----------------------------------------------------------+|
+==============================================================+
         |
    SSH (Port 22, key-based only)
         |
+========|========+
| Admin Operator  |
| (mela-shared-   |
|  key.pem)       |
+-----------------+
```

---

## 4. Technology Stack Summary

### 4.1 Backend

| Component | Technology | Version |
|-----------|-----------|---------|
| Runtime | Node.js | 20.20.0 |
| Framework | Next.js (App Router) | 14.2.x |
| Language | TypeScript | 5.3.x |
| Database | PostgreSQL | 16.11 |
| ORM | Prisma | 5.10.x |
| Authentication | NextAuth.js | 4.24.x |
| Validation | Zod | 3.25.x |
| Password Hashing | bcryptjs | 2.4.3 |
| Telegram Bot | Telegraf | 4.16.3 |
| Excel Reports | ExcelJS | 4.4.0 |
| QR Generation | qrcode | 1.5.3 |
| XML Parsing | fast-xml-parser | 5.3.3 |

### 4.2 Frontend

| Component | Technology | Version |
|-----------|-----------|---------|
| UI Framework | React | 18.2.x |
| CSS Framework | Tailwind CSS | 3.4.x |
| Component Library | shadcn/ui (Radix UI primitives) | Various |
| Maps | Leaflet + react-leaflet | 1.9.4 / 4.2.1 |
| Charts | Recharts | 3.7.0 |
| Icons | Lucide React | 0.344.x |
| Date Utilities | date-fns | 4.1.x |
| CSV Parsing | PapaParse | 5.4.1 |

### 4.3 Infrastructure

| Component | Technology | Details |
|-----------|-----------|---------|
| Cloud | AWS EC2 | t2.micro, us-east-1 |
| OS | Ubuntu | 22.04 LTS |
| Reverse Proxy | Nginx | With rate limiting |
| Process Manager | PM2 | Cluster mode |
| CDN / WAF | Cloudflare | Free plan, Full Strict SSL |
| DNS | Cloudflare | Proxied A record |
| Monitoring | PM2 logs + Cloudflare Analytics | Error/access logs |
| PWA | Service Worker | Network-first, v2 cache |

### 4.4 External Services

| Service | Provider | Purpose | Protocol |
|---------|----------|---------|----------|
| Payment Gateway | TeleBirr (Ethio Telecom) | Mobile money payments | HTTPS REST, HMAC-SHA256 |
| SMS Gateway | Negarit / GeezSMS | Ticket delivery, booking, reminders | HTTPS REST, Bearer token |
| Messaging | Telegram Bot API | Bot-based booking, tracking | HTTPS Webhook |
| Project Mgmt | ClickUp | Support tickets, alerts | HTTPS REST, API token |
| Map Tiles | OpenStreetMap | Map rendering | HTTPS (public CDN) |
| Routing | OSRM | Road route geometry | HTTPS (public API) |
| Geocoding | Nominatim | Reverse geocoding | HTTPS (public API) |
| Analytics | Cloudflare Web Analytics | Traffic analytics | Client-side beacon |

---

## 5. Service Worker (PWA)

| Property | Value |
|----------|-------|
| File | `/public/sw.js` |
| Cache Name | `i-ticket-v2` |
| Strategy | Network-first, cache fallback |
| Scope | Same-origin only (cross-origin requests skipped) |
| API Requests | Always network (never cached) |
| POST/PUT/DELETE | Never cached |
| Install | `skipWaiting()` (immediate activation) |
| Activate | `clients.claim()` + old cache purge |

---

## 6. Process Manager Configuration

| Property | Value |
|----------|-------|
| Manager | PM2 |
| App Name | `i-ticket` |
| Exec Mode | Cluster |
| Instances | 1 (limited by t2.micro 1GB RAM) |
| Max Memory | 800 MB (restart threshold) |
| Auto-Restart | Yes |
| Max Restarts | 10 |
| Min Uptime | 10 seconds |
| Kill Timeout | 5000ms (graceful shutdown) |
| Cron Restart | Daily at 03:00 UTC (memory management) |
| Error Log | `/var/log/pm2/i-ticket-error.log` |
| Output Log | `/var/log/pm2/i-ticket-out.log` |
| Log Format | `YYYY-MM-DD HH:mm:ss Z` |

---

*End of Document 4.2.1b - System Architecture Diagram*
