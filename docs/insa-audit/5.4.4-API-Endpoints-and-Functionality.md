# i-Ticket Platform - API Endpoints and Functionality

**Document**: 5.4.4 - API Endpoints and Functionality
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Overview

This document describes the functional behavior of each API endpoint group — what business logic executes, what side effects occur, and what security controls are enforced. For request/response schemas, see Document 5.4.3 (API Types). For sample payloads, see Document 5.4.1 (API Request/Response Samples).

**Base URL**: `https://i-ticket.et/api`

---

## 2. Authentication Endpoints

### 2.1 POST `/api/auth/[...nextauth]` — Login

**Functionality**:
1. Receives phone + password credentials
2. Looks up user by normalized phone number
3. Compares password with bcrypt hash using timing-safe comparison
4. Checks `mustChangePassword` flag (forces redirect for staff first login)
5. Creates JWT session token with minimal claims (id, role, companyId, staffRole)
6. Sets `httpOnly`, `secure`, `sameSite: lax` cookie (30-day expiry)

**Security Controls**: Rate limited (5/15min per phone, 10/15min per IP). No user enumeration — same error message for wrong phone or wrong password.

### 2.2 POST `/api/auth/register` — Registration

**Functionality**:
1. Validates input with Zod (name, phone, email, password)
2. Password strength check: 8-72 chars, uppercase + lowercase + digit
3. Checks for duplicate phone number
4. Hashes password with bcrypt (12 salt rounds)
5. Creates User with role `CUSTOMER` (or `SALES_PERSON` if referral code provided)
6. If sales person registration: validates recruiter referral code, creates SalesPerson record with referral chain

**Security Controls**: Rate limited (3/hr per IP). Phone format validated. Password never stored in plaintext.

### 2.3 POST `/api/auth/forgot-password` — Request Reset

**Functionality**:
1. Receives phone number
2. Generates crypto-random 32-byte token
3. Hashes token with bcrypt before storage (prevents DB-leaked tokens from being usable)
4. Stores hashed token with 1-hour expiry
5. Sends SMS with reset link containing raw token

**Security Controls**: Rate limited (3/hr per IP). Same response regardless of phone existence (prevents enumeration).

### 2.4 POST `/api/auth/reset-password` — Complete Reset

**Functionality**:
1. Receives token + new password
2. Looks up user with non-expired reset token
3. Compares received token against stored bcrypt hash
4. Updates password (new bcrypt hash, 12 rounds)
5. Clears reset token fields

**Security Controls**: Token is one-time use. Password strength enforced. Token expires after 1 hour.

### 2.5 POST `/api/auth/force-change-password`

**Functionality**: Allows staff members with `mustChangePassword: true` to set a new password on first login. Clears the forced-change flag after successful update.

---

## 3. Booking Endpoints

### 3.1 POST `/api/bookings` — Create Booking

**Functionality**:
1. Validates passenger data (1-10 passengers, max 3 children with adult required)
2. Identifies user: NextAuth session, SMS session, or guest (creates guest user from first passenger's phone)
3. Blocks company admins and super admins from booking
4. Opens transaction with 10-second timeout
5. Acquires row lock on trip (`SELECT FOR UPDATE NOWAIT`) — prevents race conditions
6. Validates trip: must be `SCHEDULED`, `BOARDING`, or `DELAYED`; must have enough available slots
7. Assigns seat numbers (manual selection or auto-assign)
8. Creates Booking (status `PENDING`), Passenger records, Payment record (status `PENDING`)
9. Decrements `Trip.availableSlots` atomically
10. Checks auto-halt threshold: if `availableSlots <= 10` and auto-halt enabled, sets `bookingHalted = true`
11. Logs `BOOKING_CREATED` to AdminLog

**Side Effects**: Creates Notification for user. Starts 10-minute payment countdown.

**Security Controls**: Rate limited (10/min). Row-level DB locking. Server-side amount calculation. Company admin/super admin booking blocked. Transaction timeout prevents deadlocks.

### 3.2 GET `/api/bookings` — List Own Bookings

**Functionality**: Returns authenticated user's bookings with optional status filter. Includes trip, passenger, payment, and ticket details. Users can only see their own bookings.

### 3.3 PATCH `/api/bookings/[bookingId]` — Cancel Booking

**Functionality**:
1. Verifies ownership (user's booking or admin)
2. Only PENDING bookings can be cancelled
3. Opens transaction: cancels booking, releases slots (`availableSlots += passengerCount`)
4. If trip was auto-halted and slots now above threshold, resumes booking

---

## 4. Payment Endpoints

### 4.1 POST `/api/payments` — Process Payment

**Functionality**:
1. Validates booking ownership
2. Checks 10-minute payment window (rejects expired bookings)
3. **Server-side amount recalculation**: recomputes total from trip price × passengers + commission + VAT (never trusts client amount)
4. For DEMO mode: instantly marks payment SUCCESS
5. For TELEBIRR mode: initiates TeleBirr API call with HMAC-SHA256 signed request
6. On success: marks Booking PAID, generates QR-code Tickets (unique short codes), creates SalesCommission records
7. Sends SMS confirmation with ticket short codes to each passenger

**Security Controls**: Rate limited (5/min per IP, 3/booking/hr). Amount recalculated server-side. Payment replay protection via status check. Transaction-safe with row locking.

### 4.2 POST `/api/payments/telebirr/callback` — TeleBirr Webhook

**Functionality** (5-gate verification):
1. **Gate 1 — Hash Check**: Computes SHA-256 hash of raw payload
2. **Gate 2 — Replay Protection**: Checks `ProcessedCallback` table for duplicate callback hash
3. **Gate 3 — HMAC Verification**: `crypto.timingSafeEqual()` with `TELEBIRR_APP_KEY`
4. **Gate 4 — Timestamp Check**: Rejects callbacks older than 5 minutes
5. **Gate 5 — IP Whitelist** (optional): Checks `TELEBIRR_WEBHOOK_IPS` if configured
6. On SUCCESS: updates Payment, marks Booking PAID, generates Tickets, sends SMS
7. On FAILURE: marks Payment FAILED, cancels Booking, releases slots

**Security Controls**: HMAC-SHA256 signature, timing-safe comparison, replay protection, timestamp validation, optional IP whitelist. All writes in transaction.

---

## 5. Ticket Verification Endpoints

### 5.1 POST `/api/tickets/verify` — Verify Ticket

**Functionality**:
1. Receives ticket short code (case-insensitive)
2. Looks up ticket with booking, trip, and passenger data
3. Validates: booking must be PAID, ticket must not be already used
4. Enforces company segregation (verifier's company must match trip's company)
5. Returns ticket validity + passenger details

**Security Controls**: Company segregation. Case-insensitive lookup. AdminLog entry.

### 5.2 PATCH `/api/tickets/verify` — Mark Ticket Used

**Functionality**:
1. Sets `ticket.isUsed = true`, `ticket.usedAt = now`
2. Auto-sets matching passenger `boardingStatus = "BOARDED"`
3. If passenger was previously marked `NO_SHOW`, returns warning (late arrival edge case)
4. Logs `TICKET_USED` to AdminLog

---

## 6. GPS Tracking Endpoints

### 6.1 POST `/api/tracking/update` — Browser GPS

**Functionality**:
1. Validates GPS coordinates (lat -90/90, lon -180/180)
2. Verifies user is assigned driver/conductor on the trip, or is admin
3. Trip must be in `DEPARTED` status
4. Delegates to shared `processPositionUpdate()`:
   - Creates `TripPosition` record (GPS history)
   - Updates `Trip.lastLatitude`, `lastLongitude`, `lastSpeed`, `lastPositionAt`
   - Updates `Vehicle.lastLatitude`, `lastLongitude`, `lastPositionAt`
   - Calculates ETA using Haversine distance + 1.3 winding factor
5. Returns estimated arrival time

**Security Controls**: Rate limited (12/min). Auth required. Trip assignment verified.

### 6.2 GET `/api/tracking/osmand` — OsmAnd Background GPS

**Functionality**: Same as browser GPS but uses token-based auth for headless OsmAnd app. Returns plain text status codes (OsmAnd stops retrying on non-200, so all responses are HTTP 200 with text status).

**Security Controls**: Token validated against `Trip.trackingToken`. Rate limited (12/min). Token is 256-bit random hex.

### 6.3 GET `/api/tracking/[tripId]` — Public Bus Position

**Functionality**: Returns current bus position, speed, ETA, and GPS trail history for departed trips. Available to all passengers for live tracking.

**Security Controls**: Rate limited (30/min per IP). No sensitive data exposed (no driver phone, no passenger info).

### 6.4 GET `/api/tracking/fleet` — Company Fleet Map

**Functionality**: Returns all currently DEPARTED trips with GPS data for the authenticated company. Includes driver info, vehicle info, occupancy percentage, and tracking status (live/stale/off).

**Security Controls**: Company segregation enforced. Only company admin access.

---

## 7. No-Show Management Endpoints

### 7.1 GET `/api/company/trips/[tripId]/boarding-status`

**Functionality**: Returns all passengers for a trip with their boarding status (PENDING/BOARDED/NO_SHOW), seat numbers, pickup/dropoff locations, ticket codes, and whether they're replacement passengers. Includes summary counts.

**Security Controls**: Company segregation. Only BOARDING or DEPARTED trips.

### 7.2 POST `/api/company/trips/[tripId]/no-show` — Mark No-Shows

**Functionality**:
1. Trip must be `DEPARTED` (intermediate stops mean passengers may board later at stops)
2. Validates passenger IDs belong to this trip
3. For each passenger:
   - Skips if already `NO_SHOW` (idempotent)
   - Skips if `BOARDED` (ticket already scanned)
   - Skips if ticket already used
   - Sets `boardingStatus = "NO_SHOW"`
4. Updates `Trip.noShowCount` and `Trip.releasedSeats` counters in transaction
5. Logs `PASSENGER_NO_SHOW` to AdminLog

**Security Controls**: Trip status guard (DEPARTED only). Company segregation. Ticket-used check. Idempotent. Transaction-safe.

### 7.3 POST `/api/company/trips/[tripId]/replacement-ticket` — Sell Replacement

**Functionality**:
1. Trip must be `DEPARTED`
2. Checks `releasedSeats >= passengerCount` (can't sell more replacements than no-shows minus already replaced)
3. Opens transaction:
   - Creates Booking (`isReplacement = true`, `replacedPassengerId` for audit)
   - Creates Passenger records with `boardingStatus = "BOARDED"` immediately
   - Auto-assigns seat numbers from no-show passengers' seats
   - Creates Payment (CASH, SUCCESS), Tickets with QR codes
   - Updates `Trip.replacementsSold` counter
   - Recalculates `Trip.releasedSeats = noShowCount - replacementsSold`
4. Commission = 0 (replacement sales generate no platform commission)
5. Logs `REPLACEMENT_TICKET_SALE` to AdminLog

**Security Controls**: Company segregation. Released seat cap. Staff/cashier only (not online). CASH only. `availableSlots` never modified. Transaction-safe with row locking.

---

## 8. Company Trip Management Endpoints

### 8.1 POST `/api/company/trips` — Create Trip

**Functionality**:
1. Validates all fields (origin, destination, departure time, driver, conductor, vehicle)
2. Checks staff/vehicle availability (no scheduling conflicts unless override flags set)
3. Vehicle risk check: if risk score >= 85, requires pre-trip inspection or override with reason
4. Creates trip with `SCHEDULED` status, sets `availableSlots = totalSlots`
5. Logs `TRIP_CREATED` to AdminLog

**Security Controls**: Company segregation. Staff conflict detection. Vehicle risk warnings.

### 8.2 POST `/api/company/trips/[tripId]/status` — Update Trip Status

**Functionality**:
1. Validates status transition is valid (e.g., can't go COMPLETED → SCHEDULED)
2. On `DEPARTED`:
   - Sets `actualDepartureTime`, activates GPS tracking
   - Auto-generates manifest if not already generated
   - Updates assigned staff status to `ON_TRIP`
3. On `COMPLETED`:
   - Sets `actualArrivalTime`, deactivates GPS tracking
   - Resets staff status to `AVAILABLE`
   - Shows odometer log popup for driver
4. On `CANCELLED`: Releases all unpaid booking slots, sends notifications
5. Pre-trip safety check: if vehicle risk score >= 70, warns; >= 85, requires recent inspection or explicit override

**Security Controls**: Status transition validation. Company segregation. Pre-trip safety checks. AdminLog entries.

### 8.3 POST `/api/company/trips/[tripId]/manual-ticket` — Manual Sale

**Functionality**: Creates instant PAID booking with CASH payment. Used by staff/cashiers at bus stations. No slot restriction (can sell to 0 available slots — manual ticketing is never blocked). Commission = 0.

### 8.4 POST `/api/company/trips/[tripId]/toggle-booking` — Halt/Resume

**Functionality**: Toggles `Trip.bookingHalted` flag. When halted, online booking is blocked but manual ticketing continues. Used for crowd control or when trip is nearly full.

---

## 9. Vehicle & Fleet Management Endpoints

### 9.1 CRUD `/api/company/vehicles/`

**Functionality**: Full vehicle lifecycle management. License plate validation (Ethiopian format). Auto-creates `VehicleDowntime` records when status changes to/from `MAINTENANCE`. Tracks odometer, fuel capacity, service dates, insurance/registration expiry.

### 9.2 Maintenance Schedules

**Functionality**: Recurring maintenance task definitions with kilometer and/or day intervals. Can auto-create work orders when thresholds are met. Tracks estimated duration and cost.

### 9.3 Work Orders

**Functionality**: Full work order lifecycle (OPEN → IN_PROGRESS → COMPLETED). Multi-role collaboration: admin creates, mechanic executes, finance approves costs. Supports parts tracking, messaging, and Excel export.

### 9.4 Vehicle Inspections

**Functionality**: Pre-trip, post-trip, daily, weekly, annual, and safety inspections. Checklist-based with pass/fail/defects. Links to trip safety checks (risk score integration).

### 9.5 Fuel Entries

**Functionality**: Fuel consumption logging with odometer-based efficiency calculation (L/100km). Supports multiple fuel types and payment methods.

---

## 10. Fleet Analytics Endpoints

All analytics endpoints: `GET /api/company/analytics/*`

| Endpoint | Functionality |
|----------|---------------|
| `fleet-health` | Aggregated fleet risk scores, health gauge (0-100), vehicle-level risk breakdown |
| `risk-trends` | Historical risk score snapshots from `VehicleRiskHistory` (daily cron snapshots) |
| `cost-forecast` | Predicted maintenance costs based on historical spending patterns and scheduled tasks |
| `failure-timeline` | Upcoming predicted component failures based on mileage, age, and maintenance history |
| `vehicle-comparison` | Side-by-side metrics for selected vehicles (cost, downtime, utilization) |
| `maintenance-windows` | Optimal scheduling windows based on trip schedules and vehicle availability |
| `route-wear` | Route-based wear analysis correlating trip routes with vehicle maintenance needs |
| `compliance-calendar` | Upcoming inspection due dates, registration/insurance expiries, overdue items |
| `bookings` | Booking volume, conversion rates, channel breakdown (web/SMS/Telegram) |
| `passengers` | Passenger demographics, repeat customer rate, average group size |
| `revenue` | Revenue trends, daily/weekly/monthly aggregates, route profitability |
| `routes` | Route performance: occupancy rates, cancellation rates, popular routes |

**Security Controls**: All require `COMPANY_ADMIN` auth. Data scoped to authenticated company only.

---

## 11. Company Reports Endpoints

| Endpoint | Functionality | Export |
|----------|---------------|--------|
| `reports/maintenance` | Maintenance costs by vehicle, category, time period | Excel |
| `reports/vehicle-tco` | Total Cost of Ownership per vehicle (purchase + maintenance + fuel + downtime) | — |
| `reports/downtime` | Vehicle downtime hours/days, causes, impact on operations | — |
| `reports/fleet-analytics/export` | Comprehensive fleet analytics data dump | Excel |
| `reports/staff-trips` | Staff trip assignments, completion rates, performance | — |

---

## 12. Super Admin Endpoints

### 12.1 GET `/api/admin/stats` — Platform Dashboard

**Functionality**: Returns comprehensive platform-wide statistics:
- User counts (total, customers, company admins, guests, new today)
- Company counts (active, inactive)
- Trip counts (by status)
- Booking counts (total, paid, pending, cancelled, today)
- Revenue (total, today, yesterday, this week, this month, commissions, VAT)
- Channel breakdown (web, SMS, Telegram)
- Payment method breakdown (TeleBirr, demo, cash)
- Business insights (average booking value, cancellation rate, success rate, peak hours)
- Recent bookings list

### 12.2 Company Management (`/api/admin/companies`)

**Functionality**: Create, read, update, deactivate companies. Company creation auto-creates admin user with temporary password. Deactivation requires written reason (10-500 chars) and logs to AdminLog.

### 12.3 Admin Analytics (`/api/admin/analytics/*`)

| Endpoint | Functionality |
|----------|---------------|
| `revenue` | Platform-wide revenue analytics |
| `platform-revenue` | Commission + VAT breakdown, TeleBirr fee impact |
| `monthly-trends` | Month-over-month growth metrics |
| `budget-progress` | Revenue vs targets |
| `top-companies` | Companies ranked by booking volume/revenue |
| `top-routes` | Routes ranked by popularity/revenue |
| `sales-commissions` | Sales agent commission tracking |
| `settlements` | Company settlement (payout) analytics |

---

## 13. Portal Endpoints

### 13.1 Cashier Portal (`/api/cashier/`)

**Functionality**: View assigned trips, sell manual tickets (CASH only), view trip passenger lists. Can sell tickets even when `availableSlots = 0` (manual ticketing never blocked).

### 13.2 Staff Portal (`/api/staff/`)

**Functionality**: View assigned trips, update trip status (board, depart, complete), manage work orders assigned to them, submit field repair reports.

### 13.3 Mechanic Portal (`/api/mechanic/`)

**Functionality**: View and update assigned work orders, track parts, communicate with admin/finance via work order messages.

### 13.4 Finance Portal (`/api/finance/`)

**Functionality**: Review work order costs, approve/reject expenditures, view financial summaries of maintenance spending.

### 13.5 Sales Portal (`/api/sales/`)

**Functionality**: View commission history, referral tracking, team management (recruited sub-agents), QR code generation for referral links, profile/payment info management.

---

## 14. Cron Job Endpoints

### 14.1 POST `/api/cron/cleanup` — Automated Cleanup

**Runs**: Every 5 minutes (PM2 cron or external scheduler)

**Operations** (in order):
1. Delete expired SMS sessions
2. Timeout SMS payments older than 5 minutes → cancel booking, release slots, send SMS
3. Cancel stale PENDING bookings older than 10 minutes → release slots
4. Auto-DELAYED: SCHEDULED trips 30+ minutes past departure time
5. Auto-DEPARTED: SCHEDULED/BOARDING/DELAYED trips past departure (DELAYED waits 1 hour extra)
6. Auto-COMPLETED: DEPARTED trips past `estimatedDuration + 2 hour` buffer
7. Auto-CANCELLED: SCHEDULED/BOARDING trips 24+ hours past with zero bookings
8. Reset staff status: drivers/conductors with no active trips → `AVAILABLE`
9. Purge GPS positions: delete `TripPosition` records >7 days old for COMPLETED/CANCELLED trips

**Security Controls**: Requires `CRON_SECRET` bearer token. All timezone calculations use Ethiopia time.

### 14.2 GET `/api/cron/trip-reminders` — SMS Reminders

**Runs**: Hourly. Sends SMS reminders to passengers with upcoming departures.

### 14.3 GET `/api/cron/predictive-maintenance` — AI Risk Snapshots

**Runs**: Daily. Calculates vehicle risk scores and stores in `VehicleRiskHistory` for trend analysis.

### 14.4 GET `/api/cron/telegram-cleanup` — Session Cleanup

**Runs**: Every 30 minutes. Deletes expired Telegram bot sessions (30-minute timeout).

---

## 15. Webhook Endpoints

### 15.1 POST `/api/telegram/webhook`

**Functionality**: Receives all Telegram bot updates (messages, callback queries). Routes to appropriate handler: `/start`, `/book`, `/mytickets`, `/whereismybus`, `/help`, `/cancel`. Manages multi-step booking wizard with session state.

### 15.2 POST `/api/sms/incoming`

**Functionality**: Handles incoming SMS messages for SMS-based booking flow.

### 15.3 POST `/api/csp-report`

**Functionality**: Receives Content-Security-Policy violation reports from browsers. Logs violations to PM2/stdout for monitoring. Returns HTTP 204 (no content).

---

## 16. Cross-Cutting Concerns

### 16.1 Company Segregation (All `/api/company/*` Routes)

Every company-scoped query includes `companyId` from the authenticated session:

```
WHERE companyId = session.user.companyId
```

This is enforced at the query level in every route handler, not at a middleware layer. Super admins bypass this filter.

### 16.2 Audit Logging

All sensitive operations create `AdminLog` entries:

| Action | Logged Data |
|--------|-------------|
| `BOOKING_CREATED` | bookingId, tripId, passengerCount, amount |
| `PAYMENT_PROCESSED` | paymentId, bookingId, method, amount |
| `TICKET_VERIFIED` | ticketId, shortCode, tripId |
| `TICKET_USED` | ticketId, passengerId |
| `TRIP_STATUS_CHANGED` | tripId, from status, to status |
| `PASSENGER_NO_SHOW` | tripId, passengerIds, counts |
| `REPLACEMENT_TICKET_SALE` | tripId, bookingId, seatNumbers, amount |
| `COMPANY_DEACTIVATED` | companyId, reason |
| `STAFF_CREATED` | userId, staffRole |
| `VEHICLE_STATUS_CHANGED` | vehicleId, from status, to status |

### 16.3 Transaction Safety

All financial and state-mutation operations use:
- `transactionWithTimeout(fn, 10000)` — 10-second timeout
- `SELECT FOR UPDATE NOWAIT` — row-level locking (fails immediately on conflict rather than waiting)
- Automatic rollback on any exception

### 16.4 Error Response Consistency

All endpoints return:
- Generic error messages (no SQL errors, stack traces, or file paths)
- Consistent JSON structure: `{ "error": "message" }`
- Appropriate HTTP status codes (400, 401, 403, 404, 409, 429, 500)

---

*End of Document 5.4.4 - API Endpoints and Functionality*
