# i-Ticket Platform - API Types

**Document**: 5.4.3 - API Types
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Data Type Validation Strategy

All API inputs are validated using **Zod** (runtime schema validation library) before any business logic executes. TypeScript provides compile-time type safety. Prisma ORM provides database-level type enforcement.

| Layer | Technology | Purpose |
|-------|-----------|---------|
| API Input | Zod schemas | Runtime validation of all request bodies and query params |
| Application | TypeScript | Compile-time type checking |
| Database | Prisma ORM | Type-safe query builder + migration enforcement |
| Output | JSON serialization | Consistent response shapes |

---

## 2. Database Field Enumerations

The platform uses string fields with documented allowed values (enforced by application-layer Zod validation):

### 2.1 User Roles

| Field | Allowed Values | Description |
|-------|---------------|-------------|
| `User.role` | `CUSTOMER`, `COMPANY_ADMIN`, `SUPER_ADMIN`, `SALES_PERSON` | Primary user role |
| `User.staffRole` | `ADMIN`, `DRIVER`, `CONDUCTOR`, `MANUAL_TICKETER`, `MECHANIC`, `FINANCE`, `SUPERVISOR` | Company staff sub-role |
| `User.staffStatus` | `AVAILABLE`, `ON_TRIP`, `ON_LEAVE` | Staff availability |

### 2.2 Trip Statuses

| Field | Allowed Values | Description |
|-------|---------------|-------------|
| `Trip.status` | `SCHEDULED`, `DELAYED`, `BOARDING`, `DEPARTED`, `COMPLETED`, `CANCELLED` | Trip lifecycle state |
| `Trip.delayReason` | `TRAFFIC`, `BREAKDOWN`, `WEATHER`, `WAITING_PASSENGERS`, `OTHER` | Reason for delay |

**Status Lifecycle**: `SCHEDULED` → `BOARDING` → `DEPARTED` → `COMPLETED`; can branch to `DELAYED` or `CANCELLED` from early states.

**Editable States**: `SCHEDULED`, `DELAYED`, `BOARDING`
**Read-Only States**: `DEPARTED`, `COMPLETED`, `CANCELLED` (plus `SOLD_OUT` when `availableSlots === 0`)

### 2.3 Booking & Payment

| Field | Allowed Values | Description |
|-------|---------------|-------------|
| `Booking.status` | `PENDING`, `PAID`, `CANCELLED`, `COMPLETED` | Booking state |
| `Payment.method` | `TELEBIRR`, `DEMO`, `CASH` | Payment method |
| `Payment.status` | `PENDING`, `SUCCESS`, `FAILED`, `TIMEOUT` | Payment state |
| `Payment.initiatedVia` | `WEB`, `SMS` | Payment channel |
| `Passenger.boardingStatus` | `PENDING`, `BOARDED`, `NO_SHOW` | Boarding state |

### 2.4 Vehicle & Fleet

| Field | Allowed Values | Description |
|-------|---------------|-------------|
| `Vehicle.status` | `ACTIVE`, `MAINTENANCE`, `INACTIVE` | Vehicle operational state |
| `Vehicle.busType` | `MINI`, `STANDARD`, `LUXURY` | Vehicle class |
| `Vehicle.fuelType` | `DIESEL`, `PETROL`, `CNG`, `ELECTRIC`, `GASOLINE`, `HYBRID` | Fuel type |
| `WorkOrder.taskType` | `PREVENTIVE`, `CORRECTIVE`, `INSPECTION`, `EMERGENCY` | Work order type |
| `WorkOrder.status` | `OPEN`, `IN_PROGRESS`, `BLOCKED`, `COMPLETED`, `CANCELLED` | Work order state |
| `WorkOrder.priority` | `1` (Low), `2` (Normal), `3` (High), `4` (Urgent) | Priority level |
| `VehicleInspection.type` | `DAILY`, `WEEKLY`, `PRE_TRIP`, `POST_TRIP`, `ANNUAL`, `SAFETY` | Inspection type |
| `VehicleInspection.status` | `PASS`, `FAIL`, `PASS_WITH_DEFECTS` | Inspection result |
| `MaintenanceSchedule.taskType` | `PREVENTIVE`, `INSPECTION`, `SERVICE` | Schedule type |

### 2.5 Support & Sales

| Field | Allowed Values | Description |
|-------|---------------|-------------|
| `SupportTicket.category` | `GENERAL`, `TECHNICAL`, `BOOKING`, `PAYMENT`, `ACCOUNT`, `FEEDBACK` | Ticket category |
| `SupportTicket.status` | `OPEN`, `IN_PROGRESS`, `RESOLVED`, `CLOSED` | Ticket state |
| `SupportTicket.priority` | `1` (Low), `2` (Medium), `3` (High), `4` (Urgent) | Priority |
| `SalesCommission.status` | `PENDING`, `APPROVED`, `PAID` | Commission payout state |

### 2.6 Fuel & Logistics

| Field | Allowed Values | Description |
|-------|---------------|-------------|
| `FuelEntry.fuelType` | `DIESEL`, `PETROL`, `CNG` | Fuel type recorded |
| `FuelEntry.paymentMethod` | `CASH`, `FUEL_CARD`, `TELEBIRR` | Fuel payment method |
| `TripLog.startFuelUnit` | `LITERS`, `PERCENTAGE` | Fuel measurement unit |
| `ManifestDownload.downloadType` | `AUTO_DEPARTED`, `AUTO_FULL_CAPACITY`, `MANUAL_COMPANY` | Manifest trigger |

---

## 3. Input Validation Schemas (Zod)

### 3.1 Authentication Schemas

#### Registration (`registerUserSchema`)

```
{
  name:           string, min 2 chars
  phone:          Ethiopian phone (09XXXXXXXX / 07XXXXXXXX, normalizes +251 prefix)
  email:          valid email (optional, or empty string)
  password:       string, 8-72 chars, requires uppercase + lowercase + digit
  nationalId:     string (optional)
  nextOfKinName:  string (optional)
  nextOfKinPhone: Ethiopian phone (optional, or empty string)
  referralCode:   string (optional)
  registerAsSalesPerson: boolean (optional)
}
```

#### Login (`loginSchema`)

```
{
  phone:    Ethiopian phone
  password: string, min 1 char
}
```

#### Password Reset (`resetPasswordSchema`)

```
{
  token:       string, min 1 char
  newPassword: string, 8-72 chars, requires uppercase + lowercase + digit
}
```

### 3.2 Booking Schema (`createBookingSchema`)

```
{
  tripId:     string, min 1 char
  passengers: array (1-10 items) of {
    name:           string, min 2 chars
    nationalId:     string (optional)
    phone:          Ethiopian phone
    specialNeeds:   string (optional)
    isChild:        boolean (optional)
    pickupLocation: string (optional)
    dropoffLocation: string (optional)
  }
  smsSessionId:  string (optional, for SMS/guest flows)
  selectedSeats: array of integers (optional, for manual seat selection)
}
```

**Business Rules Enforced**:
- Max 5 passengers per booking (online)
- Max 3 children per booking
- Children must have an adult
- Company admins and super admins cannot book

### 3.3 Payment Schema (`processPaymentSchema`)

```
{
  bookingId: string, min 1 char
  method:    "TELEBIRR" | "DEMO"
  phone:     Ethiopian phone (optional)
}
```

### 3.4 Trip Schemas

#### Create Trip (`createTripSchema`)

```
{
  origin:                string, min 2 chars
  destination:           string, min 2 chars
  route:                 string (optional, nullable)
  intermediateStops:     string (optional, nullable) — JSON array
  departureTime:         ISO 8601 datetime (must be future)
  estimatedDuration:     integer, 30-2880 (minutes)
  distance:              integer, 1-5000 (km)
  price:                 number, positive, max 100000 (ETB)
  busType:               string, min 2 chars
  totalSlots:            integer, positive, max 100
  hasWater:              boolean (default false)
  hasFood:               boolean (default false)
  driverId:              string, min 1 char
  conductorId:           string, min 1 char
  manualTicketerId:      string (optional, nullable)
  vehicleId:             string, min 1 char
  defaultPickup:         string, max 200 chars (optional, nullable)
  defaultDropoff:        string, max 200 chars (optional, nullable)
  overrideStaffConflict: boolean (default false)
  overrideVehicleConflict: boolean (default false)
  vehicleOverrideReason: string (optional)
}
```

#### Update Trip (`updateTripSchema`)

All fields from `createTripSchema` made optional (`.partial()`).

#### Trip Status Update (`statusUpdateSchema`)

```
{
  status:                 "SCHEDULED" | "DELAYED" | "BOARDING" | "DEPARTED" | "COMPLETED" | "CANCELLED"
  notes:                  string (optional)
  delayReason:            "TRAFFIC" | "BREAKDOWN" | "WEATHER" | "WAITING_PASSENGERS" | "OTHER" (optional)
  skipPreTripCheck:       boolean (optional, for overriding vehicle risk warnings)
  skipPreTripCheckReason: string, min 10 chars (required if skipPreTripCheck = true)
}
```

#### Batch Trip Creation (`batchTripSchema`)

```
Base fields:
{
  origin, destination, estimatedDuration, distance, price, busType,
  totalSlots, hasWater, hasFood, intermediateStops, defaultPickup,
  defaultDropoff, driverId, conductorId, manualTicketerId, vehicleId,
  createReturnTrips: boolean (default false)
}

Mode A — Same departure time for all dates:
{
  sameTimeForAll: true
  dates:          array of date strings (1-10)
  departureTime:  "HH:MM"
  returnDepartureTime: "HH:MM" (optional)
}

Mode B — Individual times per date:
{
  sameTimeForAll: false
  trips:          array (1-10) of { date, time, returnTime? }
}
```

### 3.5 Vehicle Schemas

#### Create Vehicle (`createVehicleSchema`)

```
{
  plateNumber:        Ethiopian plate format ("3-12345" or "AA 12345"), uppercased
  sideNumber:         alphanumeric with hyphens/spaces (optional), uppercased
  make:               string, 2-50 chars
  model:              string, 2-50 chars
  year:               integer, 1990 to current year + 1
  busType:            "MINI" | "STANDARD" | "LUXURY"
  color:              string, 2-30 chars (optional, nullable)
  totalSeats:         integer, 4-100 (range varies by busType)
  status:             "ACTIVE" | "MAINTENANCE" | "INACTIVE" (default "ACTIVE")
  registrationExpiry: date string (optional)
  insuranceExpiry:    date string (optional)
  lastServiceDate:    date string (optional)
  nextServiceDate:    date string (optional)
  currentOdometer:    integer, >= 0 (optional, nullable)
  fuelCapacity:       number, positive (optional, nullable)
  fuelType:           "DIESEL" | "GASOLINE" | "ELECTRIC" | "HYBRID" (optional, nullable)
}
```

**Seat Range Validation by Bus Type**:
- MINI: 4-20 seats
- STANDARD: 20-50 seats
- LUXURY: 30-60 seats

### 3.6 Staff Schema (`createStaffSchema`)

```
{
  name:          string, min 2 chars
  phone:         Ethiopian phone (09XXXXXXXX)
  email:         valid email (optional, or empty string)
  password:      string, min 8 chars, requires uppercase + lowercase + digit
  staffRole:     uppercase with underscores only (e.g., "DRIVER", "CONDUCTOR")
  licenseNumber: string (optional)
  employeeId:    string (optional)
}
```

### 3.7 GPS Tracking Schemas

#### Browser GPS Update (`updateSchema`)

```
{
  tripId:     string, min 1 char
  latitude:   number, -90 to 90
  longitude:  number, -180 to 180
  altitude:   number (optional, nullable)
  accuracy:   number, >= 0 (optional, nullable)
  heading:    number, 0-360 (optional, nullable)
  speed:      number, >= 0 (optional, nullable)
  recordedAt: ISO 8601 datetime
}
```

#### OsmAnd GPS Update (`osmandSchema`)

```
Query parameters (all coerced from strings):
{
  token:     string, min 1 char
  lat:       number, -90 to 90
  lon:       number, -180 to 180
  timestamp: number (optional) — Unix epoch seconds
  hdop:      number, >= 0 (optional)
  altitude:  number (optional)
  speed:     number, >= 0 (optional) — m/s, converted to km/h internally
  bearing:   number, 0-360 (optional)
}
```

### 3.8 Work Order Schema (`createWorkOrderSchema`)

```
{
  vehicleId:          string
  title:              string, 3-200 chars
  taskType:           "PREVENTIVE" | "CORRECTIVE" | "INSPECTION" | "EMERGENCY"
  scheduleId:         string (optional)
  description:        string, 5-2000 chars
  priority:           integer, 1-4 (default 2)
  assignedStaffIds:   array of strings (optional)
  serviceProvider:    string (optional)
  scheduledDate:      ISO 8601 datetime (optional)
}
```

### 3.9 Vehicle Inspection Schema (`createInspectionSchema`)

```
{
  inspectionType:     "DAILY" | "WEEKLY" | "PRE_TRIP" | "POST_TRIP" | "ANNUAL" | "SAFETY"
  inspectedByUserId:  string
  checklistResults:   Record<string, boolean | string | number>
  status:             "PASS" | "FAIL" | "PASS_WITH_DEFECTS"
  defectsFound:       array of strings (optional)
  odometerReading:    integer, positive (optional)
  notes:              string (optional)
}
```

### 3.10 Fuel Entry Schema (`createFuelEntrySchema`)

```
{
  liters:           number, positive
  costBirr:         number, positive
  odometerReading:  integer, positive
  fuelType:         "DIESEL" | "PETROL" | "CNG" (default "DIESEL")
  station:          string (optional)
  city:             string (optional)
  receiptNumber:    string (optional)
  paymentMethod:    "CASH" | "FUEL_CARD" | "TELEBIRR" (optional)
  recordedByUserId: string (optional)
  recordedByName:   string (optional)
}
```

### 3.11 Maintenance Schedule Schema

```
{
  taskName:            string, 3-200 chars
  taskType:            "PREVENTIVE" | "INSPECTION" | "SERVICE"
  description:         string (optional)
  intervalKm:          integer, positive (optional — at least one interval required)
  intervalDays:        integer, positive (optional — at least one interval required)
  priority:            integer, 1-4 (default 2)
  estimatedDuration:   integer, positive (optional) — minutes
  estimatedCostBirr:   number, positive (optional)
  autoCreateWorkOrder: boolean (default true)
}
```

### 3.12 Support Ticket Schema

```
{
  name:     string, min 2 chars
  email:    valid email
  phone:    string (optional)
  subject:  string, min 3 chars
  message:  string, min 10 chars
  category: "GENERAL" | "TECHNICAL" | "BOOKING" | "PAYMENT" | "ACCOUNT" | "FEEDBACK" (optional)
}
```

### 3.13 Trip Log Schemas

#### Start Readings

```
{
  startOdometer: integer, >= 0
  startFuel:     number, >= 0 (optional)
  startFuelUnit: "LITERS" | "PERCENTAGE" (optional)
  startNotes:    string, max 500 chars (optional)
}
```

#### End Readings

```
{
  endOdometer: integer, >= 0
  endFuel:     number, >= 0 (optional)
  endNotes:    string, max 500 chars (optional)
}
```

### 3.14 No-Show Marking Schema

```
{
  passengerIds: array of strings (CUID passenger IDs)
}
```

### 3.15 Replacement Ticket Schema

```
{
  passengerCount: integer, 1-10 (default 1)
}
```

### 3.16 Admin Schemas

#### Create Company (`CreateCompanySchema`)

```
{
  companyName:  string, min 2 chars
  companyPhone: Ethiopian phone (09XXXXXXXX)
  companyEmail: valid email
  address:      string (optional)
  bankName:     string (optional)
  bankAccount:  string (optional)
  bankBranch:   string (optional)
  adminName:    string, min 2 chars
  adminPhone:   Ethiopian phone
  adminEmail:   valid email
}
```

#### Company Status Update (`CompanyStatusSchema`)

```
{
  companyId: string, min 1 char
  isActive:  boolean
  reason:    string, 10-500 chars (trimmed)
}
```

### 3.17 Query/Filter Schemas

#### Pagination (`paginationSchema`)

```
{
  page:  string (default "1") → parsed to integer >= 1
  limit: string (default "20") → parsed to integer, clamped 1-100
}
```

#### Trip Search (`searchTripsSchema`)

```
{
  origin:      string (optional)
  destination: string (optional)
  date:        string (optional)
  page:        string (default "1")
  limit:       string (default "20")
}
```

#### Admin Bookings (`adminBookingsQuerySchema`)

```
{
  page:      integer, >= 1 (default 1)
  limit:     integer, 1-100 (default 10)
  status:    "PAID" | "PENDING" | "CANCELLED" | "ALL" (default "ALL")
  companyId: string (optional)
  startDate: string (optional)
  endDate:   string (optional)
  search:    string (optional)
}
```

#### Work Order Query (`workOrderQuerySchema`)

```
{
  status:    "OPEN" | "IN_PROGRESS" | "BLOCKED" | "COMPLETED" | "CANCELLED" (optional)
  priority:  string → integer 1-4 (optional)
  vehicleId: string (optional)
  workType:  "PREVENTIVE" | "CORRECTIVE" | "INSPECTION" | "EMERGENCY" (optional)
  page:      string → integer >= 1 (optional)
  limit:     string → integer 1-100 (optional)
}
```

---

## 4. TypeScript Type Definitions

### 4.1 Authentication Session Type

```typescript
interface Session {
  user: {
    id: string
    name: string
    email?: string
    phone: string
    role: "CUSTOMER" | "COMPANY_ADMIN" | "SUPER_ADMIN" | "SALES_PERSON"
    companyId: string | null
    companyName: string | null
    companyLogo: string | null
    staffRole: string | null
    profilePicture: string | null
    nationalId: string | null
    mustChangePassword?: boolean
    platformStaffRole?: string
    platformStaffDepartment?: string
    platformStaffPermissions?: Record<string, boolean>
  }
}
```

### 4.2 JWT Token Payload

```typescript
interface JWT {
  id: string
  role: string
  phone: string
  companyId: string | null
  companyName: string | null
  companyLogo: string | null
  staffRole: string | null
  profilePicture: string | null
  nationalId: string | null
  mustChangePassword?: boolean
  platformStaffRole?: string
  platformStaffDepartment?: string
  platformStaffPermissions?: Record<string, boolean>
}
```

### 4.3 Commission Types

```typescript
interface CommissionBreakdown {
  baseCommission: number   // 5% of totalAmount
  vat: number              // 15% of baseCommission
  totalCommission: number  // baseCommission + vat
}

// Constants
COMMISSION_RATE    = 0.05    // 5%
VAT_RATE           = 0.15    // 15% Ethiopian VAT
TELEBIRR_FEE_RATE  = 0.005   // 0.5% (absorbed by i-Ticket)
```

### 4.4 TeleBirr Payment Types

```typescript
interface TelebirrCallbackPayload {
  transactionId: string
  outTradeNo: string       // booking ID
  status: string           // "SUCCESS" | "FAILED"
  amount: string
  currency: string         // "ETB"
  timestamp: string
  signature: string
}
```

### 4.5 Trip Status Types

```typescript
type FinalTripStatus    = "DEPARTED" | "COMPLETED" | "CANCELLED"
type EditableTripStatus = "SCHEDULED" | "DELAYED" | "BOARDING"
type TripStatus         = FinalTripStatus | EditableTripStatus
```

---

## 5. Common Response Structures

### 5.1 Standard Error Response

```json
{ "error": "Human-readable error message" }
```

Status codes: 400, 401, 403, 404, 409, 429, 500

### 5.2 Validation Error Response

```json
{
  "error": "Validation error",
  "details": [
    { "code": "too_small", "minimum": 2, "path": ["name"], "message": "String must contain at least 2 character(s)" }
  ]
}
```

### 5.3 Paginated List Response

```json
{
  "<items>": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8
  }
}
```

Field name varies by endpoint: `bookings`, `trips`, `workOrders`, `staff`, etc.

### 5.4 Rate Limit Response (HTTP 429)

```json
{
  "error": "Too many requests. Please try again later.",
  "retryAfter": 45
}
```

Includes `Retry-After: 45` header.

---

## 6. Ethiopian Phone Number Format

All phone number fields use a custom Zod validator that normalizes multiple input formats:

| Input Format | Normalized To | Valid |
|-------------|---------------|-------|
| `0912345678` | `0912345678` | Yes |
| `0712345678` | `0712345678` | Yes |
| `+251912345678` | `0912345678` | Yes |
| `251912345678` | `0912345678` | Yes |
| `912345678` | Invalid | No |
| `1234567890` | Invalid | No |

Final validation regex: `/^0[79]\d{8}$/` (10 digits, starting with 09 or 07)

---

## 7. Ethiopian License Plate Format

Vehicle plate numbers are validated with a custom pattern:

| Format | Example | Valid |
|--------|---------|-------|
| `N-NNNNN` | `3-12345` | Yes |
| `LL NNNNN` | `AA 12345` | Yes |
| `LLNNNNN` | `AA12345` | Yes |
| Random text | `ABCXYZ` | No |

All plate numbers are converted to uppercase before storage.

---

## 8. Sensitive Field Classification

Fields classified by sensitivity level for audit purposes:

| Sensitivity | Fields | Protection |
|-------------|--------|------------|
| **Critical** | `User.password` | bcrypt hash (12 rounds), never returned in API responses |
| **Critical** | `NEXTAUTH_SECRET`, `TELEBIRR_APP_KEY` | Environment variables, validated at startup |
| **High** | `User.nationalId`, `Company.bankAccount` | Stored plaintext; recommended for field-level encryption |
| **High** | Password reset tokens | bcrypt-hashed before storage, time-limited (1 hour) |
| **Medium** | `User.phone`, `User.email` | Validated format, used for identification |
| **Medium** | `Trip.trackingToken` | Crypto-random (32 bytes hex), one-per-trip |
| **Low** | `Passenger.name`, `Booking.totalAmount` | Standard business data |

---

*End of Document 5.4.3 - API Types*
