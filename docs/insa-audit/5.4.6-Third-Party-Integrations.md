# i-Ticket Platform - Third-Party Integrations

**Document**: 5.4.6 - Third-Party Integrations
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Integration Overview

i-Ticket integrates with the following third-party services:

| # | Service | Purpose | Data Flow | Protocol |
|---|---------|---------|-----------|----------|
| 1 | TeleBirr | Mobile money payments | Bidirectional | HTTPS + HMAC-SHA256 |
| 2 | Telegram Bot API | Booking via Telegram | Bidirectional | HTTPS + Webhook |
| 3 | SMS Gateway | SMS notifications & booking | Bidirectional | HTTPS |
| 4 | Cloudflare | CDN, WAF, DNS, SSL | Proxy | HTTPS |
| 5 | OpenStreetMap Tiles | Map rendering | Outbound (client) | HTTPS |
| 6 | OSRM (Project OSRM) | Road route calculation | Outbound (client) | HTTPS |
| 7 | Nominatim (OpenStreetMap) | Reverse geocoding | Outbound (client) | HTTPS |
| 8 | QR Server API | QR code generation | Outbound (server) | HTTPS |
| 9 | Cloudflare Web Analytics | Traffic analytics | Outbound (client) | HTTPS |

---

## 2. TeleBirr Payment Integration

### 2.1 Overview

| Property | Value |
|----------|-------|
| **Provider** | Ethio Telecom (TeleBirr Super App) |
| **Purpose** | Mobile money payment processing |
| **Environment** | Production + Demo mode |
| **Transaction Fee** | 0.5% of transaction amount (absorbed by i-Ticket, invisible to customers) |
| **API Protocol** | HTTPS REST API |
| **Authentication** | HMAC-SHA256 signed requests |

### 2.2 Data Flow — Payment Initiation

```
i-Ticket Server → TeleBirr API
```

**Outbound Request**:
1. Construct payload: `{ appId, merchantCode, amount, phone, nonce, timestamp, outTradeNo }`
2. Sort parameters alphabetically
3. Sign: `HMAC-SHA256(sortedPayload, TELEBIRR_APP_KEY)`
4. Send POST to TeleBirr API endpoint over HTTPS
5. Include signature in request

**Data Sent to TeleBirr**:
- App ID (`TELEBIRR_APP_ID`)
- Merchant code
- Payment amount (ETB)
- Customer phone number
- Unique booking reference (`outTradeNo` = booking ID)
- Nonce (replay protection)
- Timestamp
- HMAC-SHA256 signature

### 2.3 Data Flow — Payment Callback

```
TeleBirr → i-Ticket Server (POST /api/payments/telebirr/callback)
```

**Inbound Webhook** — 5-gate verification:

| Gate | Check | Failure Response |
|------|-------|-----------------|
| 1 | SHA-256 hash of raw payload body | 400 — Invalid request |
| 2 | Replay detection: lookup hash in `ProcessedCallback` table | 200 — Already processed |
| 3 | HMAC-SHA256 verification with `crypto.timingSafeEqual()` | 401 — Invalid signature |
| 4 | Timestamp within 5-minute window | 400 — Expired callback |
| 5 | IP whitelist check (if `TELEBIRR_WEBHOOK_IPS` configured) | 403 — Unauthorized IP |

**Data Received from TeleBirr**:
- Transaction ID
- Booking reference (`outTradeNo`)
- Payment status (SUCCESS / FAILED)
- Amount
- Currency (ETB)
- Timestamp
- HMAC-SHA256 signature

### 2.4 Environment Variables

| Variable | Purpose | Sensitivity |
|----------|---------|-------------|
| `TELEBIRR_APP_ID` | Application identifier | High |
| `TELEBIRR_APP_KEY` | HMAC signing key | Critical |
| `TELEBIRR_MERCHANT_CODE` | Merchant identifier | Medium |
| `TELEBIRR_API_URL` | API base URL | Low |
| `TELEBIRR_WEBHOOK_IPS` | Allowed callback source IPs (optional) | Medium |
| `DEMO_MODE` | If `true`, bypasses real TeleBirr API | Low |

### 2.5 Security Controls

- HMAC-SHA256 signature on all outbound requests
- 5-gate inbound callback verification (hash, replay, HMAC, timestamp, IP)
- `crypto.timingSafeEqual()` for signature comparison (prevents timing attacks)
- Replay protection via `ProcessedCallback` table
- Server-side amount recalculation (never trusts client-provided amounts)
- Transaction-safe database updates with row locking

---

## 3. Telegram Bot Integration

### 3.1 Overview

| Property | Value |
|----------|-------|
| **Bot Username** | @i_ticket_busBot |
| **Bot URL** | https://t.me/i_ticket_busBot |
| **Purpose** | Bilingual (English/Amharic) ticket booking via Telegram |
| **API** | Telegram Bot API v7 |
| **Webhook URL** | `https://i-ticket.et/api/telegram/webhook` |

### 3.2 Data Flow

```
Telegram User ↔ Telegram Servers ↔ i-Ticket Webhook (POST /api/telegram/webhook)
```

**Inbound (from Telegram)**:
- User messages (text commands)
- Callback query data (button clicks)
- User profile: chat ID, first name, last name, username

**Outbound (to Telegram)**:
- Text messages (booking confirmation, ticket details)
- Inline keyboards (city selection, seat selection, payment options)
- QR code images (ticket QR codes)
- Location data (bus GPS position for /whereismybus)

### 3.3 Data Stored

`TelegramSession` model:
- `chatId` (BigInt) — Telegram chat identifier
- `phone` — Linked Ethiopian phone number
- `userId` — Linked i-Ticket user ID
- `language` — EN or AM
- `state` — Current conversation state (IDLE, AWAITING_CITY, etc.)
- `data` — JSON blob with temporary booking wizard data
- `expiresAt` — 30-minute session timeout

### 3.4 Security Controls

- Webhook authenticated via `X-Telegram-Bot-Api-Secret-Token` header
- Session timeout: 30 minutes (cleaned by cron)
- Phone verification links Telegram user to i-Ticket account
- No sensitive data stored in Telegram session (booking data is temporary)
- Rate limited: 100 req/min (WEBHOOK rate limit)

### 3.5 Environment Variables

| Variable | Purpose | Sensitivity |
|----------|---------|-------------|
| `TELEGRAM_BOT_TOKEN` | Bot API authentication | Critical |
| `TELEGRAM_BOT_ENABLED` | Enable/disable bot | Low |

---

## 4. SMS Gateway Integration

### 4.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | SMS notifications (booking confirmation, ticket delivery, reminders) |
| **Direction** | Primarily outbound; inbound for SMS booking flow |
| **Endpoints** | `/api/sms/incoming` (inbound), `/api/sms/outgoing` (outbound) |

### 4.2 Data Flow

**Outbound SMS** (i-Ticket → SMS Gateway → Customer):
- Booking confirmation with ticket short codes
- Payment confirmation
- Trip departure reminders
- Password reset tokens
- No-show notifications

**Inbound SMS** (Customer → SMS Gateway → i-Ticket):
- SMS-based booking flow (USSD-style interaction)

### 4.3 Data Transmitted via SMS

| Data | Example |
|------|---------|
| Ticket short code | `ABC123` |
| Trip route | `Addis Ababa → Hawassa` |
| Departure time | `Feb 20, 2026 at 6:00 AM` |
| Seat number | `Seat 12` |
| Tracking URL | `https://i-ticket.et/track/ABC123` |

**Not transmitted**: Passwords, national IDs, financial details, full booking amounts.

### 4.4 Security Controls

- HMAC-SHA256 signature on inbound webhooks
- Rate limited
- SMS content limited to non-sensitive operational data
- No PII beyond phone number and passenger name in SMS

### 4.5 Environment Variables

| Variable | Purpose | Sensitivity |
|----------|---------|-------------|
| `SMS_API_KEY` | Gateway authentication | Critical |
| `SMS_API_URL` | Gateway endpoint | Low |
| `SMS_WEBHOOK_SECRET` | Inbound webhook verification | High |

---

## 5. Cloudflare Integration

### 5.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | CDN, WAF, DDoS protection, DNS management, SSL termination |
| **Domain** | i-ticket.et |
| **SSL Mode** | Full (Strict) |
| **Plan** | Free tier |

### 5.2 Services Used

| Service | Configuration |
|---------|--------------|
| **DNS** | Cloudflare nameservers manage i-ticket.et |
| **SSL/TLS** | Full (Strict) mode — origin has valid SSL certificate |
| **TLS Minimum** | TLS 1.2 (TLS 1.0 and 1.1 disabled) |
| **HSTS** | Enabled with preload, includeSubDomains, max-age 1 year |
| **CDN** | Caches static assets (JS, CSS, images, fonts) |
| **DDoS** | Automatic DDoS mitigation |
| **WAF** | Managed ruleset (free tier) |
| **Bot Protection** | Basic bot protection |
| **Web Analytics** | Cloudflare Web Analytics beacon |

### 5.3 Disabled Features

| Feature | Reason |
|---------|--------|
| **Email Obfuscation** | Modifies HTML, breaks React hydration (documented bug) |
| **Rocket Loader** | Interferes with Next.js JavaScript loading |
| **Auto Minify** | Next.js handles its own minification |

### 5.4 Data Flow

```
User Browser → Cloudflare Edge → Nginx (54.147.33.168) → Next.js Application
```

Cloudflare acts as a reverse proxy. All traffic passes through Cloudflare:
- Client IP forwarded via `CF-Connecting-IP` and `X-Forwarded-For` headers
- Cloudflare terminates SSL, re-encrypts to origin (Full Strict)
- Static assets cached at Cloudflare edge (global CDN)
- Dynamic API requests proxied to origin

### 5.5 Security Headers (via Cloudflare)

- `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`
- TLS 1.2 minimum enforced at edge
- Automatic HTTPS redirect

---

## 6. OpenStreetMap Tile Server

### 6.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | Map tile rendering for GPS tracking, fleet maps, pickup/dropoff selection |
| **Provider** | OpenStreetMap Foundation (open source) |
| **URL** | `https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png` |
| **Integration** | Client-side only (Leaflet.js map library) |

### 6.2 Data Flow

```
User Browser → OpenStreetMap CDN (tile images)
```

- Map tiles are fetched directly by the user's browser
- No server-side requests to OpenStreetMap
- No user data sent to OpenStreetMap (only tile coordinates)
- Tiles cached by browser and service worker

### 6.3 CSP Configuration

```
img-src 'self' https://*.tile.openstreetmap.org;
connect-src 'self' https://*.tile.openstreetmap.org;
```

---

## 7. OSRM (Open Source Routing Machine)

### 7.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | Road route geometry for tracking map overlays |
| **Provider** | Project OSRM (open source, public demo server) |
| **URL** | `https://router.project-osrm.org/route/v1/driving/{lon1},{lat1};{lon2},{lat2}` |
| **Integration** | Client-side only (fetched once per map load) |

### 7.2 Data Flow

```
User Browser → OSRM Public API → Returns road geometry (GeoJSON)
```

- Only sends origin/destination coordinates (no user data)
- Route geometry rendered as blue line on tracking maps
- Fetched once per component mount (not on polling intervals)
- Falls back to straight dashed line if OSRM unreachable

### 7.3 CSP Configuration

```
connect-src 'self' https://router.project-osrm.org;
```

---

## 8. Nominatim (OpenStreetMap Geocoding)

### 8.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | Reverse geocoding for pickup/dropoff location names |
| **Provider** | OpenStreetMap Foundation (open source) |
| **URL** | `https://nominatim.openstreetmap.org/reverse` |
| **Integration** | Client-side only (on map click for stop selection) |

### 8.2 Data Flow

```
User Browser → Nominatim API (latitude, longitude) → Returns place name
```

- Only sends coordinates when user clicks on map to select pickup/dropoff
- Returns human-readable address/place name
- No user data or session information sent

### 8.3 CSP Configuration

```
connect-src 'self' https://nominatim.openstreetmap.org;
```

---

## 9. QR Server API

### 9.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | QR code image generation for tickets |
| **Provider** | goQR.me (public API) |
| **URL** | `https://api.qrserver.com/v1/create-qr-code/` |
| **Integration** | Server-side (QR URLs embedded in ticket data) |

### 9.2 Data Flow

```
i-Ticket Server generates URL → Browser loads QR image from QR Server
```

- QR code URL format: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=<ticket_code>`
- Only ticket short codes (6-char alphanumeric) sent as `data` parameter
- No PII or sensitive data in QR code content
- QR image loaded client-side from the generated URL

### 9.3 CSP Configuration

```
img-src 'self' https://api.qrserver.com;
```

---

## 10. Cloudflare Web Analytics

### 10.1 Overview

| Property | Value |
|----------|-------|
| **Purpose** | Privacy-friendly traffic analytics (no cookies) |
| **Provider** | Cloudflare |
| **Script URL** | `https://static.cloudflareinsights.com/beacon.min.js` |
| **Beacon URL** | `https://cloudflareinsights.com` |
| **Integration** | Client-side JavaScript beacon |

### 10.2 Data Collected

- Page views and navigation
- Browser/device information
- Geographic location (country level)
- Referrer URLs

**Not collected**: Personal data, cookies, IP addresses (privacy-first analytics).

### 10.3 CSP Configuration

```
script-src 'self' https://static.cloudflareinsights.com;
connect-src 'self' https://cloudflareinsights.com;
```

---

## 11. Integration Security Summary

| Integration | Auth Method | Data Sensitivity | Direction | Encryption |
|-------------|------------|-----------------|-----------|------------|
| TeleBirr | HMAC-SHA256 | High (financial) | Bidirectional | TLS 1.2+ |
| Telegram | Bot token + secret header | Medium (booking data) | Bidirectional | TLS 1.2+ |
| SMS Gateway | API key + HMAC | Medium (ticket codes, names) | Bidirectional | TLS 1.2+ |
| Cloudflare | Origin certificate | Low (proxied traffic) | Proxy | TLS 1.2+ (Full Strict) |
| OpenStreetMap | None (public) | None (tile coordinates only) | Client outbound | TLS |
| OSRM | None (public) | None (coordinates only) | Client outbound | TLS |
| Nominatim | None (public) | None (coordinates only) | Client outbound | TLS |
| QR Server | None (public) | Low (ticket short codes) | Client outbound | TLS |
| Cloudflare Analytics | None (injected script) | Low (page views only) | Client outbound | TLS |

---

## 12. Data Shared with Third Parties

| Third Party | Data Shared | Data NOT Shared |
|-------------|-------------|-----------------|
| TeleBirr | Phone number, payment amount, booking reference | Passenger names, national IDs, trip details |
| Telegram | Chat ID, phone (user-provided), booking details during wizard | Passwords, national IDs, payment details |
| SMS Gateway | Phone number, passenger name, ticket code, route, departure time | National ID, payment amounts, financial data |
| Cloudflare | All proxied HTTP traffic (encrypted) | Database contents (localhost only) |
| OpenStreetMap | Map tile coordinates (from browser) | No user data |
| OSRM | Route coordinates (from browser) | No user data |
| Nominatim | Clicked map coordinates (from browser) | No user data |
| QR Server | 6-character ticket short code | No PII, no booking details |
| Cloudflare Analytics | Page view data (no PII) | No personal data |

---

*End of Document 5.4.6 - Third-Party Integrations*
