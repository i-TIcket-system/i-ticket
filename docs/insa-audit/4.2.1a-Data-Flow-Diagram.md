# i-Ticket Platform - Data Flow Diagrams (DFD)

**Document**: 4.2.1a - Data Flow Diagram
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. Context-Level DFD (Level 0)

The Level 0 DFD shows the i-Ticket system as a single process interacting with all external entities.

### External Entities

| ID | Entity | Type | Description |
|----|--------|------|-------------|
| E1 | Registered Customer | Human | End users who register with phone + password and book bus tickets |
| E2 | Guest Customer | Human | Users who book without registration (phone payment = verification) |
| E3 | Company Admin | Human | Bus company administrators managing trips, staff, vehicles, fleet |
| E4 | Super Admin | Human | i-Ticket platform administrators with full system access |
| E5 | Driver | Human | Bus drivers providing GPS location and managing trip departures |
| E6 | Conductor | Human | Bus conductors verifying tickets and managing boarding |
| E7 | Cashier / Manual Ticketer | Human | Station staff selling tickets manually (cash payments) |
| E8 | Mechanic | Human | Fleet maintenance personnel performing inspections and repairs |
| E9 | Finance Staff | Human | Company finance personnel viewing reports and costs |
| E10 | Sales Person | Human | Affiliate marketers recruiting customers via referral codes |
| E11 | Platform Staff | Human | i-Ticket employees (support, accountant, DevOps) |
| S1 | TeleBirr Payment Gateway | External System | Mobile money payment processing (Ethio Telecom) |
| S2 | SMS Gateway (Negarit/GeezSMS) | External System | SMS delivery for ticket confirmations, reminders, booking |
| S3 | Telegram Bot API | External System | Telegram messaging platform for bot-based booking |
| S4 | ClickUp API | External System | Project management for support tickets and alerts |
| S6 | OpenStreetMap Tiles | External System | Map tile imagery for tracking maps |
| S7 | OSRM Routing API | External System | Road route geometry for map overlays |
| S8 | Nominatim Geocoding | External System | Reverse geocoding (coordinates to address names) |
| S9 | Cloudflare CDN/WAF | External System | SSL termination, DDoS protection, HSTS, caching |
| S12 | OsmAnd GPS App | External System | Background GPS tracking from driver phones |
| S14 | Cron Scheduler | External System | Scheduled job triggers (cleanup, reminders, AI scoring) |

### Level 0 Diagram

```
                                    +-----------+
                                    | Cloudflare|
                                    |  CDN/WAF  |
                                    |   (S9)    |
                                    +-----+-----+
                                          |
                                     HTTPS/TLS
                                          |
+-------------+   Search/Book    +--------+--------+   Payment Request    +-----------+
| Customer    |----------------->|                  |-------------------->| TeleBirr  |
| (E1/E2)     |<-----------------                  |<--------------------| (S1)      |
+-------------+   Tickets/QR    |                  |   Callback/Status   +-----------+
                                |                  |
+-------------+   Manage Trips  |                  |   SMS Delivery      +-----------+
| Company     |---------------->|                  |-------------------->| SMS       |
| Admin (E3)  |<----------------|                  |<--------------------| Gateway   |
+-------------+   Reports/Data |                  |   Inbound SMS       | (S2)      |
                                |                  |                     +-----------+
+-------------+   Full Access   |    i-Ticket      |
| Super Admin |---------------->|    Platform      |   Bot Messages      +-----------+
| (E4)        |<----------------|    (P0)          |-------------------->| Telegram  |
+-------------+   Dashboard     |                  |<--------------------| Bot API   |
                                |                  |   Webhook Updates   | (S3)      |
+-------------+   GPS Location  |                  |                     +-----------+
| Driver      |---------------->|                  |   Support Tasks     +-----------+
| (E5)        |<----------------|                  |-------------------->| ClickUp   |
+-------------+   Trip Status   |                  |                     | (S4)      |
                                |                  |                     +-----------+
+-------------+   Scan Tickets  |                  |   Map Tiles         +-----------+
| Conductor   |---------------->|                  |<--------------------| OSM Tiles |
| (E6)        |<----------------|                  |                     | (S6)      |
+-------------+   Verify Result |                  |                     +-----------+
                                |                  |   Route Geometry    +-----------+
+-------------+   Sell Tickets  |                  |<--------------------| OSRM      |
| Cashier     |---------------->|                  |                     | (S7)      |
| (E7)        |<----------------|                  |                     +-----------+
+-------------+   Ticket/QR    |                  |   Geocoding         +-----------+
                                |                  |<--------------------| Nominatim |
+-------------+   Inspections   |                  |                     | (S8)      |
| Mechanic    |---------------->|                  |                     +-----------+
| (E8)        |<----------------|                  |   Background GPS    +-----------+
+-------------+   Work Orders   |                  |<--------------------| OsmAnd    |
                                |                  |                     | (S12)     |
+-------------+   View Reports  |                  |                     +-----------+
| Finance     |---------------->|                  |   Scheduled Triggers+-----------+
| (E9)        |<----------------|                  |<--------------------| Cron      |
+-------------+   Financial Data|                  |                     | (S14)     |
                                |                  |                     +-----------+
+-------------+   Referrals     |                  |
| Sales       |---------------->|                  |
| Person (E10)|<----------------|                  |
+-------------+   Commissions   +------------------+
                                        |
                                   Prisma ORM
                                        |
                                +-------+-------+
                                | PostgreSQL    |
                                | Database      |
                                | (S10)         |
                                +---------------+
```

### Data Flows Summary (Level 0)

| Flow | From | To | Data Description |
|------|------|----|------------------|
| F1 | E1/E2 | P0 | Trip search queries (origin, destination, date), booking requests (passengers, seats), payment initiation |
| F2 | P0 | E1/E2 | Available trips, seat maps, booking confirmations, tickets with QR codes, bus GPS location |
| F3 | E3 | P0 | Trip CRUD, staff management, vehicle management, fleet analytics queries, report requests |
| F4 | P0 | E3 | Trip data, booking data, manifests, analytics dashboards, Excel reports, fleet tracking map |
| F5 | E4 | P0 | Company management, trip oversight, system analytics, platform staff management |
| F6 | P0 | E4 | Dashboard stats, audit logs, tax reports, revenue analytics, all company data |
| F7 | E5 | P0 | GPS coordinates (lat, lon, altitude, accuracy, heading, speed), trip status updates |
| F8 | P0 | E5 | Trip assignment, ETA calculations, tracking status |
| F9 | E6 | P0 | Ticket QR scans (shortCode), boarding status updates |
| F10 | P0 | E6 | Ticket verification results, passenger details, trip manifests |
| F11 | E7 | P0 | Manual ticket sales (cash), replacement ticket sales for no-shows |
| F12 | P0 | E7 | Booking confirmations, tickets with QR codes and shortCodes |
| F13 | P0 | S1 | Payment initiation (phone, amount, merchantCode, HMAC signature) |
| F14 | S1 | P0 | Payment callback (transactionId, status, amount, signature) |
| F15 | P0 | S2 | Outbound SMS (ticket confirmations, reminders, payment timeout notifications) |
| F16 | S2 | P0 | Inbound SMS webhook (booking commands from customers) |
| F17 | S3 | P0 | Telegram webhook updates (user messages, button callbacks, location shares) |
| F18 | P0 | S3 | Bot responses (text, inline keyboards, location messages, ticket images) |
| F19 | P0 | S4 | Support ticket creation, low-slot alerts, audit log tasks |
| F20 | S12 | P0 | Background GPS from OsmAnd app (token-authenticated GET requests) |
| F21 | S14 | P0 | Cron trigger (Bearer token authenticated GET requests) |
| F22 | P0 | S10 | All database read/write operations via Prisma ORM |

---

## 2. Level 1 DFD - Core Business Processes

The Level 1 DFD decomposes the i-Ticket system into its major functional processes.

### Process Decomposition

```
+-------------------------------------------------------------------+
|                        i-Ticket Platform                          |
|                                                                   |
|  +------------------+    +------------------+    +--------------+ |
|  | P1: Auth &       |    | P2: Trip Search  |    | P3: Payment  | |
|  | Session Mgmt     |    | & Booking        |    | Processing   | |
|  +--------+---------+    +--------+---------+    +------+-------+ |
|           |                       |                      |        |
|  +--------+---------+    +--------+---------+    +------+-------+ |
|  | P4: Ticket        |    | P5: GPS Tracking |    | P6: No-Show  | |
|  | Generation &      |    | & ETA            |    | & Replacement| |
|  | Verification      |    +--------+---------+    +--------------+ |
|  +------------------+             |                               |
|                          +--------+---------+                     |
|  +------------------+    | P7: Telegram Bot |    +--------------+ |
|  | P8: SMS Booking  |    | Booking          |    | P9: Trip     | |
|  +------------------+    +------------------+    | Management   | |
|                                                  +--------------+ |
|  +------------------+    +------------------+                     |
|  | P10: Fleet Mgmt  |    | P11: Analytics   |    +--------------+ |
|  | & Maintenance     |    | & Reports        |    | P12: Admin   | |
|  +------------------+    +------------------+    | Platform     | |
|                                                  +--------------+ |
|  +------------------+    +------------------+                     |
|  | P13: Cron Jobs   |    | P14: Support     |                    |
|  | (Scheduled)       |    | Tickets          |                    |
|  +------------------+    +------------------+                     |
+-------------------------------------------------------------------+
```

### P1: Authentication & Session Management

```
                     +----------------+
 E1/E2/E3/E4/E5     |                |
 ------------------>| P1.1 Login     |<-----> D1 (User)
 phone + password   |                |         bcrypt compare
                     +-------+--------+
                             |
                        JWT Session
                        (httpOnly cookie,
                         30-day maxAge)
                             |
                     +-------+--------+
 E1 --------------->| P1.2 Register  |------> D1 (User)
 name, phone, pwd   |                |------> D32 (SalesReferral)
 referralCode?      |                |------> D35 (AdminLog)
                     +----------------+

 E1 --------------->| P1.4 Password  |------> D29 (PasswordReset)
 phone              | Reset          |------> S2 (SMS with token)
                     +----------------+

 Rate Limiting:
   - Login: 5 attempts/30min per phone, 15min lockout
   - Login: 10 attempts/15min per IP
   - Register: 3/hour per IP
```

### P2: Trip Search & Booking

```
 E1/E2                                                      D3 (Trip)
   |                                                           ^
   |--[origin, dest, date]---> P2.1 Trip Search -------------->|
   |<--[available trips]-------                                |
   |                                                           |
   |--[tripId]--------------> P2.2 Seat Check ------> D5 (Passenger)
   |<--[seat map]-------------                                |
   |                                                           |
   |--[tripId, passengers,]--> P2.3 Create Booking            |
   |   seats, phone]          |                                |
   |                          |--SELECT FOR UPDATE NOWAIT----->|
   |                          |--create---> D4 (Booking)       |
   |                          |--create---> D5 (Passenger)     |
   |                          |--decrement availableSlots----->|
   |                          |--log------> D35 (AdminLog)     |
   |<--[bookingId]------------|                                |
   |                                                           |
   |                          P2.4 Auto-Halt (if slots <= 10)  |
   |                          |--halt-----> D3 (bookingHalted) |
   |                          |--alert----> S4 (ClickUp)       |
   |                          |--notify---> D22 (Notification) |
```

### P3: Payment Processing

```
 E1/E2                         P3.1 Process Payment
   |--[bookingId, method]----->|
   |                           |--verify 10-min window
   |                           |--recalculate amount server-side
   |                           |--create---> D7 (Payment)
   |                           |
   |          +----------------+------------------+
   |          |                                   |
   |    [method=DEMO]                    [method=TELEBIRR]
   |          |                                   |
   |    D4 status=PAID                   P3.2 TeleBirr Initiate
   |    D6 create Tickets                |--HMAC-SHA256 sign--->S1
   |    D33 Commission                   |                      |
   |          |                          |<--MMI popup to user  |
   |          |                          |                      |
   |          |                   S1--[callback]-->P3.3 Callback|
   |          |                          |                      |
   |          |                   Security Gates:               |
   |          |                    1. SHA-256 callback hash     |
   |          |                    2. Replay check (D36)        |
   |          |                    3. HMAC signature verify     |
   |          |                    4. Timestamp (5-min window)  |
   |          |                    5. IP whitelist (optional)   |
   |          |                          |                      |
   |          |                   D4 status=PAID                |
   |          |                   D6 create Tickets             |
   |          |                   D36 ProcessedCallback         |
   |          |                   D33 Commission                |
   |          |                          |                      |
   |<--[Tickets with QR]<---------------+                      |
   |                                    |                      |
   |                              S2<--[ticket SMS]            |
```

### P5: GPS Tracking

```
 E5 (Driver Browser)                 S12 (OsmAnd App)
   |                                    |
   |--[lat,lon,speed,heading]-->        |--[GET ?token=X&lat=&lon=]-->
   |  (auth: NextAuth session)          |  (auth: trackingToken)
   |         |                          |         |
   |         +----------+   +-----------+         |
   |                    |   |                     |
   |                    v   v                     |
   |            P5.1/P5.2 Process GPS Position    |
   |            |                                 |
   |            |--create---> D19 (TripPosition)  |
   |            |--update---> D3 (Trip: lastLat,  |
   |            |             lastLon, lastSpeed)  |
   |            |--update---> D9 (Vehicle: lastLat,|
   |            |             lastLon)             |
   |            |--lookup---> D8 (City: dest coords)|
   |            |                                  |
   |            |--calculate ETA:                  |
   |            |  Haversine + avgSpeed x 1.3      |
   |            |--update---> D3 (estimatedArrival)|
   |            |                                  |
   |<--[ETA]----+                                  |

 E1/E2 (Passenger)          E3 (Company Admin)
   |                           |
   |--[poll 12s]-->P5.3        |--[poll 15s]-->P5.4 Fleet Map
   |<--[bus position, ETA]     |<--[all active buses, positions]
```

### P6: No-Show & Replacement Ticket Flow

```
 E3/E6/E7 (Admin/Conductor/Cashier)
   |
   |--[GET tripId]---------> P6.1 Boarding Status
   |                         |--read---> D3, D4, D5
   |<--[passenger list with  |
   |    boarding statuses]---|
   |
   |--[POST tripId,         P6.2 Mark No-Show
   |   passengerIds[]]----->|
   |                        |--guard: Trip.status == DEPARTED
   |                        |--guard: ticket not already used
   |                        |--update---> D5 (boardingStatus=NO_SHOW)
   |                        |--update---> D3 (noShowCount++, releasedSeats++)
   |                        |--log------> D35 (PASSENGER_NO_SHOW)
   |<--[updated counts]-----|
   |
   |--[POST tripId,         P6.3 Replacement Ticket
   |   name, phone]-------->|
   |                        |--guard: releasedSeats > 0
   |                        |--create---> D4 (Booking: isReplacement=true)
   |                        |--create---> D5 (Passenger: BOARDED, no-show seat)
   |                        |--create---> D6 (Ticket: QR + shortCode)
   |                        |--create---> D7 (Payment: CASH, SUCCESS)
   |                        |--update---> D3 (replacementsSold++, releasedSeats--)
   |                        |--log------> D35 (REPLACEMENT_TICKET_SALE)
   |<--[ticket with QR]----|
```

---

## 3. Level 2 DFD - Detailed Sub-Processes

### P3.3 TeleBirr Callback Processing (Detailed)

This is the most security-critical data flow in the system.

```
S1 (TeleBirr)
  |
  |--[POST /api/payments/telebirr/callback]
  |  Body: { transactionId, outTradeNo, totalAmount,
  |          tradeStatus, signature, timestamp, nonce }
  |
  v
+----------------------------------------------------------+
| P3.3.1 Compute Callback Hash                            |
| SHA-256(JSON.stringify(sortedPayload))                   |
+---------------------------+------------------------------+
                            |
                            v
+----------------------------------------------------------+
| P3.3.2 Replay Detection                                 |
| Query D36 (ProcessedCallback) by transactionId           |
| IF exists: return 200 (idempotent) without processing    |
+---------------------------+------------------------------+
                            |
                            v
+----------------------------------------------------------+
| P3.3.3 Signature Verification                            |
| HMAC-SHA256(payload, TELEBIRR_APP_KEY)                   |
| crypto.timingSafeEqual(computedSig, receivedSig)         |
| IF mismatch: log + return 403                            |
+---------------------------+------------------------------+
                            |
                            v
+----------------------------------------------------------+
| P3.3.4 Timestamp Validation                             |
| |now - callbackTimestamp| < 5 minutes                    |
| IF expired: log warning (still process - clock skew)     |
+---------------------------+------------------------------+
                            |
                            v
+----------------------------------------------------------+
| P3.3.5 IP Whitelist Check (Optional)                    |
| IF TELEBIRR_WEBHOOK_IPS env set:                         |
|   Verify request IP in allowed list                      |
| IF blocked: return 403                                   |
+---------------------------+------------------------------+
                            |
                            v
+----------------------------------------------------------+
| P3.3.6 Transaction Processing (10s timeout)              |
|                                                          |
| BEGIN TRANSACTION                                        |
|   SELECT Booking FOR UPDATE NOWAIT (row lock)            |
|   IF tradeStatus == SUCCESS:                             |
|     UPDATE Payment SET status=SUCCESS                    |
|     UPDATE Booking SET status=PAID                       |
|     CREATE Ticket[] (QR code + shortCode per passenger)  |
|     CREATE SalesCommission (if referred user)            |
|     INSERT ProcessedCallback (idempotency record)        |
|   ELSE:                                                  |
|     UPDATE Payment SET status=FAILED                     |
|     UPDATE Booking SET status=CANCELLED                  |
|     UPDATE Trip SET availableSlots += releasedSeats      |
|     INSERT ProcessedCallback                             |
| COMMIT                                                   |
|                                                          |
| POST-COMMIT:                                             |
|   Send ticket SMS via S2                                 |
|   Log to D35 (AdminLog)                                  |
+----------------------------------------------------------+
```

### P13 Cron Jobs (Detailed Lifecycle)

```
S14 (Cron Scheduler)
  |
  |--[GET /api/cron/cleanup, Bearer: CRON_SECRET]
  |
  v
+----------------------------------------------------------+
| P13.1 Payment/Booking Cleanup (every 15 min)             |
|                                                          |
| 1. Find PENDING payments older than 5 min                |
|    -> D7: status=TIMEOUT                                 |
|    -> D4: status=CANCELLED                               |
|    -> D3: availableSlots += released seats                |
|    -> S2: Send timeout SMS to customer                   |
|                                                          |
| 2. Find PENDING bookings older than 10 min               |
|    -> D4: status=CANCELLED                               |
|    -> D7: cancel associated payment                      |
|    -> D3: availableSlots += released seats                |
+----------------------------------------------------------+

+----------------------------------------------------------+
| P13.2 Trip Status Lifecycle (every 15 min)               |
|                                                          |
| SCHEDULED + 30min late ---------> DELAYED                |
| SCHEDULED/BOARDING/DELAYED        DEPARTED               |
|   + past departure time --------> (bookingHalted=true)   |
|                                   D1: staff -> ON_TRIP    |
| DEPARTED + past ETA + 2hr ------> COMPLETED              |
|                                   (trackingActive=false)  |
|                                   D1: staff -> AVAILABLE  |
| SCHEDULED/BOARDING + 24hr old     CANCELLED               |
|   + zero bookings --------------> (cleanup)              |
+----------------------------------------------------------+

+----------------------------------------------------------+
| P13.4 GPS Data Retention (every 15 min)                  |
|                                                          |
| DELETE FROM TripPosition                                 |
| WHERE trip.status IN (COMPLETED, CANCELLED)              |
|   AND recordedAt < NOW() - 7 days                        |
+----------------------------------------------------------+

+----------------------------------------------------------+
| P13.6 Predictive Maintenance (daily)                     |
|                                                          |
| FOR EACH Vehicle:                                        |
|   Calculate risk score (0-100) based on:                 |
|     - Odometer since last service                        |
|     - Time since last service                            |
|     - Defect history from inspections                    |
|     - Fuel efficiency trend                              |
|     - Vehicle age and total mileage                      |
|   -> D9: update riskScore, predictedFailureDate          |
|   -> D17: create VehicleRiskHistory snapshot             |
+----------------------------------------------------------+
```

---

## 4. Data Store Summary

### 4.1 Core Business Data

| Store ID | Name | Sensitivity | Encrypted Fields |
|----------|------|-------------|-----------------|
| D1 | User | HIGH | password (bcrypt hash) |
| D2 | Company | HIGH | bankAccount, tinNumber |
| D3 | Trip | MEDIUM | - |
| D4 | Booking | HIGH | financial amounts |
| D5 | Passenger | HIGH | nationalId, phone |
| D6 | Ticket | HIGH | shortCode (auth token) |
| D7 | Payment | HIGH | transactionId, amounts |
| D8 | City | LOW | - |

### 4.2 Fleet Management Data

| Store ID | Name | Sensitivity |
|----------|------|-------------|
| D9 | Vehicle | MEDIUM |
| D10 | TripLog | MEDIUM |
| D11 | MaintenanceSchedule | LOW |
| D12 | WorkOrder | MEDIUM |
| D13 | WorkOrderPart | LOW |
| D14 | VehicleInspection | MEDIUM |
| D15 | FuelEntry | MEDIUM |
| D16 | OdometerLog | LOW |
| D17 | VehicleRiskHistory | LOW |
| D18 | VehicleDowntime | LOW |

### 4.3 GPS & Communication Data

| Store ID | Name | Sensitivity |
|----------|------|-------------|
| D19 | TripPosition | MEDIUM (location tracking) |
| D20 | TripMessage | MEDIUM |
| D22 | Notification | LOW |
| D23 | CompanyMessage | MEDIUM |
| D26 | SupportTicket | HIGH (PII) |

### 4.4 Session & Security Data

| Store ID | Name | Sensitivity |
|----------|------|-------------|
| D27 | SmsSession | MEDIUM |
| D28 | TelegramSession | MEDIUM |
| D29 | PasswordReset | HIGH (auth tokens) |
| D35 | AdminLog | HIGH (audit trail) |
| D36 | ProcessedCallback | HIGH (payment security) |

### 4.5 Sales & Financial Data

| Store ID | Name | Sensitivity |
|----------|------|-------------|
| D30 | SalesPerson | HIGH (PII, financial) |
| D33 | SalesCommission | HIGH (financial) |
| D34 | SalesPayout | HIGH (financial) |

---

## 5. Trust Boundaries

```
+================================================================+
|                     INTERNET (Untrusted)                        |
|  E1, E2, E10 (Customers, Guests, Sales)                       |
|  S1 (TeleBirr callbacks)                                       |
|  S2 (SMS webhooks)                                             |
|  S3 (Telegram webhooks)                                        |
|  S12 (OsmAnd GPS)                                              |
+====================+============================================+
                     | HTTPS/TLS (Cloudflare Full Strict)
                     | TLS 1.2+ minimum
                     | HSTS with preload
+====================+===========================================+
|                  CLOUDFLARE DMZ (S9)                            |
|  - SSL termination                                             |
|  - DDoS protection                                             |
|  - Web Analytics                                               |
+====================+===========================================+
                     | HTTPS to origin
+====================+===========================================+
|               NGINX REVERSE PROXY                              |
|  - Rate limiting (30 req/s per IP)                             |
|  - Request forwarding to Node.js                               |
+====================+===========================================+
                     | localhost:3000
+====================+===========================================+
|              APPLICATION SERVER (Node.js / Next.js)            |
|  - CSP headers (middleware.ts)                                 |
|  - NextAuth.js session validation                              |
|  - Zod input validation                                        |
|  - Role-based access control                                   |
|  - Company segregation enforcement                             |
|  - Rate limiting (per-endpoint)                                |
|  E3, E4, E5, E6, E7, E8, E9, E11 (Authenticated users)      |
+====================+===========================================+
                     | Prisma ORM (parameterized queries)
+====================+===========================================+
|              DATABASE SERVER (PostgreSQL 16.11)                 |
|  - Row-level locking (SELECT FOR UPDATE NOWAIT)                |
|  - Transaction timeouts (10s)                                  |
|  - All data stores (D1-D39)                                    |
+================================================================+
```

---

## 6. Entry Points

All external inputs to the system that INSA should test:

| # | Entry Point | Protocol | Auth Required | Rate Limited |
|---|-------------|----------|---------------|-------------|
| 1 | `/api/auth/[...nextauth]` (login/register) | HTTPS POST | No | Yes (5/30min phone, 10/15min IP) |
| 2 | `/api/trips` (search) | HTTPS GET | No | Nginx 30r/s |
| 3 | `/api/bookings` (create) | HTTPS POST | Optional (guest allowed) | Yes (10/min/IP) |
| 4 | `/api/payments` (initiate) | HTTPS POST | Yes (session) | Yes (3/hour/booking) |
| 5 | `/api/payments/telebirr/callback` | HTTPS POST | HMAC signature | Yes + replay guard |
| 6 | `/api/tickets/verify` | HTTPS PATCH | Yes (staff) | Nginx 30r/s |
| 7 | `/api/track/[code]` (public tracking) | HTTPS GET | No | Nginx 30r/s |
| 8 | `/api/tracking/update` (driver GPS) | HTTPS POST | Yes (session) | Yes (12/min/user) |
| 9 | `/api/tracking/osmand` (background GPS) | HTTPS GET | Token | Yes (12/min/token) |
| 10 | `/api/tracking/[tripId]` (passenger tracking) | HTTPS GET | No | Nginx 30r/s |
| 11 | `/api/tracking/fleet` (fleet map) | HTTPS GET | Yes (company admin) | Nginx 30r/s |
| 12 | `/api/telegram/webhook` | HTTPS POST | Telegram-signed | Nginx 30r/s |
| 13 | `/api/sms/incoming` | HTTPS POST | HMAC signature | Yes (10/min/phone) |
| 14 | `/api/company/*` (all company routes) | HTTPS Various | Yes (company admin) | Nginx 30r/s |
| 15 | `/api/admin/*` (all admin routes) | HTTPS Various | Yes (super admin) | Nginx 30r/s |
| 16 | `/api/cron/*` (scheduled jobs) | HTTPS GET | Bearer token | Nginx 30r/s |
| 17 | `/api/support/tickets` (create) | HTTPS POST | No | Nginx 30r/s |
| 18 | `/api/cities/coordinates` (geocoding) | HTTPS GET | No | Nginx 30r/s |

---

*End of Document 4.2.1a - Data Flow Diagram*
