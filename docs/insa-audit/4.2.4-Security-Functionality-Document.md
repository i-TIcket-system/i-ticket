# i-Ticket Platform - Security Functionality Document

**Document**: 4.2.4 - Security Functionality Document
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. User Roles and Access Control (RBAC)

### 1.1 Role Hierarchy

```
SUPER_ADMIN (Platform Owner)
  |
  +-- PlatformStaff (i-Ticket employees, JSON-based permissions)
  |
  +-- COMPANY_ADMIN (Bus Company)
        |
        +-- ADMIN (Company-level admin)
        +-- DRIVER
        +-- CONDUCTOR
        +-- MANUAL_TICKETER (Cashier)
        +-- MECHANIC
        +-- FINANCE

CUSTOMER (Registered user)

GUEST (No account - phone as identity)

SALES_PERSON (Separate auth table)
```

### 1.2 Role Permissions Matrix

| Resource / Action | Guest | Customer | Driver | Conductor | Cashier | Mechanic | Finance | Co. Admin | Super Admin |
|-------------------|-------|----------|--------|-----------|---------|----------|---------|-----------|-------------|
| Search trips | Yes | Yes | - | - | - | - | - | Yes | Yes |
| Book tickets | Yes | Yes | - | - | - | - | - | - | - |
| View own tickets | - | Yes | - | - | - | - | - | - | - |
| Track bus (public) | Yes | Yes | - | - | - | - | - | - | - |
| GPS tracking (driver) | - | - | Yes | Yes | - | - | - | - | - |
| Verify tickets (QR) | - | - | - | Yes | Yes | - | - | Yes | Yes |
| Manual ticket sales | - | - | - | - | Yes | - | - | Yes | - |
| Replacement ticket sales | - | - | - | - | Yes | - | - | Yes | - |
| Mark no-show | - | - | - | Yes | Yes | - | - | Yes | - |
| Manage trips (CRUD) | - | - | - | - | - | - | - | Yes | Yes |
| Manage staff | - | - | - | - | - | - | - | Yes | - |
| Manage vehicles | - | - | - | - | - | - | - | Yes | - |
| Vehicle inspections | - | - | Yes | - | - | Yes | - | Yes | - |
| Work orders | - | - | - | - | - | Yes | - | Yes | - |
| Fleet analytics | - | - | - | - | - | - | - | Yes | - |
| Fleet tracking (map) | - | - | - | - | - | - | - | Yes | - |
| Financial reports | - | - | - | - | - | - | Yes | Yes | - |
| View audit logs | - | - | - | - | - | - | - | Yes* | Yes |
| Manage companies | - | - | - | - | - | - | - | - | Yes |
| Platform analytics | - | - | - | - | - | - | - | - | Yes |
| Manage platform staff | - | - | - | - | - | - | - | - | Yes |
| Tax reports | - | - | - | - | - | - | - | - | Yes |

*Company Admin sees only their company's audit logs (company-scoped).

### 1.3 Company Segregation (Data Isolation)

**Rule**: Every company API endpoint filters data by `companyId` extracted from the authenticated user's JWT session. No company can access another company's data.

**Implementation**:
```
// Every company API route follows this pattern:
const session = await getServerSession(authOptions)
const companyId = session.user.companyId  // From JWT token

// All queries include companyId filter
const trips = await prisma.trip.findMany({
  where: { companyId }  // Cannot access other companies
})
```

**Shared resource exception**: The `City` table is shared across all companies (read-only reference data).

### 1.4 Platform Staff Permissions (Fine-Grained)

Platform staff (i-Ticket employees) have JSON-based permissions stored in `PlatformStaff.permissions`:

```json
{
  "canViewFinance": true,
  "canManageStaff": false,
  "canAccessReports": true,
  "canManageCompanies": false,
  "canViewAuditLogs": true
}
```

These are checked at the API level before granting access to specific Super Admin features.

---

## 2. Input Validation and Sanitization

### 2.1 Validation Framework

**Library**: Zod v3.25.x (runtime TypeScript schema validation)

**Policy**: All API inputs are validated server-side before processing. Client-side validation exists for UX but is never trusted.

### 2.2 Validation Examples by Endpoint

| Endpoint | Field | Validation Rule |
|----------|-------|----------------|
| Registration | phone | Regex: `/^09\d{8}$/` (Ethiopian format, exactly 10 digits) |
| Registration | password | Minimum length enforced |
| Registration | name | String, required |
| Booking | tripId | CUID format string |
| Booking | passengers | Array, max 5 items |
| Booking | passengers[].name | String, required |
| Booking | passengers[].nationalId | String, required |
| Booking | passengers[].seatNumber | Integer, positive |
| Payment | bookingId | CUID format string |
| Payment | method | Enum: "TELEBIRR" or "DEMO" |
| GPS Tracking | latitude | Float, -90 to 90 |
| GPS Tracking | longitude | Float, -180 to 180 |
| GPS Tracking | speed | Float, >= 0 |
| Trip CRUD | price | Float, positive |
| Trip CRUD | totalSlots | Integer, positive |
| Trip CRUD | departureTime | DateTime, ISO format |
| Search params | Various | `.nullish()` (handles null from searchParams.get()) |
| Integer params | Various | `parseInt` with scientific notation rejection |

### 2.3 SQL Injection Prevention

**Method**: Prisma ORM exclusively. No raw SQL queries anywhere in the codebase.

Prisma automatically parameterizes all queries:
```typescript
// This is how all DB queries are made (parameterized by Prisma)
const trip = await prisma.trip.findUnique({
  where: { id: tripId }  // Prisma parameterizes this
})
```

### 2.4 XSS Prevention

| Layer | Method |
|-------|--------|
| React | Auto-escapes all rendered content by default |
| CSP | `default-src 'self'`; `script-src 'self' 'unsafe-inline'` (unsafe-inline required by Next.js 14) |
| CSP | `object-src 'none'` (blocks plugins) |
| CSP | `base-uri 'self'` (prevents base tag injection) |
| Headers | `X-Content-Type-Options: nosniff` (prevents MIME type sniffing) |
| Headers | `X-XSS-Protection: 1; mode=block` (legacy browser protection) |

### 2.5 CSRF Prevention

| Method | Implementation |
|--------|---------------|
| SameSite cookies | `sameSite: 'lax'` on NextAuth session cookie |
| CSP form-action | `form-action 'self'` restricts form submission targets |
| API design | All mutations use POST/PUT/PATCH/DELETE (not GET) |
| No CSRF tokens | Relied upon SameSite cookie protection (standard for SPA/JWT architectures) |

### 2.6 File Upload Handling

| Control | Implementation |
|---------|---------------|
| Max body size | Nginx: `client_max_body_size 5M` |
| Allowed types | Profile pictures, receipt photos (validated by file extension) |
| Storage | Local filesystem (`/public/uploads/`) |
| Path traversal | Filenames sanitized, stored with generated IDs |

---

## 3. Session Management

### 3.1 Session Configuration

| Property | Value | File |
|----------|-------|------|
| **Strategy** | JWT (stateless) | `src/lib/auth.ts` |
| **Provider** | NextAuth.js CredentialsProvider | `src/lib/auth.ts` |
| **Max Age** | 30 days (2,592,000 seconds) | `src/lib/auth.ts` |
| **Cookie Name** | `next-auth.session-token` | NextAuth default |
| **httpOnly** | `true` (not accessible via JavaScript) | `src/lib/auth.ts` |
| **secure** | `true` in production (HTTPS only) | `src/lib/auth.ts` |
| **sameSite** | `lax` (sent on navigation, not cross-origin POST) | `src/lib/auth.ts` |
| **path** | `/` (all routes) | `src/lib/auth.ts` |
| **Domain** | Not set (defaults to i-ticket.et) | `src/lib/auth.ts` |

### 3.2 JWT Token Contents

| Field | Description | Sensitivity |
|-------|-------------|-------------|
| id | User ID (CUID) | Low |
| role | CUSTOMER / COMPANY_ADMIN / SUPER_ADMIN | Access control |
| phone | User phone number | PII |
| companyId | Company ID (null for customers) | Data segregation |
| companyName | Company name | Low |
| companyLogo | Company logo URL | Low |
| staffRole | Staff sub-role (DRIVER, MECHANIC, etc.) | Access control |
| profilePicture | Profile picture URL | Low |
| nationalId | National ID | PII |
| mustChangePassword | Temp password flag | Auth control |
| platformStaffRole | Platform staff role (Super Admin only) | Access control |
| platformStaffPermissions | JSON permissions (Super Admin only) | Access control |

### 3.3 Session Lifecycle

```
1. LOGIN
   Phone + Password -> bcrypt.compare() -> JWT token issued
   Cookie: httpOnly, secure, sameSite=lax, maxAge=30 days
   Rate limit counter cleared on success

2. EVERY REQUEST
   Cookie sent automatically (same-origin)
   JWT decoded and verified (NEXTAUTH_SECRET signature)
   Session data available in API routes via getServerSession()

3. TOKEN REFRESH
   On trigger="update": re-fetches user data from DB
   Updates profile picture, nationalId, company info, permissions

4. LOGOUT
   Cookie cleared (set to empty, maxAge=0)
   No server-side session invalidation (JWT is stateless)

5. EXPIRY
   After 30 days: cookie expires, user must re-login
```

### 3.4 Other Session Types

| Session Type | Storage | TTL | Purpose |
|-------------|---------|-----|---------|
| SMS Session | PostgreSQL (SmsSession table) | 15 minutes | SMS booking conversation state |
| Telegram Session | PostgreSQL (TelegramSession table) | 30 minutes | Telegram bot booking state |
| Password Reset Token | PostgreSQL (PasswordReset table) | 1 hour | One-time password reset |
| OsmAnd Tracking Token | PostgreSQL (Trip.trackingToken) | Trip lifetime | Background GPS auth |

---

## 4. Authentication Mechanisms

### 4.1 Password Authentication

| Property | Value |
|----------|-------|
| Hash algorithm | bcrypt |
| Salt rounds | 12 |
| Library | bcryptjs |
| Storage | `User.password` (nullable for guests) |
| Comparison | `bcryptjs.compare()` (timing-safe) |

### 4.2 Login Rate Limiting

| Limiter | Threshold | Window | Lockout |
|---------|-----------|--------|---------|
| Per phone | 5 attempts | 30 minutes | 15-minute lockout |
| Per IP | 10 attempts | 15 minutes | Rejection until window expires |
| Cleanup | Automatic | Every 60 seconds | Expired entries removed |

**Implementation**: In-memory Map (Node.js process). Cleared on successful login. Rate limit entries auto-cleaned hourly.

### 4.3 Registration Security

| Control | Implementation |
|---------|---------------|
| Rate limit | 3 registrations per hour per IP |
| Duplicate prevention | Checks both User and SalesPerson tables for existing phone |
| Phone validation | Regex `/^09\d{8}$/` |
| Password hashing | bcrypt (12 rounds) before storage |
| Referral attribution | Atomic transaction (registration + referral in one TX) |

### 4.4 Password Reset Flow

```
1. User submits phone number
2. Server generates crypto.randomBytes(32) token
3. Token hashed with bcrypt before storage in PasswordReset table
4. Plain token sent via SMS to user's phone
5. User submits token + new password
6. Server compares token hash with bcrypt.compare()
7. If valid: update User.password, mark token isUsed=true
8. Token expires after 1 hour, single-use only
9. User existence is never revealed (same response for found/not-found)
```

### 4.5 Force Password Change

Company admins created with temporary passwords have `mustChangePassword=true`. They are redirected to the force-change-password page on every login attempt until they set a new password.

### 4.6 Secret Validation

At module load time (`src/lib/auth.ts`):
- `NEXTAUTH_SECRET` must be >= 32 characters
- Rejects placeholder values containing `your-super-secret-key` or `change-in-production`
- Application will not start with an insecure secret in production

---

## 5. Error Handling and Logging

### 5.1 Error Handling Strategy

| Environment | Behavior |
|-------------|----------|
| **Production** | Errors logged to PM2; generic error messages returned to client; no stack traces in API responses |
| **Development** | Queries, warnings, and errors logged to console; detailed error messages in responses |

### 5.2 API Error Response Format

```json
// Standard error response (production)
{
  "error": "Descriptive message without internal details"
}

// HTTP status codes used:
// 400 - Bad Request (validation failure)
// 401 - Unauthorized (no session)
// 403 - Forbidden (insufficient role/permission)
// 404 - Not Found
// 409 - Conflict (duplicate, concurrent modification)
// 429 - Too Many Requests (rate limited)
// 500 - Internal Server Error (generic, no details)
```

### 5.3 Rate Limit Error Response

```
HTTP 429 Too Many Requests
Headers:
  Retry-After: <seconds until rate limit resets>
Body:
  { "error": "Too many requests. Please try again later." }
```

### 5.4 Audit Logging (AdminLog)

All sensitive operations are logged to the `AdminLog` table:

| Action Category | Logged Events |
|----------------|--------------|
| **Authentication** | Login attempts (success/failure with IP), registration, password resets |
| **Booking** | Booking creation, payment success/failure, cancellation |
| **Trip Management** | Trip creation, status changes (DEPARTED, COMPLETED, CANCELLED), auto-halt triggers |
| **No-Show** | Passenger marked NO_SHOW, replacement ticket sold |
| **Staff Management** | Staff created, role changed, status changed |
| **Company Management** | Company activated/deactivated, admin created |
| **Financial** | Commission approved, payout processed |
| **System** | Cron job status transitions, auto-halt triggers, auto-resume |

**Log entry structure**:
```json
{
  "id": "cuid",
  "userId": "who performed the action",
  "action": "ACTION_TYPE",
  "details": "Human-readable description with context",
  "tripId": "related trip (optional)",
  "companyId": "related company (optional)",
  "createdAt": "timestamp"
}
```

### 5.5 CSP Violation Logging

CSP violations are reported to `/api/csp-report` and logged via `console.warn('[CSP Violation]', ...)` to PM2 output logs.

### 5.6 Application Logs

| Log Type | Location | Retention |
|----------|----------|-----------|
| PM2 Error Log | `/var/log/pm2/i-ticket-error.log` | Until log rotation |
| PM2 Output Log | `/var/log/pm2/i-ticket-out.log` | Until log rotation |
| Nginx Access Log | `/var/log/nginx/access.log` | System logrotate |
| Nginx Error Log | `/var/log/nginx/error.log` | System logrotate |
| AdminLog (DB) | PostgreSQL `AdminLog` table | Indefinite |
| ProcessedCallback (DB) | PostgreSQL `ProcessedCallback` table | Indefinite |

---

## 6. Secure Communications (TLS/SSL)

### 6.1 TLS Configuration

| Property | Value |
|----------|-------|
| **SSL Mode** | Cloudflare Full (Strict) |
| **Minimum TLS** | 1.2 (enforced at Cloudflare edge) |
| **Certificate** | Cloudflare Universal SSL (edge) + Cloudflare Origin Certificate (server) |
| **HSTS** | Enabled: `max-age=31536000; includeSubDomains; preload` |
| **HSTS (App Level)** | `Strict-Transport-Security: max-age=63072000; includeSubDomains; preload` (2 years) |
| **Upgrade** | CSP `upgrade-insecure-requests` directive |

### 6.2 Traffic Flow

```
Client Browser
  |
  | TLS 1.2+ (Cloudflare terminates)
  |
Cloudflare Edge (SSL Full Strict)
  |
  | HTTPS (Cloudflare Origin Certificate)
  |
Nginx (Port 80 internally, SSL handled by Cloudflare)
  |
  | HTTP localhost:3000
  |
Node.js / Next.js
  |
  | Prisma ORM (localhost PostgreSQL, no TLS needed for local)
  |
PostgreSQL 16.11 (localhost:5432)
```

### 6.3 External Service Communication

| Service | Protocol | Certificate Validation |
|---------|----------|----------------------|
| TeleBirr API | HTTPS | Node.js default CA bundle |
| SMS Gateway | HTTPS | Node.js default CA bundle |
| Telegram API | HTTPS | Node.js default CA bundle |
| ClickUp API | HTTPS | Node.js default CA bundle |
| OSRM API | HTTPS | Node.js default CA bundle |
| Nominatim API | HTTPS | Node.js default CA bundle |
| OpenStreetMap Tiles | HTTPS | Browser CA bundle |

### 6.4 Security Headers (Complete)

| Header | Value | Purpose |
|--------|-------|---------|
| `Strict-Transport-Security` | `max-age=63072000; includeSubDomains; preload` | Force HTTPS for 2 years |
| `X-Frame-Options` | `DENY` | Prevent clickjacking |
| `X-Content-Type-Options` | `nosniff` | Prevent MIME sniffing |
| `X-XSS-Protection` | `1; mode=block` | Legacy XSS filter |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | Limit referrer leakage |
| `Permissions-Policy` | `camera=(), microphone=(), geolocation=(self), payment=(), usb=(), bluetooth=(), magnetometer=(), gyroscope=(), accelerometer=()` | Restrict browser APIs |
| `Content-Security-Policy` | (see Section 2.4 above for full policy) | Restrict content sources |
| `Cache-Control` | `no-store` (all pages); `no-store, no-cache, must-revalidate, proxy-revalidate` (auth pages) | Prevent caching of sensitive content |
| `Pragma` | `no-cache` | HTTP/1.0 cache prevention |
| `Expires` | `0` (auth pages only) | Force revalidation |
| `X-Powered-By` | REMOVED | Hide server technology |
| Server | STRIPPED by Nginx | Hide server software |

---

## 7. Payment Security Controls

### 7.1 TeleBirr Callback Verification (5 Security Gates)

```
Gate 1: CALLBACK HASH
  SHA-256(JSON.stringify(sortedPayload))
  Purpose: Canonical representation for deduplication

Gate 2: REPLAY DETECTION
  Query ProcessedCallback by transactionId
  If found: return 200 (idempotent, no reprocessing)
  Uses unique indexes on transactionId AND callbackHash

Gate 3: SIGNATURE VERIFICATION
  Compute: HMAC-SHA256(payload, TELEBIRR_APP_KEY)
  Compare: crypto.timingSafeEqual(computed, received)
  Purpose: Verify callback authenticity
  Note: timing-safe comparison prevents timing attacks

Gate 4: TIMESTAMP VALIDATION
  |current_time - callback_timestamp| < 5 minutes
  Purpose: Prevent stale callback replay
  Note: logs warning but still processes (clock skew tolerance)

Gate 5: IP WHITELIST (Optional)
  If TELEBIRR_WEBHOOK_IPS env is set:
    Verify request IP is in the allowed list
  Purpose: Additional layer of origin verification
```

### 7.2 Payment Flow Security

| Control | Implementation |
|---------|---------------|
| Payment window | 10-minute timeout (enforced server-side) |
| Amount verification | Server recalculates: ticket price + 5% commission + 15% VAT |
| Rate limiting | 3 payment attempts per hour per booking |
| Enhanced rate limiting | Per-IP + per-user + per-booking limits |
| Ownership check | Booking must belong to requesting user |
| Concurrent protection | Row-level locking on booking during payment |
| Demo mode guard | `DEMO_MODE` blocked when `NODE_ENV=production` |
| Nonce | `crypto.randomBytes(16)` per payment request |
| Idempotency | ProcessedCallback table records every callback (inside transaction) |

### 7.3 Commission Security

| Aspect | Implementation |
|--------|---------------|
| Calculation | Always server-side (never from client input) |
| Formula | Base: 5% of ticket price; VAT: 15% of commission; TeleBirr fee: 0.5% (absorbed by platform) |
| Replacement sales | Commission = 0 (matches cashier pattern) |
| Sales commission | 5% of platform's 5% = 0.25% of ticket; 70/30 recruiter split |
| Audit trail | SalesCommission table with status tracking (PENDING -> APPROVED -> PAID) |

---

## 8. Concurrency and Data Integrity Controls

### 8.1 Row-Level Locking

```sql
-- Used when creating bookings (prevents double-selling seats)
SELECT * FROM "Trip" WHERE id = $1 FOR UPDATE NOWAIT
```

`NOWAIT`: If another transaction holds the lock, immediately fails (no waiting/deadlock). The application catches this and returns a conflict error to the user.

### 8.2 Transaction Timeouts

```typescript
// Dual timeout pattern:
const result = await Promise.race([
  prisma.$transaction(callback, {
    maxWait: 5000,   // 5s to acquire transaction
    timeout: 10000   // 10s to complete transaction
  }),
  new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Transaction timeout')), 10000)
  )
])
```

### 8.3 Optimistic Locking

`Trip.version` field incremented on every update. Concurrent modifications detected and rejected.

### 8.4 Idempotency

| Operation | Idempotency Mechanism |
|-----------|----------------------|
| Payment callback | `ProcessedCallback.transactionId` (unique index) |
| Payment callback | `ProcessedCallback.callbackHash` (unique index) |
| No-show marking | Re-marking already NO_SHOW passenger is a no-op |
| Ticket verification | Checks `isUsed` flag before marking |

---

## 9. Data Protection

### 9.1 Sensitive Data Handling

| Data Type | At Rest | In Transit | Access Control |
|-----------|---------|------------|----------------|
| Passwords | bcrypt hash (12 rounds) | HTTPS/TLS 1.2+ | Never exposed in API responses |
| National IDs | Plaintext in DB | HTTPS/TLS 1.2+ | Company admin + super admin only |
| Phone numbers | Plaintext in DB | HTTPS/TLS 1.2+ | Varies by context |
| Bank accounts | Plaintext in DB | HTTPS/TLS 1.2+ | Company admin + super admin only |
| Payment data | Amount + method in DB | HTTPS/TLS 1.2+ | Booking owner + admin |
| GPS positions | Lat/lon in DB | HTTPS/TLS 1.2+ | Public for DEPARTED trips; auto-purged after 7 days |
| Reset tokens | bcrypt hash in DB | HTTPS/TLS 1.2+ (via SMS) | Single-use, 1-hour expiry |
| QR codes | Base64 data URL in DB | HTTPS/TLS 1.2+ | Ticket owner + verifying staff |
| Ticket shortCodes | Plaintext in DB | HTTPS/TLS 1.2+ | Public (verification URL) |
| Session cookies | JWT (signed, not encrypted) | HTTPS only (secure flag) | httpOnly (no JS access) |

### 9.2 Data Retention

| Data | Retention | Cleanup Mechanism |
|------|-----------|-------------------|
| GPS positions (TripPosition) | 7 days after trip ends | Cron job auto-purge |
| SMS sessions | 15 minutes | Cron job cleanup |
| Telegram sessions | 30 minutes | Cron job cleanup |
| Password reset tokens | 1 hour | Expiry + isUsed flag |
| Pending payments | 10 minutes | Cron job cancellation + seat release |
| Pending bookings | 10 minutes | Cron job cancellation + seat release |
| Audit logs (AdminLog) | Indefinite | No automatic cleanup |
| Payment callbacks (ProcessedCallback) | Indefinite | No automatic cleanup |

---

## 10. Technical Function Descriptions

### 10.1 Core Security Functions

| Function | File | Description |
|----------|------|-------------|
| `authOptions` | `src/lib/auth.ts` | NextAuth configuration: credentials provider, JWT strategy, 30-day sessions, rate limiting, secret validation |
| `transactionWithTimeout()` | `src/lib/db.ts` | Prisma transaction wrapper with dual timeout (Promise.race + native), 10s default |
| `checkRateLimit()` | `src/lib/rate-limit.ts` | In-memory rate limiter with per-endpoint configs, emergency cleanup at 80% capacity |
| `checkEnhancedRateLimit()` | `src/lib/rate-limit.ts` | Dual IP + user rate limiting for sensitive operations |
| `checkBookingRateLimit()` | `src/lib/rate-limit.ts` | Per-booking payment rate limiting |
| `signTelebirrRequest()` | `src/lib/payments/telebirr.ts` | HMAC-SHA256 signing for outbound TeleBirr requests |
| `verifyTelebirrSignature()` | `src/lib/payments/telebirr.ts` | HMAC-SHA256 verification with `crypto.timingSafeEqual()` |
| `computeCallbackHash()` | `src/lib/payments/callback-hash.ts` | SHA-256 hash of payment callback payload for deduplication |
| `hasDepartedEthiopia()` | `src/lib/utils.ts` | Timezone-safe departure check (prevents UTC/Ethiopia mismatch) |
| `isTodayEthiopia()` | `src/lib/utils.ts` | Timezone-safe date comparison for Ethiopia (UTC+3) |

### 10.2 CSP Middleware Function

| Property | Value |
|----------|-------|
| File | `src/middleware.ts` |
| Scope | All page routes (excludes `/api`, `/_next/static`, `favicon.ico`) |
| Function | Injects CSP header, Cache-Control, Report-To, Reporting-Endpoints on every page response |

### 10.3 Cron Security Functions

| Function | File | Auth | Description |
|----------|------|------|-------------|
| Cleanup | `/api/cron/cleanup` | Bearer CRON_SECRET | Timeout payments, cancel stale bookings, release seats, auto-transition trip statuses, reset staff, purge GPS data |
| Trip Reminders | `/api/cron/trip-reminders` | Bearer CRON_SECRET | Send departure reminders via SMS |
| Predictive Maintenance | `/api/cron/predictive-maintenance` | Bearer CRON_SECRET | AI risk score recalculation for all vehicles |
| Telegram Cleanup | `/api/cron/telegram-cleanup` | Bearer CRON_SECRET | Delete expired Telegram sessions |

---

*End of Document 4.2.4 - Security Functionality Document*
