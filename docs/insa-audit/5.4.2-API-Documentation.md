# i-Ticket Platform - Updated API Documentation

**Document**: 5.4.2 - Updated API Documentation
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. API Architecture Overview

| Property | Value |
|----------|-------|
| **Framework** | Next.js 14 App Router (file-based routing) |
| **Base URL** | `https://i-ticket.et/api` |
| **Protocol** | HTTPS only (TLS 1.2+ via Cloudflare) |
| **API Versioning** | None — single-version API at `/api/` base path |
| **Data Format** | JSON (`application/json`) for all request/response bodies |
| **Authentication** | Cookie-based JWT sessions (NextAuth.js) |
| **Rate Limiting** | Per-endpoint in-memory rate limiter (IP + user-based) |
| **Total Route Files** | 145+ `route.ts` files across 20+ feature domains |

---

## 2. Authentication Mechanism

### 2.1 Session-Based Authentication

All protected routes use NextAuth.js cookie-based JWT sessions. The session cookie is set on login and validated per-request.

| Property | Value |
|----------|-------|
| Strategy | JWT (stateless) |
| Cookie name | `next-auth.session-token` (production: `__Secure-next-auth.session-token`) |
| Cookie flags | `httpOnly: true`, `secure: true`, `sameSite: 'lax'` |
| Max age | 30 days |
| Token payload | `{ id, name, phone, role, companyId, staffRole }` |

### 2.2 Auth Helper Functions

Authentication is enforced per-route using helpers from `src/lib/auth-helpers.ts`:

| Helper | Required Role | Usage |
|--------|---------------|-------|
| `requireAuth()` | Any authenticated user | General protected routes |
| `requireRole(["CUSTOMER"])` | Specific role(s) | Role-restricted endpoints |
| `requireCompanyAdmin()` | `COMPANY_ADMIN` + `companyId` | Company management routes |
| `requireSuperAdmin()` | `SUPER_ADMIN` | Platform admin routes |
| `requireSalesPerson()` | `SALES_PERSON` | Sales portal routes |
| `requireFullAdmin()` | `COMPANY_ADMIN` (no supervisor) | Sensitive company settings |

### 2.3 Alternative Auth Mechanisms

| Mechanism | Used By | How |
|-----------|---------|-----|
| Cron secret | `/api/cron/*` | `Authorization: Bearer <CRON_SECRET>` header |
| OsmAnd token | `/api/tracking/osmand` | `?token=<trackingToken>` query parameter |
| SMS session | `/api/bookings` | `smsSessionId` in request body |
| Telegram secret | `/api/telegram/webhook` | Telegram-provided secret token header |
| TeleBirr HMAC | `/api/payments/telebirr/callback` | HMAC-SHA256 signature verification |

### 2.4 Error Responses

| Status | Response |
|--------|----------|
| 401 | `{ "error": "Authentication required" }` |
| 403 | `{ "error": "Insufficient permissions" }` |
| 429 | `{ "error": "Too many requests. Please try again later.", "retryAfter": N }` |

---

## 3. Rate Limiting Configuration

In-memory rate limiter (`src/lib/rate-limit.ts`), keyed by IP address (`x-forwarded-for` or `x-real-ip` header).

| Endpoint Category | Limit | Window | Key |
|-------------------|-------|--------|-----|
| Login | 5 requests | 15 min | Per phone + per IP |
| Registration | 3 requests | 1 hour | Per IP |
| Password reset | 3 requests | 1 hour | Per IP |
| Booking creation | 10 requests | 1 min | Per IP |
| Payment processing | 5 requests | 1 min | Per IP + per user |
| Payment (per booking) | 3 requests | 1 hour | Per booking ID |
| Support ticket | 5 requests | 1 hour | Per IP |
| Webhooks | 100 requests | 1 min | Per source |
| Vehicle management | 20 requests | 1 hour | Per IP |
| GPS tracking update | 12 requests | 1 min | Per user/token |
| Public tracking read | 30 requests | 1 min | Per IP |
| Default API | 60 requests | 1 min | Per IP |

Rate-limited responses include `Retry-After` header with seconds until window reset.

---

## 4. Complete API Route Inventory

### 4.1 Authentication Routes (`/api/auth/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/api/auth/[...nextauth]` | None | LOGIN | NextAuth.js handler (login/logout/session) |
| POST | `/api/auth/register` | None | REGISTER | User registration |
| POST | `/api/auth/forgot-password` | None | FORGOT_PASSWORD | Request password reset |
| POST | `/api/auth/reset-password` | None | — | Complete password reset (token-based) |
| POST | `/api/auth/force-change-password` | Authenticated | — | Forced password change for staff |

### 4.2 Public Trip Routes (`/api/trips/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/trips` | None | DEFAULT | Search available trips |
| GET | `/api/trips/[tripId]` | None | DEFAULT | Get single trip details |
| PATCH | `/api/trips/[tripId]` | COMPANY_ADMIN | DEFAULT | Update trip (own company) |
| GET | `/api/trips/[tripId]/seats` | None | DEFAULT | Get seat availability map |
| GET | `/api/trips/[tripId]/messages` | Authenticated | DEFAULT | Get trip broadcast messages |
| GET | `/api/trips/[tripId]/export-gpx` | Authenticated | DEFAULT | Export GPS trail as GPX file |

### 4.3 Booking Routes (`/api/bookings/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/api/bookings` | Auth/SMS/Guest | CREATE_BOOKING | Create new booking |
| GET | `/api/bookings` | Authenticated | DEFAULT | List own bookings |
| GET | `/api/bookings/[bookingId]` | Owner/Admin | DEFAULT | Get booking details |
| PATCH | `/api/bookings/[bookingId]` | Owner/Admin | DEFAULT | Cancel booking |

### 4.4 Payment Routes (`/api/payments/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/api/payments` | Owner/Guest | PROCESS_PAYMENT | Process payment for booking |
| POST | `/api/payments/telebirr/callback` | TeleBirr HMAC | WEBHOOK | TeleBirr payment callback |
| GET | `/api/payments/telebirr/callback` | None | DEFAULT | Callback endpoint health check |

### 4.5 Ticket Routes (`/api/tickets/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/api/tickets/verify` | COMPANY_ADMIN/SUPER_ADMIN | DEFAULT | Verify ticket by short code |
| PATCH | `/api/tickets/verify` | COMPANY_ADMIN/SUPER_ADMIN | DEFAULT | Mark ticket as used + set BOARDED |
| GET | `/api/tickets/verify/public` | None | DEFAULT | Public QR scan verification page |

### 4.6 GPS Tracking Routes (`/api/tracking/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/api/tracking/update` | Assigned driver/admin | 12/min | Send GPS position from browser |
| GET | `/api/tracking/osmand` | Token-based | 12/min | OsmAnd background GPS updates |
| POST | `/api/tracking/generate-token` | Driver/Admin | DEFAULT | Generate OsmAnd tracking token |
| GET | `/api/tracking/[tripId]` | None (public) | 30/min | Get live bus position + history |
| GET | `/api/tracking/fleet` | COMPANY_ADMIN | DEFAULT | Company fleet positions map |
| GET | `/api/tracking/active-trip` | Authenticated driver | DEFAULT | Get driver's active trip |

### 4.7 Booking Lookup Routes (`/api/track/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/track/[code]` | None (public) | DEFAULT | Look up booking by ID or ticket code |
| POST | `/api/track/scan` | Authenticated (staff) | DEFAULT | QR code scan lookup |

### 4.8 City Routes (`/api/cities/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/cities` | None | DEFAULT | List all cities |
| GET | `/api/cities/coordinates` | None | DEFAULT | Get city coordinates for maps |

### 4.9 Company Trip Management (`/api/company/trips/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/trips` | COMPANY_ADMIN | DEFAULT | List company trips (paginated) |
| POST | `/api/company/trips` | COMPANY_ADMIN | DEFAULT | Create trip |
| GET | `/api/company/trips/[tripId]` | COMPANY_ADMIN | DEFAULT | Get trip detail |
| PUT | `/api/company/trips/[tripId]` | COMPANY_ADMIN | DEFAULT | Update trip |
| DELETE | `/api/company/trips/[tripId]` | COMPANY_ADMIN | DEFAULT | Delete trip |
| POST | `/api/company/trips/[tripId]/status` | COMPANY_ADMIN | DEFAULT | Update trip status |
| GET | `/api/company/trips/[tripId]/boarding-status` | COMPANY_ADMIN | DEFAULT | Get boarding checklist |
| POST | `/api/company/trips/[tripId]/no-show` | COMPANY_ADMIN | DEFAULT | Mark passengers as no-show |
| POST | `/api/company/trips/[tripId]/replacement-ticket` | COMPANY_ADMIN | DEFAULT | Sell replacement ticket |
| GET | `/api/company/trips/[tripId]/manifest` | COMPANY_ADMIN | DEFAULT | Download passenger manifest |
| POST | `/api/company/trips/[tripId]/manual-ticket` | COMPANY_ADMIN (cashier) | DEFAULT | Manual ticket sale |
| POST | `/api/company/trips/[tripId]/toggle-booking` | COMPANY_ADMIN | DEFAULT | Halt/resume online booking |
| PATCH | `/api/company/trips/[tripId]/auto-halt-setting` | COMPANY_ADMIN | DEFAULT | Trip auto-halt override |
| POST | `/api/company/trips/[tripId]/log` | COMPANY_ADMIN | DEFAULT | Trip odometer log |
| POST | `/api/company/trips/[tripId]/alert-response` | COMPANY_ADMIN | DEFAULT | Respond to low-slot alert |
| POST | `/api/company/trips/bulk` | COMPANY_ADMIN | DEFAULT | Bulk create trips |
| POST | `/api/company/trips/batch` | COMPANY_ADMIN | DEFAULT | Batch trip operations |
| POST | `/api/company/trips/import` | COMPANY_ADMIN | DEFAULT | Import trips from CSV/Excel |
| GET | `/api/company/trips/import/template` | COMPANY_ADMIN | DEFAULT | Download import template |
| POST | `/api/company/trips/import/validate` | COMPANY_ADMIN | DEFAULT | Validate import data |

### 4.10 Trip Templates (`/api/company/trip-templates/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/trip-templates` | COMPANY_ADMIN | DEFAULT | List trip templates |
| POST | `/api/company/trip-templates` | COMPANY_ADMIN | DEFAULT | Create trip template |
| GET | `/api/company/trip-templates/[id]` | COMPANY_ADMIN | DEFAULT | Get template |
| PUT | `/api/company/trip-templates/[id]` | COMPANY_ADMIN | DEFAULT | Update template |
| DELETE | `/api/company/trip-templates/[id]` | COMPANY_ADMIN | DEFAULT | Delete template |

### 4.11 Staff Management (`/api/company/staff/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/staff` | COMPANY_ADMIN | DEFAULT | List company staff |
| POST | `/api/company/staff` | COMPANY_ADMIN | DEFAULT | Create staff member |
| GET | `/api/company/staff/[staffId]` | COMPANY_ADMIN | DEFAULT | Get staff member |
| PATCH | `/api/company/staff/[staffId]` | COMPANY_ADMIN | DEFAULT | Update staff member |
| DELETE | `/api/company/staff/[staffId]` | COMPANY_ADMIN | DEFAULT | Delete staff member |

### 4.12 Vehicle & Fleet Management (`/api/company/vehicles/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/vehicles` | COMPANY_ADMIN | DEFAULT | List vehicles |
| POST | `/api/company/vehicles` | COMPANY_ADMIN | 20/hr | Add vehicle |
| GET | `/api/company/vehicles/[vehicleId]` | COMPANY_ADMIN | DEFAULT | Get vehicle detail |
| PATCH | `/api/company/vehicles/[vehicleId]` | COMPANY_ADMIN | DEFAULT | Update vehicle |
| DELETE | `/api/company/vehicles/[vehicleId]` | COMPANY_ADMIN | DEFAULT | Delete vehicle |
| GET | `/api/company/vehicles/[vehicleId]/maintenance-schedules` | COMPANY_ADMIN | DEFAULT | List maintenance schedules |
| POST | `/api/company/vehicles/[vehicleId]/maintenance-schedules` | COMPANY_ADMIN | DEFAULT | Create maintenance schedule |
| GET | `/api/company/vehicles/[vehicleId]/maintenance-schedules/[scheduleId]` | COMPANY_ADMIN | DEFAULT | Get schedule detail |
| PATCH | `/api/company/vehicles/[vehicleId]/maintenance-schedules/[scheduleId]` | COMPANY_ADMIN | DEFAULT | Update schedule |
| DELETE | `/api/company/vehicles/[vehicleId]/maintenance-schedules/[scheduleId]` | COMPANY_ADMIN | DEFAULT | Delete schedule |
| GET | `/api/company/vehicles/[vehicleId]/work-orders` | COMPANY_ADMIN | DEFAULT | List vehicle work orders |
| POST | `/api/company/vehicles/[vehicleId]/work-orders` | COMPANY_ADMIN | DEFAULT | Create work order |
| GET | `/api/company/vehicles/[vehicleId]/inspections` | COMPANY_ADMIN | DEFAULT | List inspections |
| POST | `/api/company/vehicles/[vehicleId]/inspections` | COMPANY_ADMIN | DEFAULT | Create inspection |
| GET | `/api/company/vehicles/[vehicleId]/fuel-entries` | COMPANY_ADMIN | DEFAULT | List fuel entries |
| POST | `/api/company/vehicles/[vehicleId]/fuel-entries` | COMPANY_ADMIN | DEFAULT | Create fuel entry |

### 4.13 Work Orders (`/api/company/work-orders/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/work-orders` | COMPANY_ADMIN | DEFAULT | List all work orders |
| POST | `/api/company/work-orders` | COMPANY_ADMIN | DEFAULT | Create work order |
| GET | `/api/company/work-orders/[workOrderId]` | COMPANY_ADMIN | DEFAULT | Get work order detail |
| PATCH | `/api/company/work-orders/[workOrderId]` | COMPANY_ADMIN | DEFAULT | Update work order |
| GET | `/api/company/work-orders/[workOrderId]/messages` | COMPANY_ADMIN | DEFAULT | Work order messages |
| POST | `/api/company/work-orders/[workOrderId]/messages` | COMPANY_ADMIN | DEFAULT | Send message |
| GET | `/api/company/work-orders/[workOrderId]/parts` | COMPANY_ADMIN | DEFAULT | List parts |
| POST | `/api/company/work-orders/[workOrderId]/parts` | COMPANY_ADMIN | DEFAULT | Add part |
| PATCH | `/api/company/work-orders/[workOrderId]/parts/[partId]` | COMPANY_ADMIN | DEFAULT | Update part |
| DELETE | `/api/company/work-orders/[workOrderId]/parts/[partId]` | COMPANY_ADMIN | DEFAULT | Delete part |
| GET | `/api/company/work-orders/export` | COMPANY_ADMIN | DEFAULT | Export work orders (Excel) |

### 4.14 Fleet Analytics (`/api/company/analytics/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/analytics/fleet-health` | COMPANY_ADMIN | DEFAULT | Fleet risk scores and health gauge |
| GET | `/api/company/analytics/risk-trends` | COMPANY_ADMIN | DEFAULT | Historical risk trend data |
| GET | `/api/company/analytics/cost-forecast` | COMPANY_ADMIN | DEFAULT | Predicted maintenance costs |
| GET | `/api/company/analytics/failure-timeline` | COMPANY_ADMIN | DEFAULT | Upcoming predicted failures |
| GET | `/api/company/analytics/vehicle-comparison` | COMPANY_ADMIN | DEFAULT | Vehicle comparison metrics |
| GET | `/api/company/analytics/maintenance-windows` | COMPANY_ADMIN | DEFAULT | Optimal maintenance windows |
| GET | `/api/company/analytics/route-wear` | COMPANY_ADMIN | DEFAULT | Route-based wear analysis |
| GET | `/api/company/analytics/compliance-calendar` | COMPANY_ADMIN | DEFAULT | Compliance/inspection calendar |
| GET | `/api/company/analytics/bookings` | COMPANY_ADMIN | DEFAULT | Booking analytics |
| GET | `/api/company/analytics/passengers` | COMPANY_ADMIN | DEFAULT | Passenger analytics |
| GET | `/api/company/analytics/revenue` | COMPANY_ADMIN | DEFAULT | Revenue analytics |
| GET | `/api/company/analytics/routes` | COMPANY_ADMIN | DEFAULT | Route performance analytics |

### 4.15 Company Reports (`/api/company/reports/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/company/reports/maintenance` | COMPANY_ADMIN | DEFAULT | Maintenance cost report |
| GET | `/api/company/reports/maintenance/export` | COMPANY_ADMIN | DEFAULT | Export maintenance (Excel) |
| GET | `/api/company/reports/vehicle-tco` | COMPANY_ADMIN | DEFAULT | Total Cost of Ownership |
| GET | `/api/company/reports/downtime` | COMPANY_ADMIN | DEFAULT | Vehicle downtime report |
| GET | `/api/company/reports/fleet-analytics/export` | COMPANY_ADMIN | DEFAULT | Export fleet analytics (Excel) |
| GET | `/api/company/reports/staff-trips` | COMPANY_ADMIN | DEFAULT | Staff trip report |

### 4.16 Company Settings & Profile

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| PATCH | `/api/company/settings/auto-halt` | COMPANY_ADMIN (full) | DEFAULT | Company-wide auto-halt toggle |
| GET | `/api/company/profile` | COMPANY_ADMIN | DEFAULT | Get company profile |
| PATCH | `/api/company/profile` | COMPANY_ADMIN | DEFAULT | Update company profile |
| GET | `/api/company/stats` | COMPANY_ADMIN | DEFAULT | Dashboard statistics |
| GET | `/api/company/audit-logs` | COMPANY_ADMIN | DEFAULT | Paginated audit log |
| GET | `/api/company/audit-logs/download` | COMPANY_ADMIN | DEFAULT | Download audit log (CSV) |
| GET | `/api/company/messages` | COMPANY_ADMIN | DEFAULT | Admin-to-company messages |
| POST | `/api/company/messages` | COMPANY_ADMIN | DEFAULT | Send message |
| POST | `/api/company/messages/mark-read` | COMPANY_ADMIN | DEFAULT | Mark messages read |
| GET | `/api/company/messages/unread-count` | COMPANY_ADMIN | DEFAULT | Unread message count |

### 4.17 Super Admin Routes (`/api/admin/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/admin/stats` | SUPER_ADMIN | DEFAULT | Platform-wide statistics |
| GET | `/api/admin/bookings` | SUPER_ADMIN | DEFAULT | All bookings (paginated, filtered) |
| GET | `/api/admin/bookings/export` | SUPER_ADMIN | DEFAULT | Export bookings (CSV/Excel) |
| GET | `/api/admin/companies` | SUPER_ADMIN | DEFAULT | List companies |
| POST | `/api/admin/companies` | SUPER_ADMIN | DEFAULT | Create company |
| GET | `/api/admin/companies/[companyId]` | SUPER_ADMIN | DEFAULT | Get company detail |
| PATCH | `/api/admin/companies/[companyId]` | SUPER_ADMIN | DEFAULT | Update company |
| DELETE | `/api/admin/companies/[companyId]` | SUPER_ADMIN | DEFAULT | Delete company |
| POST | `/api/admin/companies/[companyId]/setup-staff` | SUPER_ADMIN | DEFAULT | Setup initial admin staff |
| GET | `/api/admin/trips` | SUPER_ADMIN | DEFAULT | All trips cross-company |
| GET | `/api/admin/trips/[tripId]` | SUPER_ADMIN | DEFAULT | Get any trip |
| PATCH | `/api/admin/trips/[tripId]` | SUPER_ADMIN | DEFAULT | Update any trip |
| GET | `/api/admin/manifests` | SUPER_ADMIN | DEFAULT | Cross-company manifests |
| GET | `/api/admin/platform-staff` | SUPER_ADMIN | DEFAULT | List platform staff |
| POST | `/api/admin/platform-staff` | SUPER_ADMIN | DEFAULT | Create platform staff |
| GET | `/api/admin/platform-staff/[staffId]` | SUPER_ADMIN | DEFAULT | Get platform staff |
| PATCH | `/api/admin/platform-staff/[staffId]` | SUPER_ADMIN | DEFAULT | Update platform staff |
| DELETE | `/api/admin/platform-staff/[staffId]` | SUPER_ADMIN | DEFAULT | Delete platform staff |
| GET | `/api/admin/sales-persons` | SUPER_ADMIN | DEFAULT | List sales persons |
| POST | `/api/admin/sales-persons` | SUPER_ADMIN | DEFAULT | Create sales person |
| GET | `/api/admin/sales-persons/[id]` | SUPER_ADMIN | DEFAULT | Get sales person |
| PATCH | `/api/admin/sales-persons/[id]` | SUPER_ADMIN | DEFAULT | Update sales person |
| DELETE | `/api/admin/sales-persons/[id]` | SUPER_ADMIN | DEFAULT | Delete sales person |
| POST | `/api/admin/sales-persons/[id]/payout` | SUPER_ADMIN | DEFAULT | Process commission payout |
| GET | `/api/admin/audit-logs` | SUPER_ADMIN | DEFAULT | Platform-wide audit log |
| GET | `/api/admin/audit-logs/download` | SUPER_ADMIN | DEFAULT | Download audit log (CSV) |
| GET | `/api/admin/tax-reports` | SUPER_ADMIN | DEFAULT | VAT/tax reports |
| GET | `/api/admin/company-messages` | SUPER_ADMIN | DEFAULT | Admin-to-company messages |
| POST | `/api/admin/company-messages` | SUPER_ADMIN | DEFAULT | Send message to company |
| POST | `/api/admin/company-messages/[companyId]/mark-read` | SUPER_ADMIN | DEFAULT | Mark messages read |
| GET | `/api/admin/company-messages/unread-count` | SUPER_ADMIN | DEFAULT | Unread count |
| GET | `/api/admin/reports/platform-revenue` | SUPER_ADMIN | DEFAULT | Platform revenue report |

### 4.18 Admin Analytics (`/api/admin/analytics/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/admin/analytics/revenue` | SUPER_ADMIN | DEFAULT | Revenue analytics |
| GET | `/api/admin/analytics/platform-revenue` | SUPER_ADMIN | DEFAULT | Platform revenue breakdown |
| GET | `/api/admin/analytics/monthly-trends` | SUPER_ADMIN | DEFAULT | Monthly trend data |
| GET | `/api/admin/analytics/budget-progress` | SUPER_ADMIN | DEFAULT | Budget tracking |
| GET | `/api/admin/analytics/top-companies` | SUPER_ADMIN | DEFAULT | Top companies by revenue |
| GET | `/api/admin/analytics/top-routes` | SUPER_ADMIN | DEFAULT | Top routes by bookings |
| GET | `/api/admin/analytics/sales-commissions` | SUPER_ADMIN | DEFAULT | Sales commission data |
| GET | `/api/admin/analytics/settlements` | SUPER_ADMIN | DEFAULT | Settlement analytics |

### 4.19 Cashier Portal (`/api/cashier/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/cashier/my-trips` | Cashier | DEFAULT | Cashier's assigned trips |
| GET | `/api/cashier/trip/[tripId]` | Cashier | DEFAULT | Trip details for cashier |
| POST | `/api/cashier/trip/[tripId]/sell` | Cashier | DEFAULT | Sell manual ticket (CASH) |

### 4.20 Staff Portal (`/api/staff/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/staff/my-trips` | Staff | DEFAULT | Staff's assigned trips |
| PATCH | `/api/staff/trip/[tripId]/status` | Staff | DEFAULT | Update trip status |
| GET | `/api/staff/work-orders` | Staff | DEFAULT | Staff work orders |
| GET | `/api/staff/work-orders/[workOrderId]` | Staff | DEFAULT | Work order detail |
| PATCH | `/api/staff/work-orders/[workOrderId]` | Staff | DEFAULT | Update work order |
| GET | `/api/staff/work-orders/[workOrderId]/messages` | Staff | DEFAULT | Work order messages |
| POST | `/api/staff/work-orders/[workOrderId]/messages` | Staff | DEFAULT | Send message |
| POST | `/api/staff/work-orders/[workOrderId]/field-repair` | Staff | DEFAULT | Field repair report |

### 4.21 Mechanic Portal (`/api/mechanic/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/mechanic/work-orders` | Mechanic | DEFAULT | Mechanic work orders |
| GET | `/api/mechanic/work-orders/[workOrderId]` | Mechanic | DEFAULT | Work order detail |
| PATCH | `/api/mechanic/work-orders/[workOrderId]` | Mechanic | DEFAULT | Update work order |
| GET | `/api/mechanic/work-orders/[workOrderId]/messages` | Mechanic | DEFAULT | Messages |
| POST | `/api/mechanic/work-orders/[workOrderId]/messages` | Mechanic | DEFAULT | Send message |
| GET | `/api/mechanic/work-orders/[workOrderId]/parts` | Mechanic | DEFAULT | Parts list |
| POST | `/api/mechanic/work-orders/[workOrderId]/parts` | Mechanic | DEFAULT | Add part |

### 4.22 Finance Portal (`/api/finance/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/finance/work-orders` | Finance | DEFAULT | Finance work order view |
| GET | `/api/finance/work-orders/[workOrderId]` | Finance | DEFAULT | Work order detail |
| PATCH | `/api/finance/work-orders/[workOrderId]` | Finance | DEFAULT | Approve/update costs |
| GET | `/api/finance/work-orders/[workOrderId]/messages` | Finance | DEFAULT | Messages |
| POST | `/api/finance/work-orders/[workOrderId]/messages` | Finance | DEFAULT | Send message |

### 4.23 Sales Portal (`/api/sales/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/sales/dashboard` | SALES_PERSON | DEFAULT | Dashboard statistics |
| GET | `/api/sales/commissions` | SALES_PERSON | DEFAULT | Commission history |
| GET | `/api/sales/referrals` | SALES_PERSON | DEFAULT | Referral tracking |
| GET | `/api/sales/my-team` | SALES_PERSON | DEFAULT | Recruited sub-agents |
| GET | `/api/sales/recruiter-info` | SALES_PERSON | DEFAULT | Recruiter information |
| GET | `/api/sales/qr-code` | SALES_PERSON | DEFAULT | Referral QR code |
| GET | `/api/sales/my-qr-code` | SALES_PERSON | DEFAULT | Personal QR code |
| GET | `/api/sales/profile` | SALES_PERSON | DEFAULT | Get profile |
| PATCH | `/api/sales/profile` | SALES_PERSON | DEFAULT | Update profile |
| PATCH | `/api/sales/profile/payment` | SALES_PERSON | DEFAULT | Update payment info |
| PATCH | `/api/sales/password` | SALES_PERSON | DEFAULT | Change password |

### 4.24 Support (`/api/support/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/support/tickets` | Authenticated | DEFAULT | List own support tickets |
| POST | `/api/support/tickets` | Authenticated | CREATE_TICKET | Create support ticket |
| GET | `/api/support/tickets/[ticketId]` | Owner/Admin | DEFAULT | Get ticket detail |
| PATCH | `/api/support/tickets/[ticketId]` | Owner/Admin | DEFAULT | Update ticket |

### 4.25 Notifications (`/api/notifications/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/api/notifications` | Authenticated | DEFAULT | List notifications |
| GET | `/api/notifications/count` | Authenticated | DEFAULT | Unread count |
| GET | `/api/notifications/grouped` | Authenticated | DEFAULT | Grouped notifications |
| POST | `/api/notifications/mark-all-read` | Authenticated | DEFAULT | Mark all as read |

### 4.26 Cron Jobs (`/api/cron/`)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET/POST | `/api/cron/cleanup` | CRON_SECRET | — | Expired booking/payment cleanup + trip lifecycle |
| GET | `/api/cron/trip-reminders` | CRON_SECRET | — | SMS departure reminders |
| GET | `/api/cron/predictive-maintenance` | CRON_SECRET | — | Daily AI risk snapshots |
| GET | `/api/cron/telegram-cleanup` | CRON_SECRET | — | Expired Telegram session cleanup |

### 4.27 Webhooks & External

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/api/telegram/webhook` | Telegram secret | WEBHOOK | Telegram bot updates |
| POST | `/api/sms/incoming` | SMS gateway auth | WEBHOOK | Incoming SMS handler |
| POST | `/api/sms/outgoing` | Internal | — | Outgoing SMS sender |
| POST | `/api/csp-report` | None (browser) | — | CSP violation reports |

---

## 5. Key Design Patterns

### 5.1 Company Segregation

Every company-scoped route enforces data isolation:

```
// Pattern used in every company API route
const trip = await prisma.trip.findFirst({
  where: {
    id: tripId,
    companyId: session.user.companyId  // ← Mandatory filter
  }
})
```

Company admins can only access their own company's data. Super admins can access all data. This is enforced at the query level, not middleware.

### 5.2 Transaction Safety

All financial and booking mutations use:

```
transactionWithTimeout(async (tx) => {
  // SELECT FOR UPDATE NOWAIT — row-level locking
  // 10-second timeout — prevents deadlocks
  // Automatic rollback on any failure
}, 10000)
```

### 5.3 Input Validation

Every endpoint validates input with Zod schemas before processing:

```
const schema = z.object({
  tripId: z.string().cuid(),
  passengers: z.array(passengerSchema).min(1).max(5),
})
const data = schema.parse(await request.json())
```

### 5.4 Error Response Pattern

All API errors follow consistent structure:

| Status Code | Usage | Response Body |
|-------------|-------|---------------|
| 400 | Validation error | `{ "error": "Description of validation failure" }` |
| 401 | Not authenticated | `{ "error": "Authentication required" }` |
| 403 | Insufficient role | `{ "error": "Insufficient permissions" }` |
| 404 | Resource not found | `{ "error": "Trip not found" }` |
| 409 | Conflict (booking race) | `{ "error": "Selected seats are no longer available" }` |
| 429 | Rate limited | `{ "error": "Too many requests...", "retryAfter": N }` |
| 500 | Internal error | `{ "error": "Internal server error" }` |

No internal details (stack traces, SQL errors, file paths) are ever exposed in production error responses.

### 5.5 Timezone Handling

All date comparisons use Ethiopia timezone utilities:
- `hasDepartedEthiopia()` — checks if departure time has passed (UTC+3)
- `getNowEthiopia()` — current time in Africa/Addis_Ababa
- `isTodayEthiopia()` — date comparison in local timezone

This prevents the 3-hour UTC offset on the AWS EC2 server from causing premature trip status changes.

---

## 6. Route Count Summary

| Domain | Route Files | Endpoints |
|--------|-------------|-----------|
| Authentication | 5 | 5 |
| Public Trips | 5 | 7 |
| Bookings | 3 | 4 |
| Payments | 2 | 3 |
| Tickets | 2 | 3 |
| GPS Tracking | 6 | 6 |
| Booking Lookup | 2 | 2 |
| Cities | 2 | 2 |
| Company Trips | 17 | ~25 |
| Company Templates | 2 | 5 |
| Company Staff | 2 | 5 |
| Company Vehicles | 7 | 16 |
| Company Work Orders | 6 | 11 |
| Company Analytics | 12 | 12 |
| Company Reports | 6 | 6 |
| Company Settings | 8 | 10 |
| Admin Routes | 22 | ~33 |
| Admin Analytics | 8 | 8 |
| Cashier | 3 | 3 |
| Staff | 6 | 8 |
| Mechanic | 4 | 7 |
| Finance | 3 | 5 |
| Sales | 10 | 11 |
| Support | 2 | 4 |
| Notifications | 4 | 4 |
| Cron | 4 | 4 |
| Webhooks/External | 4 | 4 |
| **Total** | **~145+** | **~210+** |

---

*End of Document 5.4.2 - Updated API Documentation*
