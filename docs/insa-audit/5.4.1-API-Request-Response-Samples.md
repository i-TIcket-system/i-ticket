# i-Ticket Platform - API Request/Response Samples

**Document**: 5.4.1 - Request/Response File
**Prepared for**: INSA Cyber Security Audit Division
**Application**: i-Ticket Online Bus Ticketing Platform
**URL**: https://i-ticket.et
**Version**: v2.14.0
**Date**: February 2026

---

## 1. User Registration

### Endpoint: `POST /api/auth/register`

**Authentication**: None (public)
**Rate Limit**: 3 requests/hour per IP

#### Successful Registration

**Request**:
```http
POST /api/auth/register HTTP/1.1
Host: i-ticket.et
Content-Type: application/json

{
  "name": "Abebe Bikila",
  "phone": "0912345678",
  "email": "abebe@example.com",
  "password": "securePassword123",
  "referralCode": "ABEL23"
}
```

**Response (201 Created)**:
```json
{
  "message": "User created successfully",
  "user": {
    "id": "clx1abc2300001234def56gh",
    "name": "Abebe Bikila",
    "phone": "0912345678"
  },
  "referred": true,
  "isSalesPerson": false
}
```

#### Failed Registration (Duplicate Phone)

**Request**: Same as above with existing phone

**Response (409 Conflict)**:
```json
{
  "error": "This phone number is already registered"
}
```

#### Failed Registration (Invalid Phone Format)

**Response (400 Bad Request)**:
```json
{
  "error": "Invalid phone number format"
}
```

#### Failed Registration (Rate Limited)

**Response (429 Too Many Requests)**:
```
HTTP/1.1 429 Too Many Requests
Retry-After: 3600

{
  "error": "Too many requests. Please try again later."
}
```

---

## 2. Trip Search

### Endpoint: `GET /api/trips`

**Authentication**: None (public)

#### Successful Search

**Request**:
```http
GET /api/trips?origin=Addis&destination=Hawassa&date=2026-02-20&page=1&limit=20&busType=STANDARD&sortBy=price HTTP/1.1
Host: i-ticket.et
```

**Response (200 OK)**:
```json
{
  "trips": [
    {
      "id": "clx1trip0100001234abc56de",
      "origin": "Addis Ababa",
      "destination": "Hawassa",
      "route": "Addis Ababa - Ziway - Hawassa",
      "intermediateStops": "Ziway,Shashemene",
      "departureTime": "2026-02-20T06:00:00.000Z",
      "estimatedDuration": 240,
      "distance": 275,
      "price": 1000,
      "busType": "STANDARD",
      "totalSlots": 45,
      "availableSlots": 32,
      "hasWater": true,
      "hasFood": false,
      "defaultPickup": "Meskel Square Bus Station",
      "defaultDropoff": "Hawassa Bus Terminal",
      "status": "SCHEDULED",
      "company": {
        "id": "clx1comp0100001234abc56de",
        "name": "Selam Bus",
        "logo": "/uploads/company-logos/selam.png"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 47,
    "pages": 3
  }
}
```

**Built-in Filters (always applied server-side)**:
- `isActive = true`, `bookingHalted = false`, `availableSlots > 0`
- Future trips only (or remaining today's trips in Ethiopia timezone)

---

## 3. Create Booking

### Endpoint: `POST /api/bookings`

**Authentication**: JWT session (registered user) OR guest checkout (phone as identity)
**Rate Limit**: 10 requests/min per IP

#### Successful Booking (Authenticated User)

**Request**:
```http
POST /api/bookings HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "tripId": "clx1trip0100001234abc56de",
  "passengers": [
    {
      "name": "Abebe Bikila",
      "nationalId": "ET-123456",
      "phone": "0912345678",
      "seatNumber": 5,
      "pickupLocation": "Meskel Square",
      "dropoffLocation": "Hawassa Bus Terminal"
    },
    {
      "name": "Sara Bekele",
      "nationalId": "ET-654321",
      "phone": "0912345679",
      "seatNumber": 6,
      "isChild": false
    }
  ],
  "selectedSeats": [5, 6],
  "totalAmount": 2120
}
```

**Response (201 Created)**:
```json
{
  "booking": {
    "id": "clx1book0100001234abc56de",
    "tripId": "clx1trip0100001234abc56de",
    "userId": "clx1user0100001234abc56de",
    "totalAmount": 2120,
    "commission": 100,
    "commissionVAT": 15,
    "status": "PENDING",
    "createdAt": "2026-02-19T10:00:00.000Z",
    "updatedAt": "2026-02-19T10:00:00.000Z",
    "passengers": [
      {
        "id": "clx1pass0100001234abc56de",
        "name": "Abebe Bikila",
        "nationalId": "ET-123456",
        "phone": "0912345678",
        "seatNumber": 5,
        "specialNeeds": null,
        "pickupLocation": "Meskel Square",
        "dropoffLocation": "Hawassa Bus Terminal",
        "boardingStatus": "PENDING"
      },
      {
        "id": "clx1pass0200001234abc56de",
        "name": "Sara Bekele",
        "nationalId": "ET-654321",
        "phone": "0912345679",
        "seatNumber": 6,
        "specialNeeds": null,
        "pickupLocation": null,
        "dropoffLocation": null,
        "boardingStatus": "PENDING"
      }
    ],
    "trip": {
      "id": "clx1trip0100001234abc56de",
      "origin": "Addis Ababa",
      "destination": "Hawassa",
      "departureTime": "2026-02-20T06:00:00.000Z",
      "price": 1000,
      "company": {
        "id": "clx1comp0100001234abc56de",
        "name": "Selam Bus"
      }
    }
  }
}
```

**Note**: `totalAmount` and `commission` are **recalculated server-side** regardless of what the client sends.

#### Failed Booking (Seat Conflict)

**Response (409 Conflict)**:
```json
{
  "error": "This trip is being booked by another user. Please try again in a moment."
}
```

#### Failed Booking (Trip Halted)

**Response (400 Bad Request)**:
```json
{
  "error": "Booking is currently halted for this trip"
}
```

---

## 4. Process Payment

### Endpoint: `POST /api/payments`

**Authentication**: JWT session (or guest via booking ownership)
**Rate Limit**: Enhanced (IP + user + per-booking: 3 attempts/hour)

#### Successful Payment (Demo Mode)

**Request**:
```http
POST /api/payments HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "bookingId": "clx1book0100001234abc56de",
  "method": "DEMO"
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "payment": {
    "id": "clx1pay00100001234abc56de",
    "bookingId": "clx1book0100001234abc56de",
    "amount": 2120,
    "method": "DEMO",
    "transactionId": "TXN-1708300000000-a1b2c3d4",
    "status": "SUCCESS",
    "createdAt": "2026-02-19T10:01:00.000Z"
  },
  "tickets": [
    {
      "id": "clx1tick0100001234abc56de",
      "bookingId": "clx1book0100001234abc56de",
      "tripId": "clx1trip0100001234abc56de",
      "passengerName": "Abebe Bikila",
      "seatNumber": 5,
      "qrCode": "data:image/png;base64,iVBORw0KGgo...",
      "shortCode": "ABC123",
      "isUsed": false,
      "createdAt": "2026-02-19T10:01:00.000Z"
    },
    {
      "id": "clx1tick0200001234abc56de",
      "bookingId": "clx1book0100001234abc56de",
      "tripId": "clx1trip0100001234abc56de",
      "passengerName": "Sara Bekele",
      "seatNumber": 6,
      "qrCode": "data:image/png;base64,iVBORw0KGgo...",
      "shortCode": "DEF456",
      "isUsed": false,
      "createdAt": "2026-02-19T10:01:00.000Z"
    }
  ]
}
```

#### Failed Payment (Expired Window)

**Response (400 Bad Request)**:
```json
{
  "error": "Payment window expired",
  "message": "This booking was created more than 10 minutes ago and has expired. Please create a new booking."
}
```

#### Failed Payment (Already Paid)

**Response (400 Bad Request)**:
```json
{
  "error": "Booking already paid"
}
```

---

## 5. TeleBirr Payment Callback

### Endpoint: `POST /api/payments/telebirr/callback`

**Authentication**: HMAC-SHA256 signature + optional IP whitelist
**Security**: 5-gate verification (hash, replay, signature, timestamp, IP)

#### Successful Callback

**Request** (from TeleBirr servers):
```http
POST /api/payments/telebirr/callback HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
X-Forwarded-For: 196.188.xxx.xxx

{
  "transactionId": "TB_20260219100200_123456",
  "outTradeNo": "clx1book0100001234abc56de",
  "status": "SUCCESS",
  "amount": "2120.00",
  "currency": "ETB",
  "timestamp": "2026-02-19T10:02:00Z",
  "signature": "a1b2c3d4e5f6..."
}
```

**Response (200 OK)**:
```json
{
  "success": true
}
```

#### Replay (Already Processed)

**Response (200 OK)** — idempotent:
```json
{
  "success": true,
  "message": "Already processed",
  "processedAt": "2026-02-19T10:02:01.000Z"
}
```

#### Invalid Signature

**Response (401 Unauthorized)**:
```json
{
  "error": "Invalid signature"
}
```

#### Unauthorized IP

**Response (403 Forbidden)**:
```json
{
  "error": "Unauthorized IP address"
}
```

---

## 6. Ticket Verification (QR Scan)

### Endpoint: `POST /api/tickets/verify`

**Authentication**: JWT session (COMPANY_ADMIN or SUPER_ADMIN)

#### Valid Ticket

**Request**:
```http
POST /api/tickets/verify HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "code": "ABC123"
}
```

**Response (200 OK)**:
```json
{
  "valid": true,
  "message": "Ticket is valid and ready for boarding",
  "ticket": {
    "id": "clx1tick0100001234abc56de",
    "shortCode": "ABC123",
    "passengerName": "Abebe Bikila",
    "seatNumber": 5,
    "qrCode": "data:image/png;base64,...",
    "createdAt": "2026-02-19T10:01:00.000Z",
    "trip": {
      "id": "clx1trip0100001234abc56de",
      "origin": "Addis Ababa",
      "destination": "Hawassa",
      "departureTime": "2026-02-20T06:00:00.000Z",
      "busType": "STANDARD",
      "company": "Selam Bus"
    },
    "booking": {
      "id": "clx1book0100001234abc56de",
      "totalAmount": 2120,
      "bookedBy": "Abebe Bikila",
      "passengerCount": 2
    }
  }
}
```

#### Already Used Ticket

**Response (200 OK)**:
```json
{
  "valid": false,
  "error": "Ticket already used on 2026-02-20T06:30:00.000Z",
  "ticket": {
    "shortCode": "ABC123",
    "passengerName": "Abebe Bikila",
    "seatNumber": 5,
    "usedAt": "2026-02-20T06:30:00.000Z"
  }
}
```

### Mark Ticket Used: `PATCH /api/tickets/verify`

**Request**:
```http
PATCH /api/tickets/verify HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "ticketId": "clx1tick0100001234abc56de"
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "message": "Ticket marked as used successfully",
  "ticket": {
    "id": "clx1tick0100001234abc56de",
    "passengerName": "Abebe Bikila",
    "seatNumber": 5,
    "shortCode": "ABC123",
    "isUsed": true,
    "usedAt": "2026-02-20T06:30:00.000Z"
  }
}
```

---

## 7. GPS Tracking Update (Driver Browser)

### Endpoint: `POST /api/tracking/update`

**Authentication**: JWT session (driver/conductor assigned to trip)
**Rate Limit**: 12 requests/min per user

#### Successful GPS Update

**Request**:
```http
POST /api/tracking/update HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "tripId": "clx1trip0100001234abc56de",
  "latitude": 7.0546,
  "longitude": 38.4955,
  "altitude": 1750.5,
  "accuracy": 15.0,
  "heading": 185.3,
  "speed": 78.5,
  "recordedAt": "2026-02-20T08:30:00.000Z"
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "estimatedArrival": "2026-02-20T10:15:00.000Z"
}
```

#### Invalid GPS Data

**Response (400 Bad Request)**:
```json
{
  "error": "Invalid GPS data",
  "details": [
    {
      "code": "too_small",
      "minimum": -90,
      "type": "number",
      "inclusive": true,
      "exact": false,
      "message": "Number must be greater than or equal to -90",
      "path": ["latitude"]
    }
  ]
}
```

---

## 8. OsmAnd Background GPS

### Endpoint: `GET /api/tracking/osmand`

**Authentication**: Trip tracking token (query parameter)
**Rate Limit**: 12 requests/min per token
**Response Format**: Plain text (not JSON)

#### Successful GPS Update

**Request** (from OsmAnd app):
```http
GET /api/tracking/osmand?token=trk_abc123def456&lat=7.0546&lon=38.4955&altitude=1750&speed=21.8&bearing=185&timestamp=1708424400 HTTP/1.1
Host: i-ticket.et
```

**Response (200 OK)**:
```
OK
```

#### Invalid Token

**Response (200 OK)** — returns 200 to prevent OsmAnd retry storms:
```
INVALID_TOKEN
```

#### Rate Limited

**Response (200 OK)**:
```
RATE_LIMITED
```

---

## 9. Mark Passengers No-Show

### Endpoint: `POST /api/company/trips/{tripId}/no-show`

**Authentication**: JWT session (COMPANY_ADMIN or SUPER_ADMIN)
**Constraint**: Trip must be DEPARTED

#### Successful No-Show Marking

**Request**:
```http
POST /api/company/trips/clx1trip0100001234abc56de/no-show HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "passengerIds": [
    "clx1pass0100001234abc56de",
    "clx1pass0200001234abc56de"
  ]
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "noShowCount": 3,
  "releasedSeats": 2,
  "markedPassengers": [
    {
      "id": "clx1pass0100001234abc56de",
      "name": "Abebe Bikila",
      "seatNumber": 5
    }
  ],
  "skippedPassengers": [
    {
      "id": "clx1pass0200001234abc56de",
      "name": "Sara Bekele",
      "reason": "Already BOARDED"
    }
  ]
}
```

#### Trip Not Departed

**Response (400 Bad Request)**:
```json
{
  "error": "No-show marking is only allowed for DEPARTED trips (current: SCHEDULED)"
}
```

---

## 10. Replacement Ticket Sale

### Endpoint: `POST /api/company/trips/{tripId}/replacement-ticket`

**Authentication**: JWT session (COMPANY_ADMIN or SUPER_ADMIN)
**Constraint**: Trip DEPARTED + released seats available

#### Successful Replacement Sale

**Request**:
```http
POST /api/company/trips/clx1trip0100001234abc56de/replacement-ticket HTTP/1.1
Host: i-ticket.et
Content-Type: application/json
Cookie: next-auth.session-token=eyJhbGc...

{
  "passengerCount": 1
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "bookingId": "clx1book0200001234abc56de",
  "seatNumbers": [5],
  "shortCodes": ["GHI789"],
  "totalAmount": 1000,
  "releasedSeats": 1,
  "companyName": "Selam Bus",
  "route": "Addis Ababa → Hawassa",
  "vehicle": {
    "plateNumber": "3-12345",
    "sideNumber": "SB-001"
  }
}
```

#### Not Enough Released Seats

**Response (400 Bad Request)**:
```json
{
  "error": "Not enough released seats. Available: 1, requested: 3"
}
```

---

## 11. Security Controls Summary

| Control | Endpoints |
|---------|-----------|
| **No Auth (Public)** | Trip search, Registration |
| **JWT Session Auth** | Bookings, Payments, Ticket verify, GPS update, No-show, Replacement |
| **Token Auth** | OsmAnd GPS |
| **HMAC-SHA256** | TeleBirr callback |
| **Rate Limiting (IP)** | Registration (3/hr), Bookings (10/min), GPS (12/min) |
| **Enhanced Rate Limiting** | Payments (IP + user + per-booking) |
| **Replay Protection** | TeleBirr callback (ProcessedCallback table) |
| **Row-Level Locking** | Bookings (SELECT FOR UPDATE NOWAIT) |
| **Transaction Timeouts** | Bookings (10s), Payments (10s), No-show (10s), Replacement (15s) |
| **Server-Side Recalculation** | Payments (amount, commission, VAT) |
| **Company Segregation** | Ticket verify, No-show, Replacement |
| **Zod Validation** | GPS update, OsmAnd, Trip search, Ticket verify |
| **Audit Logging** | All mutation endpoints -> AdminLog table |

---

*End of Document 5.4.1 - API Request/Response Samples*
