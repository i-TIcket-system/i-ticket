generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  name           String?   // Nullable for guest users (SMS)
  phone          String    @unique
  email          String?
  password       String?   // Nullable for guest users (SMS)
  nationalId     String?
  role           String    @default("CUSTOMER") // CUSTOMER, COMPANY_ADMIN, SUPER_ADMIN
  companyId      String?
  company        Company?  @relation(fields: [companyId], references: [id])

  // Staff-specific fields (for company employees)
  staffRole      String?   // ADMIN, DRIVER, CONDUCTOR, MANUAL_TICKETER (only for COMPANY_ADMIN role)
  licenseNumber  String?   // For drivers
  employeeId     String?   // Company employee ID

  nextOfKinName  String?
  nextOfKinPhone String?
  isGuestUser    Boolean   @default(false) // True for SMS users without full registration
  bookings       Booking[]

  // Sales referral (if user was referred by a sales person)
  salesReferral  SalesReferral?

  // Password reset tokens
  passwordResets PasswordReset[]

  // Reverse relations for trip staff assignments
  tripsAsDriver         Trip[] @relation("TripDriver")
  tripsAsConductor      Trip[] @relation("TripConductor")
  tripsAsManualTicketer Trip[] @relation("TripManualTicketer")

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([role])
  @@index([companyId])
  @@index([isGuestUser, createdAt])
  @@index([companyId, staffRole])
  @@index([phone, isGuestUser])  // P3-2: Optimize guest user lookups
}

model Company {
  id        String   @id @default(cuid())
  name      String
  logo      String?
  phones    String   @default("[]") // JSON array stored as string
  email     String
  isActive  Boolean  @default(true)

  // Additional contact information (optional)
  fax         String?  // Fax number
  website     String?  // Company website URL
  address     String?  // Physical address
  poBox       String?  // P.O. Box number
  tinNumber   String?  // Tax Identification Number

  // Bank information
  bankName      String?  // Bank name
  bankAccount   String?  // Bank account number
  bankBranch    String?  // Bank branch

  // Key contacts
  adminName     String?  // Company admin/manager name
  adminPhone    String?  // Company admin/manager phone
  adminEmail    String?  // Company admin/manager email
  supportName   String?  // Support contact name
  supportPhone  String?  // Support contact phone

  // Report signatures (for accounting/financial reports)
  preparedBy  String?  // Name of person who prepares reports
  reviewedBy  String?  // Name of person who reviews reports
  approvedBy  String?  // Name of person who approves reports

  users     User[]
  trips     Trip[]
  vehicles  Vehicle[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Trip {
  id                String    @id @default(cuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id])

  // Staff assignments (nullable - can be assigned later)
  driverId          String?
  driver            User?     @relation("TripDriver", fields: [driverId], references: [id], onDelete: SetNull)
  conductorId       String?
  conductor         User?     @relation("TripConductor", fields: [conductorId], references: [id], onDelete: SetNull)
  manualTicketerId  String?
  manualTicketer    User?     @relation("TripManualTicketer", fields: [manualTicketerId], references: [id], onDelete: SetNull)

  // Vehicle assignment (optional - can be assigned later)
  vehicleId         String?
  vehicle           Vehicle?  @relation("VehicleTrips", fields: [vehicleId], references: [id], onDelete: SetNull)

  origin            String
  destination       String
  route             String?
  intermediateStops String?
  departureTime     DateTime
  estimatedDuration Int      // Duration in hours
  distance          Int?     // Distance in kilometers (optional)
  price             Float
  busType           String
  totalSlots        Int
  availableSlots    Int
  hasWater          Boolean   @default(false)
  hasFood           Boolean   @default(false)
  isActive          Boolean   @default(true)
  lowSlotAlertSent         Boolean   @default(false)
  bookingHalted            Boolean   @default(false)
  adminResumedFromAutoHalt Boolean   @default(false)
  reportGenerated          Boolean   @default(false)
  version           Int       @default(0)  // P3: Optimistic locking version
  bookings          Booking[]
  tickets           Ticket[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([origin, destination, departureTime])
  @@index([version])  // P3: Index for optimistic locking queries
  @@index([departureTime])
  @@index([companyId])
  @@index([driverId])
  @@index([conductorId])
  @@index([manualTicketerId])
  @@index([vehicleId])
}

model Vehicle {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Ethiopian dual identification
  plateNumber String   // Required: Standard registration (e.g., "3-12345")
  sideNumber  String?  // Optional: Bus identifier (e.g., "Bus 7", "07")

  // Vehicle specifications
  make        String   // Manufacturer (Toyota, Isuzu, Mercedes-Benz, etc.)
  model       String   // Model name (Coaster, NPR, Sprinter, etc.)
  year        Int      // Manufacturing year
  busType     String   // MINI, STANDARD, LUXURY (matches Trip.busType)
  color       String?  // Optional: Vehicle color
  totalSeats  Int      // Total passenger capacity

  // Status and maintenance tracking
  status      String   @default("ACTIVE") // ACTIVE, MAINTENANCE, INACTIVE
  registrationExpiry DateTime? // Vehicle registration expiration date
  insuranceExpiry    DateTime? // Insurance expiration date
  lastServiceDate    DateTime? // Last maintenance/service date
  nextServiceDate    DateTime? // Scheduled next maintenance date

  // Relations
  trips       Trip[]   @relation("VehicleTrips")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Indexes for performance
  @@index([companyId])
  @@index([status])
  @@index([plateNumber])
  @@index([sideNumber])
  // Unique constraints: plate and side numbers must be unique per company
  @@unique([companyId, plateNumber])
  @@unique([companyId, sideNumber])
}

model Booking {
  id            String      @id @default(cuid())
  tripId        String
  trip          Trip        @relation(fields: [tripId], references: [id])
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  passengers    Passenger[]
  totalAmount   Float
  commission    Float
  status        String      @default("PENDING") // PENDING, PAID, CANCELLED, COMPLETED
  isQuickTicket Boolean     @default(false)
  payment       Payment?
  tickets       Ticket[]

  // Sales commission (if user was referred by a sales person)
  salesCommission SalesCommission?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([userId, status])
  @@index([tripId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([tripId, status])
}

model Passenger {
  id              String  @id @default(cuid())
  bookingId       String
  booking         Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  name            String
  nationalId      String
  phone           String
  seatNumber      Int?
  specialNeeds    String?
  pickupLocation  String?
  dropoffLocation String?

  @@index([bookingId])
}

model Ticket {
  id            String    @id @default(cuid())
  bookingId     String
  booking       Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  tripId        String
  trip          Trip      @relation(fields: [tripId], references: [id])
  passengerName String
  seatNumber    Int?
  qrCode        String
  shortCode     String    @unique
  isUsed        Boolean   @default(false)
  usedAt        DateTime?
  createdAt     DateTime  @default(now())

  @@index([tripId])
  @@index([shortCode])
  @@index([shortCode, isUsed])  // P3-2: Optimize ticket verification queries
}

model Payment {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount        Float
  method        String   // TELEBIRR, DEMO
  transactionId String?
  status        String   @default("PENDING") // PENDING, SUCCESS, FAILED, TIMEOUT
  initiatedVia  String   @default("WEB") // WEB or SMS (for analytics)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([initiatedVia, status])
  @@index([createdAt])
}

model City {
  id        String   @id @default(cuid())
  name      String   @unique
  region    String?
  isActive  Boolean  @default(true)
  tripCount Int      @default(0)
  createdAt DateTime @default(now())

  @@index([name])
}

model AdminLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  tripId    String?
  companyId String?  // For company-related audit logs (activation/deactivation)
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action])
  @@index([createdAt])
  @@index([companyId, createdAt])
}

model SmsSession {
  id              String   @id @default(cuid())
  phone           String   // User identifier (09XXXXXXXX)
  sessionId       String   @unique // Unique session ID
  state           String   // IDLE, SEARCH, SELECT_TRIP, ASK_PASSENGER_COUNT, etc.
  language        String   @default("EN") // EN or AM

  // Journey data (accumulated during conversation)
  origin          String?
  destination     String?
  date            String?
  selectedTripId  String?
  passengerCount  Int      @default(1) // Number of passengers (1-5)
  passengerData   String?  // JSON array: [{name, id}, {name, id}, ...]
  currentPassengerIndex Int @default(0) // Track which passenger we're collecting info for
  bookingId       String?

  // Session management
  lastMessageAt   DateTime @default(now())
  expiresAt       DateTime // Auto-expire after 15 min inactivity
  messageCount    Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([phone])
  @@index([sessionId])
  @@index([expiresAt])
}

model SupportTicket {
  id            String   @id @default(cuid())
  ticketNumber  String   @unique // Format: SUP-XXXXXX (6 chars)

  // Contact details
  name          String
  email         String
  phone         String?

  // Ticket details
  subject       String
  message       String   @db.Text
  category      String   @default("GENERAL") // GENERAL, TECHNICAL, BOOKING, PAYMENT, ACCOUNT, FEEDBACK
  priority      Int      @default(2) // 1=Low, 2=Medium, 3=High, 4=Urgent
  status        String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED

  // Assignment & Resolution
  assignedToId  String?  // Admin user ID
  resolvedBy    String?  // Admin user ID who resolved it
  resolution    String?  @db.Text
  resolvedAt    DateTime?

  // Scoring/Evaluation
  satisfactionScore Int?  // 1-5 rating from user
  internalNotes String?  @db.Text // Admin notes

  // Metadata
  userAgent     String?
  ipAddress     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([ticketNumber])
  @@index([status, priority])
  @@index([email])
  @@index([createdAt])
}

// ==================== SALES PERSON REFERRAL SYSTEM ====================

model SalesPerson {
  id             String    @id @default(cuid())
  name           String
  phone          String    @unique
  email          String?
  password       String    // Hashed password for login
  referralCode   String    @unique // e.g., "ABEL23" - permanent unique code
  status         String    @default("ACTIVE") // ACTIVE, INACTIVE

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastLoginAt    DateTime?

  // Relations
  qrScans        SalesQrScan[]
  referrals      SalesReferral[]
  commissions    SalesCommission[]
  payouts        SalesPayout[]

  @@index([referralCode])
  @@index([phone])
  @@index([status])
}

model SalesQrScan {
  id              String      @id @default(cuid())
  salesPersonId   String
  salesPerson     SalesPerson @relation(fields: [salesPersonId], references: [id], onDelete: Cascade)

  // Visitor fingerprint (for unique visitor tracking)
  visitorHash     String      // Hash of IP + User-Agent for deduplication

  // Device/browser info
  deviceType      String?     // MOBILE, DESKTOP, TABLET
  browser         String?     // Chrome, Safari, Firefox, etc.
  os              String?     // Android, iOS, Windows, etc.

  // Location (if available via IP geolocation)
  city            String?
  region          String?
  country         String?

  // Referrer info
  referrerUrl     String?     // Where they came from
  landingPage     String      @default("/") // Which page they landed on

  createdAt       DateTime    @default(now())

  @@index([salesPersonId, createdAt])
  @@index([visitorHash])
}

model SalesReferral {
  id              String      @id @default(cuid())
  salesPersonId   String
  salesPerson     SalesPerson @relation(fields: [salesPersonId], references: [id], onDelete: Cascade)

  userId          String      @unique // Each user can only be referred once
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Attribution metadata
  attributedAt    DateTime    @default(now()) // When the user registered with this referral

  @@index([salesPersonId])
  @@index([userId])
}

model SalesCommission {
  id                  String       @id @default(cuid())
  salesPersonId       String
  salesPerson         SalesPerson  @relation(fields: [salesPersonId], references: [id], onDelete: Cascade)

  bookingId           String       @unique
  booking             Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Commission calculation
  ticketAmount        Float        // Total ticket price
  platformCommission  Float        // Platform's 5% (stored for reference)
  salesCommission     Float        // Sales person's 5% of platform's 5% = 0.25% of ticket

  // Status tracking
  status              String       @default("PENDING") // PENDING, APPROVED, PAID

  // Payout tracking
  payoutId            String?
  payout              SalesPayout? @relation(fields: [payoutId], references: [id])
  paidAt              DateTime?

  createdAt           DateTime     @default(now())

  @@index([salesPersonId, status])
  @@index([bookingId])
  @@index([status, createdAt])
  @@index([payoutId])
}

model SalesPayout {
  id              String            @id @default(cuid())
  salesPersonId   String
  salesPerson     SalesPerson       @relation(fields: [salesPersonId], references: [id], onDelete: Cascade)

  amount          Float             // Total payout amount
  commissionCount Int               // Number of commissions included

  // Payment details
  paymentMethod   String            // TELEBIRR, CASH
  paymentRef      String?           // Transaction reference

  // Admin tracking
  processedBy     String            // Admin user ID who processed payout
  notes           String?

  createdAt       DateTime          @default(now())

  // Related commissions
  commissions     SalesCommission[]

  @@index([salesPersonId, createdAt])
}

model ProcessedCallback {
  id              String   @id @default(cuid())
  transactionId   String   @unique
  bookingId       String
  callbackHash    String   @unique
  nonce           String?
  status          String
  processedAt     DateTime @default(now())

  // Metadata for debugging
  amount          Float
  signature       String
  rawPayload      String   @db.Text

  @@index([transactionId])
  @@index([bookingId])
  @@index([callbackHash])
  @@index([processedAt])
}

model PasswordReset {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash       String   @unique  // Hashed token (bcrypt)
  expiresAt       DateTime
  isUsed          Boolean  @default(false)
  usedAt          DateTime?

  createdAt       DateTime @default(now())

  @@index([userId, isUsed])
  @@index([tokenHash, isUsed])
  @@index([expiresAt])
}

// ==================== TRIP-BASED MESSAGING SYSTEM ====================

model TripMessage {
  id              String   @id @default(cuid())
  tripId          String   // Messages are scoped to specific trips

  // Sender info
  senderId        String
  senderName      String   // Denormalized for display
  senderRole      String   // ADMIN, DRIVER, CONDUCTOR, MANUAL_TICKETER, MAINTENANCE

  // Message content
  message         String   @db.Text
  type            String   @default("CHAT") // CHAT, ALERT, UPDATE, SYSTEM

  // Metadata
  isEdited        Boolean  @default(false)
  editedAt        DateTime?

  createdAt       DateTime @default(now())

  // Read receipts
  readReceipts    TripMessageReadReceipt[]

  @@index([tripId, createdAt])
  @@index([senderId])
}

model TripMessageReadReceipt {
  id              String      @id @default(cuid())
  messageId       String
  message         TripMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  userId          String      // Staff member who read the message
  readAt          DateTime    @default(now())

  @@unique([messageId, userId]) // Each user can only read a message once
  @@index([messageId])
  @@index([userId, readAt])
}

// ==================== NOTIFICATION SYSTEM ====================

model Notification {
  id              String    @id @default(cuid())

  // Recipient info
  recipientId     String    // User ID or SalesPerson ID
  recipientType   String    // "USER" | "SALES_PERSON"

  // Notification content
  type            String    // TRIP_ASSIGNMENT, TRIP_MESSAGE, BOOKING_NEW, BOOKING_PAID,
                            // BOOKING_CANCELLED, SYSTEM_ALERT, COMMISSION_EARNED,
                            // REFERRAL_NEW, TRIP_HALTED, TRIP_RESUMED, LOW_SLOTS
  title           String
  message         String    @db.Text

  // Related entities (nullable - for deep linking)
  tripId          String?
  bookingId       String?
  companyId       String?

  // Metadata for rendering (JSON)
  metadata        String?   @db.Text // JSON: {route, amount, seatNumbers, etc.}

  // Status tracking
  isRead          Boolean   @default(false)
  readAt          DateTime?

  // Priority for display ordering (1=Low, 2=Normal, 3=High, 4=Urgent)
  priority        Int       @default(2)

  createdAt       DateTime  @default(now())
  expiresAt       DateTime? // Optional expiration for time-sensitive notifications

  @@index([recipientId, recipientType, isRead])
  @@index([recipientId, recipientType, createdAt])
  @@index([type, createdAt])
  @@index([tripId])
  @@index([bookingId])
  @@index([createdAt])
}
